!function(t){"use strict";var a=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}),o=function(){},l=function(){},n=null,s=null,r=!1,e={getFullHeight:function(){return parseInt(document.body.clientHeight)+57+8},launchToast:function(e,t){a.fire({icon:e,title:t})},showPrompt:function(e,t,a,i){var n=$("#modal_prompt");n.find(".modal-title").text(e),n.find(".prompt-label").text(t),i?n.find(".prompt-input").val(i):n.find(".prompt-input").val(""),o=a,n.modal()},closePrompt:function(e){var t,a=$("#modal_prompt");e?void 0!==(t=o(e,a.find(".prompt-input").val()))&&!t||a.modal("hide"):o(e,a.find(".prompt-input").val())},hidePrompt:function(e){void 0!==e?this.closePrompt(e):$("#modal_prompt").modal("hide")},showConfirm:function(e,t,a,i){var n=$("#modal_confirm");n.find(".modal-title").text(e),n.find(".modal-body").html("<p>"+t+"</p>"),n.find(".btn-primary").text(i||"确定"),l=a,n.modal()},closeConfirm:function(e){l(e)},hideConfirm:function(e){this.closeConfirm()},showAlert:function(e,t,a){var i=$("#modal_alert");i.find(".modal-body").html("<p>"+e+"</p>"),a?i.find("button.btn-default").text(a):i.find("button.btn-default").text("确定"),n=void 0===t?null:t,i.modal()},closeAlert:function(){null!=n&&n(),$("#modal_alert").modal("hide")},hideAlert:function(){this.closeAlert()},showLoading:function(e,t){if(!r){r=!0,void 0===t&&(t=8e3);var a=0,i=0;null==s&&(s=$("#modal_loading")).on("hidden.bs.modal",function(){0!=a&&clearInterval(a),0!=i&&clearTimeout(i),r=!1});var n=s;n.find(".modal-title").html(e+"&hellip;");var o=n.find(".modal-elapsed-time");o.text("0 秒");var l=0,a=setInterval(function(){++l,o.text(l+" 秒")},1e3);return n.modal({keyboard:!1,backdrop:"static"}),i=setTimeout(function(){clearInterval(a),a=0,clearTimeout(i),i=0,n.modal("hide")},t),n}},hideLoading:function(){(null!=s?s:$("#modal_loading")).modal("hide")},showImage:function(e){t.cube().fileStorage.getFileURL(e,function(e,t,a){!function(e){var t=new Image;t.src=e;var a=new Viewer(t,{hidden:function(){a.destroy()}});a.show()}(t)})},downloadFile:function(e){t.cube().fileStorage.downloadFile(e)}};t.dialog=e,t.Toast={Success:"success",Info:"info",Error:"error",Warning:"warning",Question:"question"}}(window),function(i){"use strict";function e(e){n=e}var n=null;e.prototype.open=function(e,t){var a;n.find('h3[data-target="file-name"]').text(e.getFileName()),n.find('h5[data-target="file-type"]').text(e.getFileType().toUpperCase()),n.find('h5[data-target="file-size"]').text(i.formatSize(e.getFileSize())),n.find('h5[data-target="file-date"]').text(i.formatYMDHMS(e.getLastModified())),t?(i.recurseParent(e=[],t),a=[],1==e.length?a.push("/"):e.forEach(function(e){e.isRoot()||a.push(e.getName()+" &gt; ")}),n.find('h5[data-target="file-path"]').html(a.join(""))):n.find('h5[data-target="file-path"]').text("--"),n.modal("show")},e.prototype.close=function(){n.modal("hide")},i.FileDetails=e}(window),function(e){"use strict";function t(e){this.el=e;var t=this;this.el.find('a[data-target="name"]').on("click",function(){t.showDetail()})}t.prototype.updateAvatar=function(e){this.el.find('img[data-target="avatar"]').attr("src",e)},t.prototype.updateName=function(e){this.el.find('a[data-target="name"]').text(e)},t.prototype.showDetail=function(){},e.SidebarAccountPanel=t}(window),function(a){"use strict";function e(e){this.el=e,this.items=[],this.lastItem=null}e.prototype.getActiveItem=function(){return this.lastItem},e.prototype.getItem=function(e){for(var t=parseInt(e),a=0;a<this.items.length;++a){var i=this.items[a];if(i.id==t)return i}return null},e.prototype.appendItem=function(e){var t=this.items.length,a=0,i=null,n="images/group-avatar.png",o=null,l=null,s=null,r=0;if(e instanceof Group?(a=e.getId(),o=e.getName(),l=" ",s=formatShortTime(e.getLastActiveTime()),r=e.getLastActiveTime()):e instanceof Contact?(a=e.getId(),n=e.getContext().avatar,o=e.getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():e.getContext().name,l=" ",s=""):"object"==typeof e&&(a=e.id,n=e.avatar,o=e.name,l=" ",s=""),null==o||null==o)return!1;e=this.getItem(a);if(null!=e)return!1;this.items.push(e={index:t,id:a,el:i,thumb:n,label:o,desc:l,lastDesc:"",timeBadge:s,time:r});i=$(['<li id="mc_item_',t,'" class="item pl-2 pr-2" data="',a,'">','<div class="product-img"><img class="img-size-50 img-round-rect" src="',n,'"/>','<span class="badge badge-danger unread-badge"></span>',"</div>",'<div class="product-info ellipsis">','<span class="product-title ellipsis">','<span class="title">',o,"</span>",'<span class="badge badge-light float-right last-time">',s,"</span>","</span>",'<span class="product-description">',l,"</span>","</div>","</li>"].join(""));return e.el=i,this.el.append(i),this.bindEvent(i),!0},e.prototype.removeItem=function(e){for(var t=0,t=e instanceof Group||e instanceof Contact?e.getId():parseInt(e),a=null,i=0;i<this.items.length;++i){var n=this.items[i];if(n.id==t){a=n,this.items.splice(i,1);break}}null!=a&&a.el.remove()},e.prototype.updateItem=function(e,t,a,i){var n=0;if("number"==typeof e)n=e;else if(e instanceof Contact)n=e.getId();else{if(!(e instanceof Group))return console.log("[App] MessageCatalogue#updateItem 输入参数错误"),!1;n=e.getId()}var o=this.getItem(n);if(null==o){if(!this.appendItem(e))return!1;o=this.getItem(n)}e=o.el;if(null!=t){if(o.lastDesc=o.desc,"string"==typeof t)o.desc=t;else if(t instanceof TextMessage)o.desc=t.getSummary();else if(t instanceof ImageMessage)o.desc=t.getSummary();else if(t instanceof FileMessage){n=t;n.hasAttachment()?o.desc=n.getSummary():o.desc="[文件]"}else if(t instanceof CallRecordMessage)t.getConstraint().video?o.desc="[视频通话]":o.desc="[语音通话]";else{if(!(t instanceof File))return!1;o.desc="[文件] "+t.name}e.find(".product-description").text(o.desc)}return null!=a&&(o.time=a,e.find(".last-time").text(formatShortTime(a))),i&&(o.label=i,e.find(".title").text(i)),e.remove(),this.el.prepend(e),this.bindEvent(e),!0},e.prototype.restoreLastDesc=function(e){var t=0;if("number"==typeof e)t=e;else if(e instanceof Contact)t=e.getId();else{if(!(e instanceof Group))return void console.log("[App] MessageCatalogue#restoreLastDesc 输入参数错误");t=e.getId()}t=this.getItem(t);null!=t&&(t.el.find(".product-description").text(t.lastDesc),t.desc=t.lastDesc,t.lastDesc="")},e.prototype.updateBadge=function(e,t){e=this.getItem(e);null!=e&&(0==t?e.el.find(".unread-badge").text(""):99<t?e.el.find(".unread-badge").text("99+"):e.el.find(".unread-badge").text(t))},e.prototype.refreshOrder=function(){this.items.sort(function(e,t){return t.time-e.time}),this.el.empty();var t=this;this.items.forEach(function(e){t.el.append(e.el),t.bindEvent(e.el)})},e.prototype.activeItem=function(e){if(null!=this.lastItem){if(this.lastItem.id==e)return;this.lastItem.el.removeClass("catalog-active")}e=this.getItem(e);e.el.addClass("catalog-active"),this.lastItem=e},e.prototype.onItemClick=function(e){if(null!=this.lastItem){if(this.lastItem.id==e)return;this.lastItem.el.removeClass("catalog-active")}e=this.getItem(e);e.el.addClass("catalog-active"),this.lastItem=e,a.app.messagingCtrl.toggle(this.lastItem.id)},e.prototype.onItemDoubleClick=function(e){var t=a.app.queryGroup(e);t instanceof Group?a.app.groupDetails.show(t):(t=a.app.queryContact(e))instanceof Contact&&a.app.contactDetails.show(t)},e.prototype.bindEvent=function(e){var a=this;e.on("click",function(e){var t=parseInt($(this).attr("data"));a.onItemClick(t)}),e.on("dblclick",function(e){var t=parseInt($(this).attr("data"));a.onItemDoubleClick(t)})},a.MessageCatalogue=e}(window),function(p){"use strict";var i=null;function e(e){this.el=e,this.panels={},(i=this).current=null,this.elTitle=this.el.find(".card-title"),this.elContent=this.el.find(".card-body"),this.inputEditor=null,this.elInput=null,$("#message-editor").parent().remove(),this.elInput=this.el.find("textarea"),this.elInput.parent().css("display","flex"),this.elInput.val(""),this.elInput[0].hasAttribute("disabled")||this.elInput.attr("disabled","disabled"),this.elInput.keypress(function(e){e=e||window.event;e&&13==e.keyCode&&e.ctrlKey&&i.onSend(e)}),this.btnSend=e.find('button[data-target="send"]'),this.btnSend.attr("disabled","disabled"),this.btnSend.on("click",function(e){i.onSend(e)}),this.btnSendFile=e.find('button[data-target="send-file"]'),this.btnSendFile.attr("disabled","disabled"),this.btnSendFile.on("click",function(e){p.app.messagingCtrl.selectFile($("#select_file"))}),this.btnVideoCall=e.find('button[data-target="video-call"]'),this.btnVideoCall.attr("disabled","disabled"),this.btnVideoCall.on("click",function(){p.app.messagingCtrl.openVideoChat(i.current.entity)}),this.btnVoiceCall=e.find('button[data-target="voice-call"]'),this.btnVoiceCall.attr("disabled","disabled"),this.btnVoiceCall.on("click",function(){p.app.messagingCtrl.openVoiceCall(i.current.entity)}),e.find('button[data-target="details"]').on("click",function(e){i.onDetailsClick(e)}),this.btnNewGroup=e.find('button[data-target="new-group"]'),this.btnNewGroup.on("click",function(e){p.app.newGroupDialog.show()}),this.initContextMenu()}e.prototype.initContextMenu=function(){this.elContent.contextMenu({selector:".direct-chat-text",callback:function(e,t){var a=i.current.entity;"delete"==e?p.app.messagingCtrl.deleteMessage(a,parseInt($(this).attr("data-id"))):"recall"==e&&p.app.messagingCtrl.recallMessage(a,parseInt($(this).attr("data-id")))},items:{recall:{name:"撤回",disabled:function(e,t){return"false"==$(this).attr("data-owner")}},delete:{name:"删除",disabled:function(e,t){return!1}}}})},e.prototype.getCurrentPanel=function(){return this.current},e.prototype.getPanel=function(e){return this.panels[e.toString()]},e.prototype.updatePanel=function(e,t){var a=this.panels[e.toString()];void 0===a&&(a={id:e,el:$('<div class="direct-chat-messages"></div>'),entity:t,messageIds:[],unreadCount:0,groupable:t instanceof Group},this.panels[e.toString()]=a),null!=this.current&&this.current.id==e&&(a.groupable?this.elTitle.text(t.getName()):this.elTitle.text(t.getPriorityName()))},e.prototype.changePanel=function(e,t){var a=this.panels[e.toString()];void 0===a&&(a={id:e,el:$('<div class="direct-chat-messages"></div>'),entity:t,messageIds:[],unreadCount:0,groupable:t instanceof Group},this.panels[e.toString()]=a),null==this.current?(this.elInput.removeAttr("disabled"),this.btnSend.removeAttr("disabled"),this.btnSendFile.removeAttr("disabled")):(0<(e=this.elInput.val().trim()).length?window.cube().messaging.saveDraft(this.current.entity,new TextMessage(e))&&p.app.messageCatalog.updateItem(this.current.id,"[草稿] "+e,null,null):window.cube().messaging.deleteDraft(this.current.id),this.elInput.val(""),this.current.el.remove()),this.elContent.append(a.el),(this.current=a).unreadCount=0,a.groupable?(this.btnVideoCall[0].hasAttribute("disabled")||this.btnVideoCall.attr("disabled","disabled"),this.btnVoiceCall[0].hasAttribute("disabled")||this.btnVoiceCall.attr("disabled","disabled"),this.elTitle.text(t.getName())):(this.btnVideoCall.removeAttr("disabled"),this.btnVoiceCall.removeAttr("disabled"),this.elTitle.text(t.getAppendix().hasRemarkName()?t.getAppendix().getRemarkName():t.getName()));t=parseInt(this.elContent.prop("scrollHeight"));this.elContent.scrollTop(t),a.messageIds.forEach(function(e){window.cube().messaging.markRead(e)}),window.cube().messaging.loadDraft(this.current.id,function(e){p.app.messageCatalog.restoreLastDesc(a.id),i.elInput.val(e.getMessage().getText())})},e.prototype.clearPanel=function(e){var t=this.panels[e.toString()];null!=t&&(t.el.remove(),this.current==t&&(this.current=null),delete this.panels[e.toString()]),this.btnVideoCall.attr("disabled","disabled"),this.btnVoiceCall.attr("disabled","disabled"),this.btnSendFile.attr("disabled","disabled"),this.elTitle.text("")},e.prototype.removeMessage=function(e,t){var a=e.getId(),e=this.panels[a.toString()];void 0!==e&&(a=t.getId(),0<=(t=e.messageIds.indexOf(a))&&e.messageIds.splice(t,1),e.el.find("#"+a).remove())},e.prototype.appendMessage=function(e,t,a){var i=e.getId(),n=this.panels[i.toString()];void 0===n&&(n={id:i,el:$('<div class="direct-chat-messages"></div>'),entity:e,messageIds:[],unreadCount:0,groupable:e instanceof Group},this.panels[i.toString()]=n);var o=a.getId(),l=a.getRemoteTimestamp();if(!(0<=n.messageIds.indexOf(o))){n.messageIds.push(o),a.isRead()||(n.unreadCount+=1);var s="",r="float-left",c="float-right";t.getId()==p.app.getSelf().getId()&&(s="right",r="float-right",c="float-left");var d=null,e=null;if(a instanceof TextMessage)d=a.getText();else if(a instanceof ImageMessage||a instanceof FileMessage)e=a.getAttachment();else{if(!(a instanceof CallRecordMessage))return;d=(d=["<div>",a.getConstraint().video?'<i class="fas fa-video"></i>':'<i class="fas fa-phone"></i>','&nbsp;&nbsp;<span style="font-size:14px;">',0<a.getAnswerTime()?"通话时长 "+p.formatClockTick(parseInt(a.getDuration()/1e3)):a.isCaller(p.app.getSelf().getId())?"对方未接听":"未接听","</span></div>"]).join("")}null!=e&&(i=null,d=(e.isImageType()?(i=["javascript:dialog.showImage('",e.getFileCode(),"');"],['<table class="file-label" border="0" cellspacing="4" cellpodding="0">',"<tr>","<td>",'<img class="thumb" src="',e.getDefaultThumbURL(),'" onclick="',i.join(""),'" ','alt="',e.getFileName(),'"'," />","</td>","</tr>","</table>"]):(i=['<a class="btn btn-xs btn-default" title="下载文件" href="javascript:dialog.downloadFile(\'',e.getFileCode(),"');\">",'<i class="fas fa-download"></i>',"</a>"],['<table class="file-label" border="0" cellspacing="4" cellpodding="0">',"<tr>",'<td rowspan="2" valign="middle" align="center">',"png"==(a=e.getFileType())||"jpeg"==a||"gif"==a||"jpg"==a||"bmp"==a?'<i class="file-icon ci-wide ci-file-image-wide"></i>':"xls"==a||"xlsx"==a?'<i class="file-icon ci-wide ci-file-excel-wide"></i>':"ppt"==a||"pptx"==a?'<i class="file-icon ci-wide ci-file-powerpoint-wide"></i>':"doc"==a||"docx"==a?'<i class="file-icon ci-wide ci-file-word-wide"></i>':"mp3"==a||"ogg"==a||"wav"==a?'<i class="file-icon ci-wide ci-file-music-wide"></i>':"pdf"==a?'<i class="file-icon ci-wide ci-file-pdf-wide"></i>':"rar"==a?'<i class="file-icon ci-wide ci-file-rar-wide"></i>':"zip"==a||"gz"==a?'<i class="file-icon ci-wide ci-file-zip-wide"></i>':"txt"==a||"log"==a?'<i class="file-icon ci-wide ci-file-text-wide"></i>':"mp4"==a||"mkv"==a||"avi"==a||"ts"==a?'<i class="file-icon ci-wide ci-file-video-wide"></i>':"psd"==a?'<i class="file-icon ci-wide ci-file-psd-wide"></i>':"exe"==a||"dll"==a?'<i class="file-icon ci-wide ci-file-windows-wide"></i>':"apk"==a?'<i class="file-icon ci-wide ci-file-apk-wide"></i>':"dmg"==a?'<i class="file-icon ci-wide ci-file-dmg-wide"></i>':'<i class="file-icon ci-wide ci-file-unknown-wide"></i>',"</td>",'<td colspan="2" class="file-name">',e.getFileName(),"</td>","</tr>","<tr>",'<td class="file-size">',formatSize(e.getFileSize()),"</td>",'<td class="file-action">',i.join(""),"</td>","</tr>","</table>"])).join(""));d=['<div id="',o,'" class="direct-chat-msg ',s,'"><div class="direct-chat-infos clearfix">','<span class="direct-chat-name ',r,n.groupable?"":" no-display",'">',t.getPriorityName(),'</span><span class="direct-chat-timestamp ',c,'">',formatFullTime(l),"</span></div>",'<img src="',t.getContext().avatar,'" class="direct-chat-img">','<div data-id="',o,'" data-owner="',0<s.length,'" class="direct-chat-text">',d,"</div></div>"];n.el.append($(d.join("")));d=parseInt(this.elContent.prop("scrollHeight"));this.elContent.scrollTop(d)}},e.prototype.appendNote=function(e,t){var a=e.getId(),i=this.panels[a.toString()];void 0===i&&(i={id:a,el:$('<div class="direct-chat-messages"></div>'),entity:e,messageIds:[],groupable:e instanceof Group},this.panels[a.toString()]=i),i.el.append($(['<div class="note">',t,"</div>"].join("")));t=parseInt(this.elContent.prop("scrollHeight"));this.elContent.scrollTop(t)},e.prototype.onSend=function(e){var t=this.elInput.val();0!=t.length&&(this.elInput.val(""),null==p.app.messagingCtrl.fireSend(this.current.entity,t)&&p.dialog.launchToast(Toast.Error,"发送消息失败"))},e.prototype.onDetailsClick=function(e){var t;null!=this.current&&(t=this.current.entity,(this.current.groupable?p.app.groupDetails:p.app.contactDetails).show(t))},p.MessagePanel=e}(window),function(n){"use strict";var i=null,o=null,t=null,a=null,l=null,s=null,r=null,c=null;function d(){var e;s.prop("disabled")?(t=s.val().trim(),s.removeAttr("disabled"),s.focus()):(e=s.val().trim(),s.attr("disabled","disabled"),t!=e&&window.cube().contact.remarkGroup(o,e,function(){dialog.launchToast(Toast.Success,"已备注群组")},function(e){dialog.launchToast(Toast.Error,"修改群组备注失败："+e.code),s.val(t)}))}function p(){d()}function u(){var e;r.prop("disabled")?(a=r.val().trim(),r.removeAttr("disabled"),r.focus()):(e=r.val().trim(),r.attr("disabled","disabled"),a!=e&&o.getAppendix().updateNotice(e,function(){dialog.launchToast(Toast.Success,"已修改群组公告")},function(e){dialog.launchToast(Toast.Error,"修改群组公告失败："+e.code),r.val(a)}))}function g(){u()}function f(e){13==e.keyCode&&h($(this))}function m(e){h($(this))}function h(e){var t=e.val(),a=e.attr("predata"),i=e.attr("data-target");t==a||t.length<3?n.app.messageSidebar.recoverMemberName(i,e.parent(),a):(o.getAppendix().updateMemberRemark(i,t,function(){dialog.launchToast(Toast.Success,"已修改群组成员备注")},function(e){dialog.launchToast(Toast.Error,"备注群组成员失败："+e.code)}),n.app.messageSidebar.recoverMemberName(i,e.parent(),t))}function e(e){i=this,(l=e).find(".image-file-list"),(s=l.find('input[data-target="group-remark"]')).attr("disabled","disabled"),s.blur(p),l.find('button[data-target="remark"]').click(d),(r=l.find('textarea[data-target="group-notice"]')).attr("disabled","disabled"),r.blur(g),l.find('button[data-target="notice"]').click(u),c=l.find(".group-member-list")}e.prototype.update=function(a){o=a,l.find('input[data-target="group-name"]').val(a.getName()),o.isOwner()?l.find(".group-notice-btn-group").css("display","block"):l.find(".group-notice-btn-group").css("display","none"),window.cube().contact.getAppendix(a,function(e){s.val(e.getRemark()),r.val(e.getNotice())},function(e){console.log(e.toString())}),c.empty(),a.getMembers().forEach(function(e){n.app.getContact(e.getId(),function(e){var t=['<button class="btn btn-sm btn-default btn-flat"',' onclick="javascript:app.messageSidebar.fireUpdateMemberRemark(',e.getId(),');"><i class="fas fa-edit"></i></button>'],t=['<div class="group-member-cell" data-target="',e.getId(),'" ondblclick="javascript:app.messagingCtrl.toggle(',e.getId(),');">','<div class="member-avatar"><img class="img-size-32 img-round-rect" src="',e.getContext().avatar,'" /></div>','<div class="member-name">',a.getAppendix().hasMemberRemark(e)?a.getAppendix().getMemberRemark(e):e.getPriorityName(),"</div>",'<div class="member-operate">',a.isOwner()||e.getId()==n.app.account.id?t.join(""):"","</div>","</div>"];c.append($(t.join("")))})}),window.cube().fs.getRoot(a,function(e){e.searchFile({type:["jpg","png","gif","bmp"],begin:0,end:20,inverseOrder:!0},function(e,t){t.forEach(function(e){i.appendImage(e.file)})},function(e){console.log("MessageSidebar #searchFile() : "+e.code)})},function(e){console.log("MessageSidebar #getRoot() : "+e.code)})},e.prototype.appendImage=function(e){},e.prototype.fireUpdateMemberRemark=function(e){var t=l.find('div[data-target="'+e+'"]');t.find("button").attr("disabled","disabled");var a=parseInt(t.width()),i=(t=t.find(".member-name")).text();t.empty(),t.html(['<input class="form-control form-control-sm" type="text" style="width:',a-=100,'px;" predata="',i,'" data-target="',e,'" />'].join(""));t=t.find("input");t.blur(m),t.keyup(f),t.focus()},e.prototype.recoverMemberName=function(e,t,a){t.empty(),t.text(a),l.find('div[data-target="'+e+'"]').find(".member-operate").find("button").removeAttr("disabled")},n.MessageSidebar=e}(window),function(t){"use strict";function e(e){(a=this).el=e,this.elPeerAvatar=e.find('img[data-target="avatar"]'),this.elPeerName=e.find('span[data-target="name"]'),this.elInfo=e.find('span[data-target="info"]'),this.remoteVideo=e.find('video[data-target="remote"]')[0],this.localVideo=e.find('video[data-target="local"]')[0],this.btnMic=e.find('button[data-target="microphone"]'),this.btnMic.attr("disabled","disabled"),this.btnMic.on("click",function(){t.app.callCtrl.toggleMicrophone()?(a.btnMic.empty(),a.btnMic.append($('<i class="ci ci-btn ci-microphone-opened"></i>'))):(a.btnMic.empty(),a.btnMic.append($('<i class="ci ci-btn ci-microphone-closed"></i>')))}),this.btnVol=e.find('button[data-target="volume"]'),this.btnVol.attr("disabled","disabled"),this.btnVol.on("click",function(){t.app.callCtrl.toggleLoudspeaker()?(a.btnVol.empty(),a.btnVol.append($('<i class="ci ci-btn ci-volume-unmuted"></i>'))):(a.btnVol.empty(),a.btnVol.append($('<i class="ci ci-btn ci-volume-muted"></i>')))}),this.btnHangup=e.find('button[data-target="hangup"]'),this.btnHangup.on("click",function(){a.terminate()}),e.draggable({handle:".modal-header"}),e.on("hide.bs.modal",function(){0<i&&(clearInterval(i),i=0),0<n&&(clearTimeout(n),n=0),o=0,a.btnMic.attr("disabled","disabled"),a.btnVol.attr("disabled","disabled")})}var a=null,i=0,n=0,o=0;e.prototype.showMakeCall=function(e){console.log("发起语音通话 "+e.getId()),t.app.callCtrl.makeCall(e,!1)?(this.elPeerAvatar.attr("src",e.getContext().avatar),this.elPeerName.text(e.getName()),this.elInfo.text("正在呼叫..."),this.el.modal({keyboard:!1,backdrop:!1})):t.dialog.launchToast(Toast.Warning,"您当前正在通话中")},e.prototype.showAnswerCall=function(e){console.log("应答语音通话 "+e.getId()),this.elPeerAvatar.attr("src",e.getContext().avatar),this.elPeerName.text(e.getName()),this.elInfo.text("正在应答..."),this.el.modal({keyboard:!1,backdrop:!1})},e.prototype.close=function(){this.el.modal("hide")},e.prototype.tipWaitForAnswer=function(e){var t;0<i||(t=0,i=setInterval(function(){a.elInfo.text("等待应答，已等待 "+ ++t+" 秒...")},1e3))},e.prototype.tipConnected=function(){0<i&&(clearInterval(i),i=0),0<n||(this.btnMic.removeAttr("disabled"),this.btnVol.removeAttr("disabled"),n=setInterval(function(){a.elInfo.text(t.formatClockTick(++o))},1e3))},e.prototype.openNewCallToast=function(e){e=['<div class="toasts-info">                <div class="info-box">                    <span class="info-box-icon"><img src="',e.getContext().avatar,'" /></span>                    <div class="info-box-content">                        <span class="info-box-text">',e.getName(),'</span>                        <span class="info-box-desc">邀请您参与语音通话</span>                    </div>                </div>                <div class="call-answer">                    <button type="button" class="btn btn-danger" onclick="javascript:app.callCtrl.hangupCall();"><i class="ci ci-hangup"></i> 拒绝</button>                    <button type="button" class="btn btn-success" onclick="javascript:app.callCtrl.answerCall();"><i class="ci ci-answer"></i> 接听</button>                </div>            </div>'];$(document).Toasts("create",{title:"语音通话邀请",position:"bottomRight",icon:"fas fa-phone",close:!1,class:"voice-new-call",body:e.join("")})},e.prototype.closeNewCallToast=function(){$("#toastsContainerBottomRight").find(".voice-new-call").remove()},e.prototype.terminate=function(){t.app.callCtrl.hangupCall()},t.VoiceCallPanel=e}(window),function(o){"use strict";function e(e){this.el=e,i=this,window.addEventListener("resize",this.onResize,!1),(n=e.find('button[data-target="minimize"]')).on("click",function(){i.minimize()}),(l=e.find('button[data-target="maximize"]')).on("click",function(){i.maximize()}),(s=e.find('button[data-target="restore"]')).on("click",function(){i.restore()}),s.css("display","none"),u=e.find('div[data-target="video-remote"]'),g=e.find('div[data-target="video-local"]'),u.on("click",function(e){b==h&&i.switchVideo()}),g.on("click",function(e){b==m&&i.switchVideo()}),a=g,m=(f=u)[0].querySelector("video"),h=g[0].querySelector("video"),(b=m).style.visibility="hidden",this.remoteVideo=m,this.localVideo=h,this.headerTip=e.find(".header-tip"),this.callTip=e.find(".call-tip"),this.elRemoteLabel=u.find(".video-label"),this.elLocalLabel=g.find(".video-label"),this.btnCam=e.find('button[data-target="camera"]'),this.btnMic=e.find('button[data-target="microphone"]'),this.btnVol=e.find('button[data-target="volume"]'),this.btnCam.attr("disabled","disabled"),this.btnMic.attr("disabled","disabled"),this.btnVol.attr("disabled","disabled"),this.btnCam.on("click",function(){o.app.callCtrl.toggleCamera()?(i.btnCam.empty(),i.btnCam.append($('<i class="ci ci-btn ci-camera-opened"></i>'))):(i.btnCam.empty(),i.btnCam.append($('<i class="ci ci-btn ci-camera-closed"></i>')))}),this.btnMic.on("click",function(){o.app.callCtrl.toggleMicrophone()?(i.btnMic.empty(),i.btnMic.append($('<i class="ci ci-btn ci-microphone-opened"></i>'))):(i.btnMic.empty(),i.btnMic.append($('<i class="ci ci-btn ci-microphone-closed"></i>')))}),this.btnVol.on("click",function(){o.app.callCtrl.toggleLoudspeaker()?(i.btnVol.empty(),i.btnVol.append($('<i class="ci ci-btn ci-volume-unmuted"></i>'))):(i.btnVol.empty(),i.btnVol.append($('<i class="ci ci-btn ci-volume-muted"></i>')))}),this.btnHangup=e.find('button[data-target="hangup"]'),this.btnHangup.on("click",function(){i.terminate()}),e.draggable({handle:".modal-header",containment:"document"}),e.on("hide.bs.modal",function(){0<v&&(clearInterval(v),v=0),0<t&&(clearInterval(t),t=0),C=0,m.style.visibility="hidden",i.callTip.text(""),i.headerTip.text("")})}var i=null,n=null,l=null,s=null,r=0,c="640px",d="0px",p=1,u=null,g=null,f=null,a=null,m=null,h=null,b=null,v=0,t=0,C=0;e.prototype.restore=function(){var e,t=this.el.find(".modal-content"),a=this.el.find(".modal-footer");0==p?(this.el.removeClass("video-chat-panel-mini"),t.removeClass("modal-content-mini"),u.removeClass("video-mini"),g.removeClass("video-mini"),g.css("visibility","visible"),a.css("display","flex"),n.css("display","block"),l.css("display","block"),s.css("display","none")):2==p&&(0<r&&(clearTimeout(r),r=0),this.el.css("left",c),this.el.css("top",d),this.el.css("width",""),this.el.css("height",""),(e=this.el.find(".modal-dialog")).css("width",""),e.css("height",""),t.css("width",""),t.css("height",""),a.css("width",""),u.css("width",""),u.css("height",""),g.css("width",""),g.css("height",""),n.css("display","block"),l.css("display","block"),s.css("display","none"),this.el.draggable({handle:".modal-header",containment:"document",disabled:!1})),this.refresh(),p=1},e.prototype.minimize=function(){var e,t;1==p&&(p=0,e=this.el.find(".modal-content"),t=this.el.find(".modal-footer"),this.el.addClass("video-chat-panel-mini"),e.addClass("modal-content-mini"),u.addClass("video-mini"),g.addClass("video-mini"),g.css("visibility","hidden"),t.css("display","none"),n.css("display","none"),l.css("display","none"),s.css("display","block"),this.refresh())},e.prototype.maximize=function(){1==p&&(p=2,this.resize(),n.css("display","none"),l.css("display","none"),s.css("display","block"),this.el.draggable({disabled:!0}))},e.prototype.showMakeCall=function(e){console.log("发起视频连线 "+e.getId()),o.app.callCtrl.makeCall(e,!0)?(this.elRemoteLabel.text(e.getName()),this.elLocalLabel.text("我"),this.el.modal({keyboard:!1,backdrop:!1})):o.dialog.launchToast(Toast.Warning,"您当前正在通话中")},e.prototype.showAnswerCall=function(e){console.log("应答视频通话 "+e.getId()),this.elRemoteLabel.text(e.getName()),this.elLocalLabel.text("我"),this.el.modal({keyboard:!1,backdrop:!1})},e.prototype.close=function(){this.el.modal("hide")},e.prototype.tipWaitForAnswer=function(e){var t,a;0<v||(t=i.callTip.parent().height(),i.callTip.css("top",.5*(t-21)+"px"),a=0,v=setInterval(function(){i.callTip.text("正在呼叫“"+e.getName()+"”："+ ++a+" 秒...")},1e3))},e.prototype.tipConnected=function(){0<v&&(clearInterval(v),v=0),0<t||(i.callTip.text(""),m.style.visibility="visible",this.btnCam.removeAttr("disabled"),this.btnMic.removeAttr("disabled"),this.btnVol.removeAttr("disabled"),t=setInterval(function(){i.headerTip.text(o.formatClockTick(++C))},1e3))},e.prototype.openNewCallToast=function(e){e=['<div class="toasts-info">                <div class="info-box">                    <span class="info-box-icon"><img src="',e.getContext().avatar,'" /></span>                    <div class="info-box-content">                        <span class="info-box-text">',e.getName(),'</span>                        <span class="info-box-desc">邀请您参与视频通话</span>                    </div>                </div>                <div class="call-answer">                    <button type="button" class="btn btn-danger" onclick="javascript:app.callCtrl.hangupCall();"><i class="ci ci-hangup"></i> 拒绝</button>                    <button type="button" class="btn btn-success" onclick="javascript:app.callCtrl.answerCall();"><i class="ci ci-answer"></i> 接听</button>                </div>            </div>'];$(document).Toasts("create",{title:"视频通话邀请",position:"bottomRight",icon:"fas fa-video",close:!1,class:"video-new-call",body:e.join("")})},e.prototype.closeNewCallToast=function(){$("#toastsContainerBottomRight").find(".video-new-call").remove()},e.prototype.switchVideo=function(){var e,t;a=b==m?(b=h,f=g,u):(b=m,f=u,g),f.removeClass("video-pip"),a.removeClass("video-main"),f.addClass("video-main"),a.addClass("video-pip"),2==p&&(e=parseInt(document.body.clientWidth),t=o.dialog.getFullHeight(),f.css("width",e-4+"px"),f.css("height",t-105-4+"px"),a.css("width",""),a.css("height",""))},e.prototype.terminate=function(){o.app.callCtrl.hangupCall()},e.prototype.onResize=function(e){2==p&&(0<r&&(clearTimeout(r),r=0),r=setTimeout(function(){clearTimeout(r),r=0,i.resize()},600))},e.prototype.resize=function(){var e,t,a,i,n;2==p&&(e=parseInt(document.body.clientWidth),t=o.dialog.getFullHeight(),c=this.el.css("left"),d=this.el.css("top"),this.el.css("left","322px"),this.el.css("top","-1px"),this.el.css("width",e+"px"),this.el.css("height",t+"px"),a=this.el.find(".modal-dialog"),i=this.el.find(".modal-content"),n=this.el.find(".modal-footer"),t-=2,a.css("width",(e-=2)+"px"),a.css("height",t+"px"),i.css("width",e+"px"),i.css("height",t+"px"),f.css("width",e-2+"px"),f.css("height",t-105-2+"px"),n.css("width",e+"px"),this.refresh())},e.prototype.refresh=function(){var e=i.callTip.parent().height();i.callTip.css("top",.5*(e-21)+"px")},o.VideoChatPanel=e}(window),function(a){"use strict";function t(){dialog.showPrompt("修改联系人备注","请输入“"+n.getName()+"”的备注名：",function(e,t){e&&n.getAppendix().updateRemarkName(t,function(e){dialog.launchToast(Toast.Success,"已修改联系人备注名"),i.find(".widget-user-username").text(e.hasRemarkName()?e.getRemarkName():n.getName()),a.app.messagingCtrl.updateContact(n)},function(e){dialog.launchToast(Toast.Success,"修改联系人备注名失败: "+e.code)})},n.getAppendix().getRemarkName())}function e(e){(i=e).find('button[data-target="edit-remarkname"]').click(t)}var i=null,n=null;e.prototype.show=function(e){var t=i,a=(n=e).getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():e.getName();t.find(".widget-user-username").text(a),t.find(".widget-user-desc").text(e.getName()),t.find(".user-avatar").attr("src",e.getContext().avatar),t.find(".user-id").text(e.getId()),t.find(".user-region").text(e.getContext().region),t.find(".user-department").text(e.getContext().department),t.modal("show")},e.prototype.hide=function(){i.modal("hide")},a.ContactDetails=e}(window),function(r){"use strict";function t(){r.dialog.showPrompt("修改群组名称","请输入新的群组名",function(e,t){if(e){if(!(3<=t.length))return r.dialog.showAlert("输入的群组名称不能少于3个字符。"),!1;r.app.messagingCtrl.modifyGroupName(o,t,function(e){s.text(e.getName()),r.app.messagingCtrl.updateGroup(e)})}})}function a(){var t=r.app.getMyContacts(),a=o.getMembers();r.app.contactListDialog.show(t,a,function(e){return t.length==a.length+1||(0==e.length?(r.dialog.showAlert("没有选择联系人"),!1):(o.addMembers(e,function(){r.app.groupDetails.refresh()},function(e){r.dialog.launchToast(Toast.Error,"添加群组成员失败: "+e.code)}),!0))})}function i(){o.isOwner()?r.dialog.showAlert("您是该群组的群主，不能退出该群。",null,"我知道了"):r.dialog.showConfirm("退出群组","您确定要退出“"+o.getName()+"”群组吗？",function(e){e&&window.cube().contact.quitGroup(o,function(){r.app.messagingCtrl.removeGroup(o),r.app.groupDetails.hide()},function(e){r.dialog.launchToast(Toast.Error,"退出群组失败: "+e.code)})})}function n(){o.isOwner()?r.dialog.showConfirm("解散群组","您确定要解散“"+o.getName()+"”群组吗？",function(e){e&&window.cube().contact.dissolveGroup(o,function(){r.app.messagingCtrl.removeGroup(o),r.app.groupDetails.hide()},function(e){r.dialog.launchToast(Toast.Error,"解散群组失败: "+e.code)})}):r.dialog.showAlert("您不是该群组的群主，不能解散该群。",null,"我知道了")}function e(e){this.el=e,s=e.find(".widget-user-username"),(c=$("#group_details_modify")).click(t),(d=$("#group_details_add")).click(a),(p=$("#group_details_quit")).click(i),(u=$("#group_details_dissolve")).click(n)}var o=null,l=0,s=null,c=null,d=null,p=null,u=null;e.prototype.show=function(e){var t,a;null==o||o.getId()!=e.getId()||e.getLastActiveTime()!=l?(l=(o=e).getLastActiveTime(),t=this.el,s.text(e.getName()),c.attr("data",e.getId()),d.attr("data",e.getId()),p.attr("data",e.getId()),u.attr("data",e.getId()),(a=t.find(".table")).find("tbody").remove(),a.append(this.createGroupDetailsTable(e)),t.modal("show")):this.el.modal("show")},e.prototype.hide=function(){this.el.modal("hide")},e.prototype.refresh=function(){var e,t;null!=o&&((t=(e=this.el).find(".table")).find("tbody").remove(),t.append(this.createGroupDetailsTable(o)),e.modal("show"))},e.prototype.createGroupDetailsTable=function(e){for(var t=$("<tbody></tbody>"),a=e.isOwner(),i=(i=["app.messagingCtrl.removeGroupMember(","parseInt($(this).attr('data-group')),","parseInt($(this).attr('data-member'))",");"]).join(""),n=e.getMembers(),o=0;o<n.length;++o){var l=n[o],s=a?['<button class="btn btn-danger btn-xs" onclick="',i,'"',' data-member="',l.getId(),'"',' data-group="',e.getId(),'"',' data-original-title="从本群中移除" data-placement="top" data-toggle="tooltip"><i class="fas fa-minus"></i></button>']:[],s=(s=a&&l.equals(r.app.getSelf())?[]:s).join(""),l=r.app.queryContact(l.getId()),s=["<tr>","<td>",o+1,"</td>",'<td><img class="table-avatar" src="',l.getContext().avatar,'" /></td>',"<td>",l.getPriorityName(),"</td>","<td>",l.getId(),"</td>","<td>",l.getContext().region,"</td>","<td>",l.getContext().department,"</td>","<td>",s,"</td>","</tr>"],s=$(s.join(""));t.append(s)}return t},r.GroupDetails=e}(window),function(n){"use strict";function e(e){s=(l=e).find('div[data-target="my-contacts"]'),r=e.find('input[data-target="group-name"]'),e.find('button[data-target="confirm"]').click(function(){var e=r.val().trim();0==e.length&&(e=n.app.getSelf().getName()+"创建的群组");var a=[];s.find('input[type="checkbox"]:checked').each(function(e,t){a.push(parseInt($(t).attr("data")))}),0!=a.length?window.cube().contact.createGroup(e,a,function(e){n.app.messageCatalog.appendItem(e),l.modal("hide")},function(e){n.dialog.launchToast(Toast.Error,"创建群组失败: "+e.code)}):n.dialog.showAlert("请选择群组成员。",null,"我知道了")})}var o,l=null,s=null,r=null;e.prototype.show=function(){o=n.app.getMyContacts(),r.val(""),s.empty();for(var e=0;e<o.length;++e){var t=o[e],a=t.getId(),i=t.getContext().avatar,t=t.getPriorityName();s.append($(['<div class="col-6"><div class="form-group"><div class="custom-control custom-checkbox select-group-member">','<input class="custom-control-input" type="checkbox" id="group_member_',e,'" data="',a,'" />','<label class="custom-control-label" for="group_member_',e,'">','<img src="',i,'" />',"<span>",t,"</span>","</label>","</div></div></div>"].join("")))}l.modal("show")},n.NewGroupDialog=e}(window),function(e){"use strict";var s=null,r=null,c=null;function d(e,t){for(var a="number"==typeof e?e:e.getId(),i=0;i<t.length;++i){var n=t[i];if(n.getId()==a)return n}return null}function t(){var a,e;null!=c&&(a=[],s.find("tbody").find('input[type="checkbox"]:checked').each(function(e,t){t=parseInt($(t).attr("data"));null==d(t,r)&&a.push(t)}),void 0!==(e=c(a))&&!e||(s.modal("hide"),c=null))}function a(e){(s=e).find('button[data-target="confirm"]').click(t)}a.prototype.show=function(e,t,a){r=t,a&&(c=a);a=s.find("tbody");a.empty();for(var i=[],n=0;n<e.length;++n)var o=e[n],l=null!=d(o,t),o=["<tr>","<td>",'<div class="custom-control custom-checkbox">','<input class="custom-control-input" type="checkbox" data="',o.getId(),'" id="list_contact_',o.getId(),'"',l?' checked="checked" disabled="disabled"':"",">","</input>",'<label class="custom-control-label" for="list_contact_',o.getId(),'">',"</label>","</div>","</td>",'<td><img class="table-avatar" src="',o.getContext().avatar,'" /></td>',"<td>",o.getName(),"</td>","<td>",o.getId(),"</td>","<td>",o.getContext().region,"</td>","<td>",o.getContext().department,"</td>","</tr>"],i=i.concat(o);a.append(i.join("")),s.modal("show")},a.prototype.hide=function(){s.modal("hide"),c=null},e.ContactListDialog=a}(window),function(u){"use strict";function e(e){g=e,i=this,$("#col_messaging_catalog"),a=$("#col_messaging_content"),(n=$("#col_messaging_sidebar")).hasClass("no-display")||n.addClass("no-display"),g.messaging.on(MessagingEvent.Sent,function(e){e=e.data;u.app.messagePanel.appendMessage(u.app.messagePanel.current.entity,u.app.getSelf(),e),e.isFromGroup()?u.app.messageCatalog.updateItem(e.getSource(),e,e.getRemoteTimestamp()):u.app.messageCatalog.updateItem(e.getTo(),e,e.getRemoteTimestamp())}),g.messaging.on(MessagingEvent.Notify,function(e){e=e.data;i.onNewMessage(e)})}var i=null,g=null,t=null,a=null,n=null;e.prototype.updateContactMessages=function(e,r){var t,c;e.getId()!=u.app.account.id&&(t=Date.now()-window.AWeek,c=0,g.messaging.queryMessageWithContact(e,t,function(e,t,a){if(0!=(c=a.length)){for(var i,n=0,o=0;o<a.length;++o){var l=a[o];i=l,g.messaging.isSender(i)?u.app.messagePanel.appendMessage(i.getReceiver(),i.getSender(),i):u.app.messagePanel.appendMessage(i.getSender(),i.getSender(),i),--c,r&&0==c&&r(),l.isRead()||++n}for(o=a.length-1;0<=o;--o){var s=a[o];if(u.app.messageCatalog.updateItem(e,s,s.getRemoteTimestamp())){0<n&&u.app.messageCatalog.updateBadge(e,n);break}}}else r&&r()}))},e.prototype.updateGroupMessages=function(s,r){var e=Date.now()-window.AWeek,c=0,d=null,p=new OrderMap;g.messaging.queryMessageWithGroup(s,e,function(e,t,a){if(0!=(c=a.length)){d=a;for(var i=0,n=0;n<a.length;++n){var o=a[n];!function(a,t){u.app.getContact(t.getFrom(),function(e){p.put(t.getId(),e),0==--c&&(d.forEach(function(e){var t=p.get(e.getId());u.app.messagePanel.appendMessage(a,t,e)}),d=null,p.clear(),p=null,r&&r())})}(s,o),o.isRead()||++i}for(n=a.length-1;0<=n;--n){var l=a[n];if(u.app.messageCatalog.updateItem(e,l,l.getRemoteTimestamp())){0<i&&u.app.messageCatalog.updateBadge(e,i);break}}}else r&&r()})},e.prototype.updateContact=function(e){u.app.messagePanel.updatePanel(e.getId(),e),u.app.messageCatalog.updateItem(e,null,null,e.getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():e.getName())},e.prototype.updateGroup=function(e){u.app.messagePanel.updatePanel(e.getId(),e),u.app.messageCatalog.updateItem(e,null,null,e.getName())},e.prototype.selectFile=function(e){null==t&&(t=e).on("change",function(e){e=e.target.files[0];i.fireSend(u.app.messagePanel.current.entity,e)}),t.click()},e.prototype.fireSend=function(e,t){var a=null;if("string"==typeof t)a=new TextMessage(t);else{if(!(t instanceof File))return u.dialog.launchToast(Toast.Warning,"程序内部错误"),null;a=new(0<=t.type.indexOf("image")?ImageMessage:FileMessage)(t)}return a=g.messaging.sendTo(e,a)},e.prototype.toggle=function(t){var a;t!=u.app.account.id&&(a=function(e){null!=e&&(u.app.messagePanel.changePanel(t,e),u.app.messageCatalog.activeItem(t),u.app.messageCatalog.updateBadge(t,0))},u.app.getGroup(t,function(e){null==e?(u.app.getContact(t,a),i.hideSidebar()):(a(e),u.app.messageSidebar.update(e),i.showSidebar())}))},e.prototype.showSidebar=function(){n.hasClass("no-display")&&(a.removeClass("col-md-9"),a.removeClass("col-sm-10"),a.addClass("col-md-6"),a.addClass("col-sm-6"),n.removeClass("no-display"))},e.prototype.hideSidebar=function(){n.hasClass("no-display")||(a.removeClass("col-md-6"),a.removeClass("col-sm-6"),a.addClass("col-md-9"),a.addClass("col-sm-10"),n.addClass("no-display"))},e.prototype.showGroupMember=function(){},e.prototype.recallMessage=function(t,e){g.messaging.recallMessage(e,function(e){u.app.messagePanel.appendNote(t,"消息已撤回 "+u.formatFullTime(Date.now())),u.app.messagePanel.removeMessage(t,e)},function(e){u.dialog.launchToast(Toast.Error,e.code==MessagingServiceState.DataTimeout?"消息发送超过2分钟，不能撤回":"撤回消息失败"),console.log("撤回消息失败 - "+e)})},e.prototype.deleteMessage=function(t,e){g.messaging.deleteMessage(e,function(e){u.dialog.launchToast(Toast.Success,"消息已删除"),u.app.messagePanel.removeMessage(t,e)},function(e){u.dialog.launchToast(Toast.Error,"删除消息失败"),console.log("删除消息失败 - "+e)})},e.prototype.openVoiceCall=function(e){u.app.voiceCallPanel.showMakeCall(e)},e.prototype.openVideoChat=function(e){u.app.videoChatPanel.showMakeCall(e)},e.prototype.onNewMessage=function(e){e.isFromGroup()?(u.app.messagePanel.appendMessage(e.getSourceGroup(),e.getSender(),e),u.app.messageCatalog.updateItem(e.getSource(),e,e.getRemoteTimestamp()),i.updateUnread(group.getId(),e)):u.app.account.id==e.getFrom()?(u.app.messagePanel.appendMessage(e.getReceiver(),e.getSender(),e),u.app.messageCatalog.updateItem(e.getTo(),e,e.getRemoteTimestamp()),i.updateUnread(e.getTo(),e)):(u.app.messagePanel.appendMessage(e.getSender(),e.getSender(),e),u.app.messageCatalog.updateItem(e.getFrom(),e,e.getRemoteTimestamp()),i.updateUnread(e.getFrom(),e))},e.prototype.updateUnread=function(e,t){var a=u.app.messagePanel.getCurrentPanel();null!=a&&(t.isRead()||(a.id==e?g.messaging.markRead(t):0<(a=u.app.messagePanel.getPanel(e)).unreadCount&&u.app.messageCatalog.updateBadge(e,a.unreadCount)))},e.prototype.modifyGroupName=function(e,t,a){e.modifyName(t,function(e){u.dialog.launchToast(Toast.Success,"已修改群组名称"),a&&a(e)},function(e){u.dialog.launchToast(Toast.Warning,"修改群名称失败: "+e.code)})},e.prototype.removeGroupMember=function(e,t,i){var a=getGroup(e),e=getContact(t),n=null,n=null!=e?e.getName():t;u.dialog.showConfirm("移除群成员","您确定要把“"+n+"”移除群组吗？",function(e){e&&a.removeMembers([t],function(e,t,a){u.dialog.launchToast(Toast.Success,"已移除成员“"+n+"”"),i&&i(e,t,a),u.app.groupDetails.refresh()},function(e){u.dialog.launchToast(Toast.Warning,"移除群成员失败: "+e.code)})})},e.prototype.removeGroup=function(e){u.app.messageCatalog.removeItem(e),u.app.messagePanel.clearPanel(e.getId())},u.MessagingController=e}(window),function(a){"use strict";var i=null,n=!1,o=!1,l=.7;function t(e){}function s(e){(o?a.app.voiceCallPanel:a.app.videoChatPanel).tipWaitForAnswer(e.data.getCallee())}function r(e){(o?a.app.voiceCallPanel:a.app.videoChatPanel).tipConnected()}function c(e){var t=e.data,e=t.getCaller();null!=e&&(t.callerMediaConstraint.videoEnabled?(n=!(o=!1),a.app.videoChatPanel.openNewCallToast(e)):(n=o=!0,a.app.voiceCallPanel.openNewCallToast(e)))}function d(e){var t=e.data;n=!1,(o?a.app.voiceCallPanel:a.app.videoChatPanel).close(),t.isCaller()&&(e=new CallRecordMessage(t),i.messaging.sendTo(t.getCallee(),e));t=t.getDuration(),t=1e3<t?"通话结束 - "+a.formatClockTick(parseInt(t/1e3)):"通话结束";console.log(t),a.dialog.launchToast(Toast.Info,t)}function p(e){var t=e.data;n=!1;e=null,e=t.isCaller()?"被叫忙，拒绝通话":"已拒绝通话邀请";console.log(e),a.dialog.launchToast(Toast.Info,e),o?(a.app.voiceCallPanel.close(),a.app.voiceCallPanel.closeNewCallToast()):(a.app.videoChatPanel.close(),a.app.videoChatPanel.closeNewCallToast())}function u(e){o?(a.app.voiceCallPanel.close(),a.app.voiceCallPanel.closeNewCallToast()):(a.app.videoChatPanel.close(),a.app.videoChatPanel.closeNewCallToast()),e.data.isCaller()&&a.dialog.launchToast(Toast.Info,"对方无应答")}function g(e){e=e.data;n=!1,console.log("onCallFailed - "+e),e.code==CallState.MediaPermissionDenied?o?a.dialog.launchToast(Toast.Warning,"未能获得麦克风使用权限"):a.dialog.launchToast(Toast.Warning,"未能获得摄像头/麦克风使用权限"):a.dialog.launchToast(Toast.Warning,"通话失败，故障码："+e.code),setTimeout(function(){o?(a.app.voiceCallPanel.close(),a.app.voiceCallPanel.closeNewCallToast()):(a.app.videoChatPanel.close(),a.app.videoChatPanel.closeNewCallToast())},500)}function e(e){(i=e).mpComm.on(CallEvent.InProgress,t),i.mpComm.on(CallEvent.Ringing,s),i.mpComm.on(CallEvent.NewCall,c),i.mpComm.on(CallEvent.Connected,r),i.mpComm.on(CallEvent.Bye,d),i.mpComm.on(CallEvent.Busy,p),i.mpComm.on(CallEvent.Timeout,u),i.mpComm.on(CallEvent.CallFailed,g)}e.prototype.makeCall=function(e,t){if(n)return!1;n=!0,t?(o=!1,i.mpComm.setRemoteVideoElement(a.app.videoChatPanel.remoteVideo),i.mpComm.setLocalVideoElement(a.app.videoChatPanel.localVideo)):(o=!0,i.mpComm.setRemoteVideoElement(a.app.voiceCallPanel.remoteVideo),i.mpComm.setLocalVideoElement(a.app.voiceCallPanel.localVideo));t=new MediaConstraint(t,!0);return i.mpComm.makeCall(e,t)},e.prototype.answerCall=function(){if(!n)return!1;if(o){a.app.voiceCallPanel.closeNewCallToast(),i.mpComm.setRemoteVideoElement(a.app.voiceCallPanel.remoteVideo),i.mpComm.setLocalVideoElement(a.app.voiceCallPanel.localVideo);var e=new MediaConstraint(!1,!0);if(i.mpComm.answerCall(e))return a.app.voiceCallPanel.showAnswerCall(i.mpComm.getActiveRecord().getCaller()),!0}else{a.app.videoChatPanel.closeNewCallToast(),i.mpComm.setRemoteVideoElement(a.app.videoChatPanel.remoteVideo),i.mpComm.setLocalVideoElement(a.app.videoChatPanel.localVideo);e=new MediaConstraint(!0,!0);if(i.mpComm.answerCall(e))return a.app.videoChatPanel.showAnswerCall(i.mpComm.getActiveRecord().getCaller()),!0}return!1},e.prototype.hangupCall=function(){return!!n&&(n=!1,i.mpComm.hangupCall()||console.error("终止通话时发生错误。"),o?(a.app.voiceCallPanel.close(),a.app.voiceCallPanel.closeNewCallToast()):(a.app.videoChatPanel.close(),a.app.videoChatPanel.closeNewCallToast()),!0)},e.prototype.toggleCamera=function(){var e=i.mpComm.getActiveField();if(null==e)return console.debug("CallController - #toggleCamera() field is null"),!0;e=e.getRTCDevice();return null==e?(console.debug("CallController - #toggleCamera() rtcDevice is null"),!0):(e.outboundVideoEnabled()?e.enableOutboundVideo(!1):e.enableOutboundVideo(!0),e.outboundVideoEnabled())},e.prototype.toggleMicrophone=function(){var e=i.mpComm.getActiveField();if(null==e)return console.debug("CallController - #toggleMicrophone() field is null"),!0;e=e.getRTCDevice();return null==e?(console.debug("CallController - #toggleMicrophone() rtcDevice is null"),!0):(e.outboundAudioEnabled()?e.enableOutboundAudio(!1):e.enableOutboundAudio(!0),e.outboundAudioEnabled())},e.prototype.toggleLoudspeaker=function(){var e=i.mpComm.getActiveField();if(null==e)return console.debug("CallController - #toggleLoudspeaker() field is null"),!0;var t=e.getRTCDevice();if(null==t)return console.debug("CallController - #toggleLoudspeaker() rtcDevice is null"),!0;e=t.getVolume();return console.debug("CallController - #toggleLoudspeaker() volume is "+e),0<e?(l=e,t.setVolume(0),!1):(t.setVolume(l),!0)},a.CallController=e}(window),function(t){"use strict";function e(e,t){n=t,o=(i=e).find("#btn_all_files"),l=i.find("#btn_image_files"),s=i.find("#btn_doc_files"),r=i.find("#btn_recyclebin"),n.find("#btn_trans_upload"),n.find("#btn_trans_download"),n.find("#btn_trans_complete"),c=o,a=this}var a=null,i=null,n=null,o=null,l=null,s=null,r=null,c=null;e.prototype.prepare=function(){t.app.filesPanel.showRoot(),o.click(function(){a.select($(this).attr("id"))}),l.click(function(){a.select($(this).attr("id"))}),s.click(function(){a.select($(this).attr("id"))}),r.click(function(){a.select($(this).attr("id"))})},e.prototype.select=function(e){c.attr("id")!=e&&(c.removeClass("active"),o.attr("id")==e?(c=o,t.app.filesPanel.showRoot()):l.attr("id")==e?(c=l,t.app.filesPanel.showImages()):s.attr("id")==e?(c=s,t.app.filesPanel.showDocuments()):r.attr("id")==e&&(c=r,t.app.filesPanel.showRecyclebin()),c.addClass("active"),t.app.filesPanel.setTitle(c.attr("title")))},t.FilesCatalogue=e}(window),function(r){"use strict";var t,a=null,i=null,n=null;function c(e,t){var a=e.getId(),i=e.getName(),n=e.getLastModified();return["<tr onclick=\"app.filesPanel.toggleSelect('",a,"')\""," ondblclick=\"app.filesPanel.changeDirectory('",a,'\')" id="ftr_',a,'">','<td><div class="icheck-primary">','<input type="checkbox" data-type="folder" id="',a,'">','<label for="',a,'"></label></div></td>','<td class="file-icon"><i class="ci ci-file-directory"></i></td>','<td class="file-name"><a href="javascript:app.filesPanel.changeDirectory(\'',a,"');\">",i=t?i+" （于 "+r.formatYMDHMS(e.getTrashTimestamp())+"）":i,"</a></td>",'<td class="file-size">--</td>','<td class="file-lastmodifed">',r.formatYMDHMS(n),"</td>","</tr>"]}function d(e){e=e.getFileType();return"png"==e||"jpeg"==e||"gif"==e||"jpg"==e||"bmp"==e?'<i class="ci ci-file-image"></i>':"xls"==e||"xlsx"==e?'<i class="ci ci-file-excel"></i>':"ppt"==e||"pptx"==e?'<i class="ci ci-file-powerpoint"></i>':"doc"==e||"docx"==e?'<i class="ci ci-file-word"></i>':"mp3"==e||"ogg"==e||"wav"==e?'<i class="ci ci-file-music"></i>':"pdf"==e?'<i class="ci ci-file-pdf"></i>':"rar"==e?'<i class="ci ci-file-rar"></i>':"zip"==e||"gz"==e?'<i class="ci ci-file-zip"></i>':"txt"==e||"log"==e?'<i class="ci ci-file-text"></i>':"mp4"==e||"mkv"==e||"avi"==e||"ts"==e?'<i class="ci ci-file-video"></i>':"psd"==e?'<i class="ci ci-file-psd"></i>':"exe"==e||"dll"==e?'<i class="ci ci-file-windows"></i>':"apk"==e?'<i class="ci ci-file-apk"></i>':"dmg"==e?'<i class="ci ci-file-dmg"></i>':"ipa"==e?'<i class="ci ci-file-ipa"></i>':'<i class="fa fa-file-alt ci-fa-file"></i>'}function e(e){a=e,i=$("#table_files_nofile"),t=e.find('tbody[data-target="surface-a"]'),e.find('tbody[data-target="surface-b"]'),n=t}e.prototype.updatePage=function(e,l){if(0==e.length)return n[0].innerHTML="",void i.css("display","block");var s=[];e.forEach(function(e){var t,a,i,n,o=null,o=e instanceof FileLabel||e instanceof TrashFile?(i=l,n=(a=e).getFileName(),i&&(n=n+" （于 "+r.formatYMDHMS(a.getTrashTimestamp())+"）"),["<tr onclick=\"app.filesPanel.toggleSelect('",i=a.getId(),"')\""," ondblclick=\"app.filesPanel.openFileDetails('",a.getFileCode(),"')\"",' id="ftr_',i,'">','<td><div class="icheck-primary">','<input type="checkbox" data-type="file" id="',i,'">','<label for="',i,'"></label></div></td>','<td class="file-icon">',d(a),"</td>",'<td class="file-name"><a href="javascript:app.filesPanel.openFile(\'',a.getFileCode(),"');\">",n,"</a></td>",'<td class="file-size">',r.formatSize(a.getFileSize()),"</td>",'<td class="file-lastmodifed">',r.formatYMDHMS(a.getLastModified()),"</td>","</tr>"]):e instanceof SearchItem?(i=(t=e).file,n=t.directory,"root"==(a=n.getName())&&(a="/"),["<tr onclick=\"app.filesPanel.toggleSelect('",t=i.getId(),'\')" id="ftr_',t,'">','<td><div class="icheck-primary">','<input type="checkbox" data-type="file" id="',t,'">','<label for="',t,'"></label></div></td>','<td class="file-icon">',d(i),"</td>",'<td class="file-name"><a href="javascript:app.filesPanel.openFile(\'',i.getFileCode(),"','",n.getId(),"');\">",i.getFileName(),"</a>",'<span class="desc">所在目录: ',a,"</span>","</td>",'<td class="file-size">',r.formatSize(i.getFileSize()),"</td>",'<td class="file-lastmodifed">',r.formatYMDHMS(i.getLastModified()),"</td>","</tr>"]):c(e,l);s=s.concat(o)}),0<s.length&&i.css("display","none"),n[0].innerHTML=s.join("")},e.prototype.toggleSelect=function(e){r.app.filesPanel.resetSelectAllButton();var t=a.find("#"+e);t.prop("checked")?(t.prop("checked",!1),a.find("#ftr_"+e).removeClass("table-primary")):(t.prop("checked",!0),a.find("#ftr_"+e).addClass("table-primary"))},e.prototype.unselect=function(e){var t=a.find("#"+e);t.prop("checked")&&(t.prop("checked",!1),a.find("#ftr_"+e).removeClass("table-primary"))},e.prototype.insertFolder=function(e){e=c(e);n.prepend($(e.join("")))},r.FilesTable=e}(window),function(r){"use strict";function e(e){d=e,m=new FilesTable(e.find(".table-files")),t=e.find(".checkbox-toggle"),a=e.find('button[data-target="upload"]'),n=e.find('button[data-target="empty-trash"]'),o=e.find('button[data-target="restore"]'),i=e.find('button[data-target="new-dir"]'),l=e.find('button[data-target="parent"]'),s=e.find('button[data-target="recycle"]'),p=e.find(".info-loaded"),u=e.find(".info-total"),(g=e.find('button[data-target="prev"]')).attr("disabled","disabled"),(f=e.find('button[data-target="next"]')).attr("disabled","disabled"),(c=this).initUI()}var c=null,d=null,t=null,a=null,i=null,n=null,o=null,l=null,s=null,p=0,u=0,g=null,f=null,m=null,h=null,b=null,v={page:0,loaded:0},C=null,y=!1,w=!1;e.prototype.initUI=function(){t.click(function(){var e=$(this).data("clicks");e?($('.table-files input[type="checkbox"]').prop("checked",!1),$(".checkbox-toggle .far.fa-check-square").removeClass("fa-check-square").addClass("fa-square")):($('.table-files input[type="checkbox"]').prop("checked",!0),$(".checkbox-toggle .far.fa-square").removeClass("fa-square").addClass("fa-check-square")),$(this).data("clicks",!e)}),a.click(function(){window.cube().launchFileSelector(function(e){e=e.target.files[0];b.uploadFile(e,function(e){},function(e,t){c.refreshTable(!0)},function(e){})})}),i.click(function(){r.dialog.showPrompt("新建文件夹","请输入新建文件夹的名称",function(e,t){if(e){t=t.trim();return 0==t.length?(alert("文件夹名称不能为空。"),!1):(c.newDirectory(t),!0)}})}),n.click(function(){r.dialog.showConfirm("清空回收站",'您确认清空回收站吗？<p class="text-danger tip">清空回收站将删除回收站内的所有文件，不可恢复！</p>',function(e){e&&window.cube().fs.emptyTrash(function(e){c.showRecyclebin()},function(e){r.dialog.launchToast(Toast.Error,"清空回收站失败: "+e.code)})},"清空回收站")}),o.click(function(){for(var e=[],t=d.find('.table-files input[type="checkbox"]'),a=0;a<t.length;++a){var i=$(t.get(a));i.prop("checked")&&e.push(parseInt(i.attr("id")))}0!=e.length&&window.cube().fs.restoreTrash(e,function(e,t){c.showRecyclebin(),app.filesCtrl.resetPageData(e)},function(e){r.dialog.launchToast(Toast.Error,"清空回收站失败: "+e.code)})}),l.click(function(){var e;b!=h&&(e=b.getParent(),c.changeDirectory(e))}),s.click(function(){for(var t,e,a,i,o=[],n=d.find('.table-files input[type="checkbox"]'),l=0;l<n.length;++l){var s=$(n.get(l));s.prop("checked")&&o.push({id:parseInt(s.attr("id")),type:s.attr("data-type")})}0!=o.length&&(i=null,w?(t=[],o.forEach(function(e){t.push(e.id)}),i=['您确定要删除所选择的“<span class="text-danger">',t.length,"</span>”个项目吗？",'<p class="text-danger tip">将立即删除此项目。您不能撤销此操作。</p>'],r.dialog.showConfirm("立即删除",i.join(""),function(e){e&&window.cube().fs.eraseTrash(t,function(e){c.showRecyclebin()},function(e){r.dialog.launchToast(Toast.Error,"删除文件失败: "+e.code)})},"立即删除")):(i=1==o.length?(a="",a=null==(e=b.getDirectory(o[0].id))?(e=b.getFile(o[0].id)).getFileName():e.getName(),["您确定要删除","folder"==o[0].type?"文件夹":"文件",'“<span class="text-danger">',a,"</span>”吗？"]):["您确定要删除所选择的<b>",o.length,"</b>个项目吗？"],r.dialog.showConfirm("删除文件",i.join(""),function(e){var t,a,i,n;e&&(t=[],a=[],o.forEach(function(e){("folder"==e.type?t:a).push(e.id)}),i=0==t.length,n=0==a.length,b.deleteDirectory(t,!0,function(e,t){i=!0,n&&c.refreshTable(!0)},function(e){r.dialog.launchToast(Toast.Error,"删除文件夹失败: "+e.code)}),b.deleteFile(a,function(e,t){n=!0,i&&c.refreshTable(!0)},function(e){r.dialog.launchToast(Toast.Error,"删除文件失败: "+e.code)}))},"删除")))}),g.click(function(){w||(y?0!=C.begin&&(C.end=C.begin,C.begin=C.begin-r.app.filesCtrl.numPerPage,0==C.begin&&g.attr("disabled","disabled"),window.cube().fs.searchFile(C,function(e,t){t.length<r.app.filesCtrl.numPerPage&&(f.attr("disabled","disabled"),0==t.length)||(m.updatePage(t),p.text(t.length),f.removeAttr("disabled"))},function(e){r.dialog.launchToast(Toast.Error,"过滤文件错误: "+e.code)})):0!=v.page&&(--v.page,0==v.page&&g.attr("disabled","disabled"),c.refreshTable(),f.removeAttr("disabled")))}),f.click(function(){w||(y?(C.begin=C.end,C.end=C.end+r.app.filesCtrl.numPerPage,window.cube().fs.searchFile(C,function(e,t){return t.length<r.app.filesCtrl.numPerPage&&(f.attr("disabled","disabled"),0==t.length)?(C.end=C.end-r.app.filesCtrl.numPerPage,void(C.begin=C.end-r.app.filesCtrl.numPerPage)):(g.removeAttr("disabled"),m.updatePage(t),void p.text(t.length))},function(e){r.dialog.launchToast(Toast.Error,"过滤文件错误: "+e.code)})):r.app.filesCtrl.getPageData(b,v.page+1,function(e){null==e?(f.attr("disabled","disabled"),0!=v.page&&g.removeAttr("disabled"),r.dialog.launchToast(Toast.Info,"没有更多数据")):(v.page+=1,c.refreshTable())}))})},e.prototype.setTitle=function(e){d.find(".fp-title").text(e)},e.prototype.updateTitlePath=function(){if(null!=b){var e=[];this.recurseParent(e,b);for(var t=['<ol class="breadcrumb float-sm-right">','<li class="breadcrumb-item',0==e.length?" active":"",'">',0==e.length?"我的文件":"<a href=\"javascript:app.filesPanel.changeDirectory('"+h.getId()+"');\">我的文件</a>","</li>"],a=0;a<e.length;++a){var i=e[a];t.push('<li class="breadcrumb-item'),a+1==e.length?(t.push(" active"),t.push('">'),t.push(i.getName()),t.push("</li>")):(t.push('"><a href="javascript:;">'),t.push(i.getName()),t.push("</a></li>"))}t.push("</ol>"),d.find(".fp-path").html(t.join(""))}},e.prototype.recurseParent=function(e,t){var a=t.getParent();null!=a&&(e.push(t),this.recurseParent(e,a))},e.prototype.refreshTable=function(e){e&&r.app.filesCtrl.resetPageData(b),r.app.filesCtrl.getPageData(b,v.page,function(e){return null==e?(f.attr("disabled","disabled"),m.updatePage([]),p.text(0),void u.text(0)):(m.updatePage(e),v.loaded=e.length,p.text(v.page*r.app.filesCtrl.numPerPage+e.length),u.text(b.totalDirs()+b.totalFiles()),void(v.loaded<r.app.filesCtrl.numPerPage?f.attr("disabled","disabled"):f.removeAttr("disabled")))}),0==v.page?g.attr("disabled","disabled"):g.removeAttr("disabled"),v.loaded<r.app.filesCtrl.numPerPage?f.attr("disabled","disabled"):f.removeAttr("disabled")},e.prototype.showRoot=function(){w=y=!1,null!=b?(a.css("display","inline-block"),i.css("display","inline-block"),l.css("display","block"),n.css("display","none"),o.css("display","none"),this.refreshTable(),this.updateTitlePath()):r.app.filesCtrl.getRoot(function(e){b=h=e,c.showRoot()})},e.prototype.showImages=function(){w=!(y=!0),n.css("display","none"),o.css("display","none"),d.find(".fp-path").html(""),a.css("display","none"),i.css("display","none"),l.css("display","none"),g.attr("disabled","disabled"),f.attr("disabled","disabled"),C={begin:0,end:r.app.filesCtrl.numPerPage,type:["jpg","png","gif","bmp"]},window.cube().fs.searchFile(C,function(e,t){m.updatePage(t),p.text(t.length),t.length==r.app.filesCtrl.numPerPage&&f.removeAttr("disabled")},function(e){r.dialog.launchToast(Toast.Error,"过滤图片文件: "+e.code)}),u.text("--")},e.prototype.showDocuments=function(){w=!(y=!0),n.css("display","none"),o.css("display","none"),d.find(".fp-path").html(""),a.css("display","none"),i.css("display","none"),l.css("display","none"),g.attr("disabled","disabled"),f.attr("disabled","disabled"),C={begin:0,end:r.app.filesCtrl.numPerPage,type:["pdf","doc","docx","xls","xlsx","ppt","pptx","docm","dotm","dotx","ett","xlsm","xlt","dpt","ppsm","ppsx","pot","potm","potx","pps","ptm"]},window.cube().fs.searchFile(C,function(e,t){m.updatePage(t),p.text(t.length),t.length==r.app.filesCtrl.numPerPage&&f.removeAttr("disabled")},function(e){r.dialog.launchToast(Toast.Error,"过滤文档文件: "+e.code)}),u.text("--")},e.prototype.showRecyclebin=function(){w=!(y=!1),n.css("display","inline-block"),o.css("display","inline-block"),d.find(".fp-path").html(""),a.css("display","none"),i.css("display","none"),l.css("display","none"),g.attr("disabled","disabled"),f.attr("disabled","disabled"),window.cube().fs.listTrash(0,20,function(e,t,a,i){m.updatePage(t,!0),p.text(t.length),u.text("--")},function(e){r.dialog.launchToast(Toast.Error,"读取回收站数据错误: "+e.code),m.updatePage([]),p.text(0),u.text("--")})},e.prototype.toggleSelect=function(e){m.toggleSelect(e)},e.prototype.changeDirectory=function(e){if(!w&&!y){var t=typeof e;if("number"==t||"string"==t){var a=parseInt(e);if(b.getId()==a)return;b=a==h.getId()?h:t=null==(t=b.getDirectory(a))?r.cube().fs.querySelfDirectory(a):t,m.unselect(a)}else{if(e==b)return;b=e}this.refreshTable(),this.updateTitlePath()}},e.prototype.openFile=function(e,t){var a,i=null,n=null;w||(y?null!=(a=window.cube().fs.querySearch(t,e))&&(n=a.directory,i=a.file):i=(n=b).getFile(e)),null!=i&&("png"==(a=i.getFileType())||"jpeg"==a||"gif"==a||"jpg"==a||"bmp"==a?(m.unselect(e),r.dialog.showImage(i)):(m.unselect(e),r.app.fileDetails.open(i,n)))},e.prototype.openFileDetails=function(e){var t;w||y||null!=(t=b.getFile(e))&&(m.unselect(e),r.app.fileDetails.open(t,b))},e.prototype.newDirectory=function(e){r.dialog.launchToast(Toast.Info,"新建文件夹“"+e+"”"),b.newDirectory(e,function(e){m.insertFolder(e),r.app.filesCtrl.resetPageData(b)},function(e){r.dialog.launchToast(Toast.Error,"新建文件夹失败: "+e.code)})},e.prototype.resetSelectAllButton=function(){t.data("clicks",!1),$(".checkbox-toggle .far.fa-check-square").removeClass("fa-check-square").addClass("fa-square")},r.FilesPanel=e}(window),function(e){"use strict";function t(){this.pages=new OrderMap,this.list=[],this.fileIndex=0}var a=null,i=null,r=new OrderMap;t.prototype.get=function(e){return this.pages.get(e)},t.prototype.append=function(e,t){if(this.contains(t))return!1;var a=this.pages.get(e);return null==a&&this.pages.put(e,a=[]),a.push(t),this.list.push(t),!0},t.prototype.size=function(e){e=this.pages.get(e);return null==e?0:e.length},t.prototype.contains=function(e){for(var t=0;t<this.list.length;++t)if(this.list[t].getId()==e.getId())return!0;return!1};function n(e){a=e,this.numPerPage=20}n.prototype.getRoot=function(t){null==i?a.fs.getSelfRoot(function(e){t(i=e)},function(e){console.log(e)}):t(i)},n.prototype.resetPageData=function(e){r.remove(e.getId())},n.prototype.sizePage=function(e,t){e=r.get(e.getId());if(null==e)return 0;t=e.get(t);return null==t?0:t.length},n.prototype.getPageData=function(i,n,o){var l=r.get(i.getId());null==l&&(l=new t,r.put(i.getId(),l));var s=l.get(n);null==s?i.listDirectories(function(e,t){if(l.list.length<t.length){for(var a=0;a<t.length&&(l.append(n,t[a]),20!=l.size(n));++a);if(null!=(s=l.get(n))&&20==s.length)return void o(s)}i.listFiles(l.fileIndex,l.fileIndex+20,function(e,t){for(var a=0;a<t.length&&(!l.append(n,t[a])||(l.fileIndex+=1,20!=l.size(n)));++a);o(l.get(n))})}):o(s)},e.FilesController=n}(window),function(e){"use strict";function t(e){a=e.find(".table"),l=a.find("tbody"),s=e.find(".pagination")}var a=null,l=null,s=null,i=[],n=null,r=1,o=0;t.prototype.getCurrentContact=function(e){return n[e]},t.prototype.update=function(e){(i=e).sort(function(e,t){return e.getName().localeCompare(t.getName())}),n=[];for(var t=0;t<10&&t<i.length;++t)n.push(i[t]);o=Math.ceil(i.length/10),this.paging(o),r=0,this.show(1,n)},t.prototype.showPage=function(e){if(r!=e&&!(e<1||o<e)){n=[];for(var t=10*(e-1);t<i.length&&n.length<10;++t)n.push(i[t]);this.show(e,n)}},t.prototype.paging=function(e){for(var t=['<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.prevPage();">«</a></li>'],a=1;a<=e;++a)t.push('<li class="page-item page-'+a+'"><a class="page-link" href="javascript:app.contactsCtrl.showPage('+a+');">'+a+"</a></li>");t.push('<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.nextPage();">»</a></li>'),s.html(t.join(""))},t.prototype.show=function(e,t){if(e!=r){0<r&&s.find(".page-"+r).removeClass("active"),s.find(".page-"+e).addClass("active"),r=e,l.empty();for(var a=0;a<t.length;++a){var i=t[a],n=i.getContext(),o=i.getAppendix(),n=['<tr data-target="',a,'">',"<td>",10*(e-1)+(a+1),"</td>",'<td><img class="table-avatar" src="',n.avatar,'" /></td>',"<td>",i.getName(),"</td>",'<td class="text-muted">',o.hasRemarkName()?o.getRemarkName():"","</td>","<td>",i.getId(),"</td>","<td>",n.region,"</td>","<td>",n.department,"</td>",'<td class="text-right">','<a class="btn btn-primary btn-sm" href="javascript:app.contactsCtrl.goToMessaging(',a,');"><i class="fas fa-comments"></i> 发消息</a>','<a class="btn btn-info btn-sm" href="javascript:app.contactsCtrl.editRemark(',a,');" style="margin-left:8px;"><i class="fas fa-pencil-alt"></i> 备注</a>',"</td>","</tr>"];l.append($(n.join("")))}}},t.prototype.prevPage=function(){1!=r&&this.showPage(r-1)},t.prototype.nextPage=function(){r!=o&&this.showPage(r+1)},t.prototype.modifyRemark=function(e,t){this.modifyCell(e,3,t)},t.prototype.modifyCell=function(e,t,a){l.find('tr[data-target="'+e+'"]').find("td").eq(t).text(a)},e.ContactsTable=t}(window),function(e){"use strict";function t(e){a=e.find(".table"),o=a.find("tbody"),l=e.find(".pagination")}var a=null,o=null,l=null,i=[],n=null,s=1,r=0;t.prototype.getCurrentContact=function(e){return n[e]},t.prototype.update=function(e){(i=e).sort(function(e,t){return e.getName().localeCompare(t.getName())}),n=[];for(var t=0;t<10&&t<i.length;++t)n.push(i[t]);r=Math.ceil(i.length/10),this.paging(r),s=0,this.show(1,n)},t.prototype.showPage=function(e){if(s!=e&&!(e<1||r<e)){n=[];for(var t=10*(e-1);t<i.length&&n.length<10;++t)n.push(i[t]);this.show(e,n)}},t.prototype.paging=function(e){for(var t=['<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.prevPage();">«</a></li>'],a=1;a<=e;++a)t.push('<li class="page-item page-'+a+'"><a class="page-link" href="javascript:app.contactsCtrl.showPage('+a+');">'+a+"</a></li>");t.push('<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.nextPage();">»</a></li>'),l.html(t.join(""))},t.prototype.show=function(e,t){if(e!=s){0<s&&l.find(".page-"+s).removeClass("active"),l.find(".page-"+e).addClass("active"),s=e,o.empty();for(var a=0;a<t.length;++a){var i=t[a],n=i.getAppendix();i.tableSN=a,i.listMembers(function(e,t){var a=4,i=8,n=['<ul class="list-inline">'];e.some(function(e){var t=e.getContext(),t=(t=null==t?(e=app.queryContact(e.getId())).getContext():t).avatar;if(n.push('<li class="list-inline-item">'),n.push('<img title="'+e.getPriorityName()+'" class="table-avatar" src="'+t+'" />'),n.push("</li>"),--a,0==--i)return!0;0==a&&(n.push('</ul><ul class="list-inline">'),a=4)}),n.push("</ul>"),o.find('tr[data-target="'+t.tableSN+'"]').find(".members").html(n.join(""))});n=['<tr data-target="',a,'">',"<td>",10*(e-1)+(a+1),"</td>",'<td><img class="table-avatar" src="',"images/group-avatar.png",'" /></td>',"<td>",i.getName(),"</td>",'<td class="text-muted">',n.hasRemark()?n.getRemark():"","</td>","<td>",i.getId(),"</td>","<td>",n.getNotice(),"</td>",'<td class="members">',"</td>",'<td class="text-right">','<a class="btn btn-primary btn-sm" href="javascript:app.contactsCtrl.goToMessaging(',a,');"><i class="fas fa-comments"></i> 发消息</a>','<a class="btn btn-info btn-sm" href="javascript:app.contactsCtrl.editRemark(',a,');" style="margin-left:8px;"><i class="fas fa-pencil-alt"></i> 备注</a>',"</td>","</tr>"];o.append($(n.join("")))}}},t.prototype.prevPage=function(){1!=s&&this.showPage(s-1)},t.prototype.nextPage=function(){s!=r&&this.showPage(s+1)},t.prototype.modifyRemark=function(e,t){this.modifyCell(e,3,t)},t.prototype.modifyCell=function(e,t,a){o.find('tr[data-target="'+e+'"]').find("td").eq(t).text(a)},e.GroupsTable=t}(window),function(o){"use strict";var t,a=[],i=[],l=null,n=null,s=null,r=0,c=0;function d(e){s="contacts-tabs-groups-tab"==e.target.id?n:l}function e(e){t=this,$("#contacts-tabs-tab").on("show.bs.tab",d),l=new ContactsTable($('div[data-target="contacts-table"]')),n=new GroupsTable($('div[data-target="groups-table"]')),$(".contacts-card").find('button[data-target="new-group"]').on("click",function(){o.app.newGroupDialog.show()}),$(".contacts-card").find('button[data-target="refresh"]').on("click",function(){t.update()}),s=l}e.prototype.addContact=function(e){a.push(e),0<r&&clearTimeout(r),r=setTimeout(function(){clearTimeout(r),r=0,l.update(a)},1e3)},e.prototype.addGroup=function(e){i.push(e),0<c&&clearTimeout(c),c=setTimeout(function(){clearTimeout(c),c=0,n.update(i)},1e3)},e.prototype.goToMessaging=function(e){var t=s.getCurrentContact(e);void 0!==t&&(app.toggle("messaging","tab_messaging"),setTimeout(function(){app.messagingCtrl.toggle(t.getId())},100))},e.prototype.editRemark=function(i){var n;s!=l||void 0!==(n=l.getCurrentContact(i))&&o.dialog.showPrompt("备注联系人","请填写联系人“"+n.getName()+"”的备注：",function(e,t){if(e){var a=t.trim();if(0==a.length)return o.dialog.launchToast(o.Toast.Warning,"请正确填写联系人备注"),!1;n.getAppendix().updateRemarkName(a,function(){l.modifyRemark(i,a)})}})},e.prototype.showPage=function(e){s.showPage(e)},e.prototype.prevPage=function(){s.prevPage()},e.prototype.nextPage=function(){s.nextPage()},e.prototype.update=function(){l.update(a),n.update(i)},o.ContactsController=e}(window),function(p){"use strict";function e(e){this.container=e,this.timelineEl=e.find(".timeline")}e.prototype.update=function(e){if(this.timelineEl.empty(),0<e.length){this.container.find(".no-conference").css("display","none");for(var t=Date.now(),a=0;a<e.length;++a){var i=e[a],n=new Date(i.scheduleTime),o=new Date(i.expireTime),l=null,s=[];t>=i.scheduleTime&&t<=i.expireTime?(l="bg-red",s.push('<button class="btn btn-success btn-sm" onclick="javascript:;">进入会议</button>'),i.getFounder().getId()==app.getSelf().getId()&&s.push('<button class="btn btn-danger btn-sm">结束会议</button>')):t>i.expireTime?(l="bg-green",s.push('<button class="btn btn-default btn-sm" onclick="javascript:;">查看会议记录</button>')):(l="bg-blue",s.push('<button class="btn btn-success btn-sm" onclick="javascript:;">进入会议</button>'),i.getFounder().getId()==app.getSelf().getId()&&s.push('<button class="btn btn-danger btn-sm" onclick="javascript:;">取消会议</button>'));var r=i.hasPassword()?'<i class="fas fa-lock" title="会议已设置密码"></i>':'<i class="fas fa-unlock" title="会议无密码"></i>',c=i.getInvitees(),d=[];c.forEach(function(e){var t=app.queryContact(e.id),a=null,a=null!=t?['<div class="participant" data="',t.getId(),'">','<div class="avatar"><img src="',t.getContext().avatar,'"></div>','<div class="name"><div>',t.getName(),"</div></div>","</div>"]:['<div class="participant" data="',e.id,'">','<div class="avatar"><img src="',"images/favicon.png",'"></div>','<div class="name"><div>',e.displayName,"</div></div>","</div>"];d.push(a.join(""))});s=['<div class="time-label">','<span class="bg-blue">',n.getMonth()+1,"月",n.getDate(),"日</span>","</div>","<div>",'<i class="fas fa-users ',l,'"></i>','<div class="timeline-item">','<span class="time">',r,'&nbsp;&nbsp;<i class="fas fa-clock"></i> ',p.formatNumber(n.getHours()),":",p.formatNumber(n.getMinutes())," - ",p.formatNumber(o.getHours()),":",p.formatNumber(o.getMinutes()),"</span>",'<h3 class="timeline-header">',i.subject,"</h3>",'<div class="timeline-body">',"<p>",0==i.summary.length?'<i class="text-muted" style="font-size:12px;">无会议描述信息</i>':i.summary,"</p>",'<div class="invitees">',d.join(""),"</div>","</div>",'<div class="timeline-footer">',s.join(""),"</div>","</div>","</div>"];this.timelineEl.append($(s.join("")))}this.timelineEl.append($('<div><i class="fas fa-clock bg-gray"></i></div>'))}else this.container.find(".no-conference").css("display","table")},p.ConferenceTimeline=e}(window),function(s){"use strict";var r=null,c=null,d=null,p=null,u=null,g=null;function e(e){var t=g;t.find('input[name="conf-subject"]').val(""),t.find('input[name="conf-pwd"]').val(""),t.find('textarea[name="conf-summary"]').val("");var a=new Date,i=(i=a.getMinutes())<=15?15:15<i&&i<=30?30:30<i&&i<=45?45:0;a.setMinutes(i),0==i&&a.setHours(a.getHours()+1);var i=a.getMinutes()+30;60<=i?(a.setHours(a.getHours()+1),a.setMinutes(0)):a.setMinutes(i),t.find('input[name="conf-schedule"]').val(s.datetimePickerToString(a)),t.find("div.participant").each(function(){$(this).remove()}),t.find(".overlay").css("visibility","hidden"),t.modal("show")}function t(e){s.app.selectContactsDialog.show(function(e){var a=g.find("#conf-participant");e.forEach(function(e,t){e=['<div class="participant" data="',e.getId(),'">','<div class="avatar">','<img src="',e.getContext().avatar,'" />',"</div>",'<div class="name">',"<div>",e.getPriorityName(),"</div>","</div>",'<a href="javascript:app.confCtrl.removeParticipantInNewDialog(',e.getId(),');"><span class="badge badge-danger">&times;</span></a>',"</div>"];a.append($(e.join("")))})},f())}function f(){var t=[];return g.find("div.participant").each(function(){var e=$(this).attr("data");t.push(parseInt(e))}),t}function a(){var e,t,a,i,n,o=g.find('input[name="conf-subject"]'),l=o.val().trim();l.length<3?s.validate(o,"请填写会议主题，会议主题不能少于3个字符。"):(e=(o=g.find('input[name="conf-pwd"]')).val().trim(),t=(o=g.find('textarea[name="conf-summary"]')).val().trim(),(i=(o=g.find('input[name="conf-schedule"]')).val().trim()).length<=10?s.validate(o):(a=s.datetimePickerToDate(i).getTime(),o=(o=g.find('select[name="conf-duration"]')).find(":selected"),i=a+60*parseInt(o.attr("data"))*60*1e3,o=f(),n=[],o.forEach(function(e){e=app.queryContact(e);n.push(new Invitation(e.getId(),e.getName(),e.getPriorityName()))}),g.find(".overlay").css("visibility","visible"),r.cs.createConference(l,e,t,a,i,n,function(e){g.modal("hide"),s.dialog.showAlert("会议“<b>"+e.subject+"</b>”已创建，计划开始时间是<b>"+s.formatFullTime(e.scheduleTime)+"</b>。"),setTimeout(function(){app.confCtrl.ready()},1e3)},function(e){g.modal("hide"),s.dialog.showAlert("创建会议失败，请稍后再试！错误码："+e.code)})))}function i(e){r=e,this.init()}i.prototype.init=function(){c=new ConferenceTimeline($("#conf-timeline-all")),d=new ConferenceTimeline($("#conf-timeline-active")),p=new ConferenceTimeline($("#conf-timeline-scheme")),u=new ConferenceTimeline($("#conf-timeline-closed")),$('button[data-toggle="new-conference"]').on("click",e),(g=$("#new_conference_dialog")).find("#datetimepicker-schedule").datetimepicker({locale:"zh-cn",stepping:5}),g.find("#conf-participant button").on("click",t),g.find('button[data-target="confirm"]').on("click",a)},i.prototype.ready=function(){var l=Date.now();r.cs.listConferences(l-2592e6,l,function(e,t,a){c.update(e);var i=[],n=[],o=[];e.forEach(function(e){l<e.scheduleTime?n.push(e):l>=e.scheduleTime&&l<=e.expireTime?i.push(e):l>e.expireTime&&o.push(e)}),d.update(i),p.update(n),u.update(o)},function(e){console.log(e)})},i.prototype.removeParticipantInNewDialog=function(e){g.find("#conf-participant").find('div[data="'+e+'"]').remove()},i.prototype.fireNewConference=function(){e()},s.ConferenceController=i}(window),function(e){"use strict";var a=null,c=null,d=null,p=!1;function t(){var a;d&&(a=[],p&&c.find(".selected-table").find('input[type="checkbox"]').each(function(e,t){a.push(app.queryContact(parseInt(t.getAttribute("data"))))}),d(a)),c.find(".selected-table").empty()}function u(){var e=$(this),t=app.queryContact(parseInt(e.attr("data")));e[0].checked?a.append(t):a.remove(t)}function i(){var e=$(this),t=app.queryContact(parseInt(e.attr("data")));e[0].checked||a.remove(t)}function n(){p=!0,c.modal("hide")}function o(e){a=this,(c=$("#select_contacts_dialog")).on("hidden.bs.modal",t),c.find('button[data-target="confirm"]').on("click",n)}o.prototype.show=function(e,t){d=e,p=!1;var a=c.find("#select-contact-tabs-default div");a.empty();for(var i=app.getMyContacts(),n=0;n<i.length;++n){var o=i[n],l=o.getId(),s=o.getContext().avatar,r=o.getPriorityName(),o=0<=t.indexOf(l);a.append($(['<div class="form-group"><div class="custom-control custom-checkbox select-group-member">','<input class="custom-control-input" type="checkbox" id="contact_',n,'" data="',l,'" ',o?'disabled="disabled"':""," />",'<label class="custom-control-label" for="contact_',n,'">','<img src="',s,'" />',"<span>",r,"</span>","</label>","</div></div>"].join("")))}c.modal("show"),a.find('input[type="checkbox"]').change(u)},o.prototype.append=function(e){var t=e.getId(),e=['<tr id="selected_tr_',t,'">','<td class="text-center pl-3" width="40">','<div class="custom-control custom-checkbox">','<input class="custom-control-input" type="checkbox" id="selected_',t,'" data="',t,'" checked="">','<label for="selected_',t,'" class="custom-control-label">&nbsp;</label>',"</div>","</td>",'<td width="50">','<img src="',e.getContext().avatar,'" class="avatar" />',"</td>","<td>",e.getPriorityName(),"</td>","</tr>"],e=$(e.join(""));c.find(".selected-table").append(e),e.find('input[type="checkbox"]').change(i)},o.prototype.remove=function(e){c.find(".selected-table").find("#selected_tr_"+e.getId()).remove()},e.SelectContactsDialog=o}(window);
//# sourceMappingURL=components-min.js.map