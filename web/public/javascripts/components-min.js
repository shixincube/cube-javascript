!function(e){e.helper=e.helper||{},e.helper.getAvatarImage=function(e){return e.startsWith("avatar")?"avatars/"+e+(e.endsWith("png")?"":".png"):"avatars/default.png"},e.helper.matchFileIcon=function(e){e=e.getFileType();return"png"==e||"jpeg"==e||"gif"==e||"jpg"==e||"bmp"==e?'<i class="ci ci-file-image"></i>':"xls"==e||"xlsx"==e?'<i class="ci ci-file-excel"></i>':"ppt"==e||"pptx"==e?'<i class="ci ci-file-powerpoint"></i>':"doc"==e||"docx"==e?'<i class="ci ci-file-word"></i>':"mp3"==e||"ogg"==e||"wav"==e?'<i class="ci ci-file-music"></i>':"pdf"==e?'<i class="ci ci-file-pdf"></i>':"rar"==e?'<i class="ci ci-file-rar"></i>':"zip"==e||"gz"==e?'<i class="ci ci-file-zip"></i>':"txt"==e||"log"==e?'<i class="ci ci-file-text"></i>':"mp4"==e||"mkv"==e||"avi"==e||"ts"==e?'<i class="ci ci-file-video"></i>':"psd"==e?'<i class="ci ci-file-psd"></i>':"exe"==e||"dll"==e?'<i class="ci ci-file-windows"></i>':"apk"==e?'<i class="ci ci-file-apk"></i>':"dmg"==e?'<i class="ci ci-file-dmg"></i>':"ipa"==e?'<i class="ci ci-file-ipa"></i>':'<i class="fa fa-file-alt ci-fa-file"></i>'},e.helper.matchFileAvatar=function(e){e=e.getFileType();return"png"==e||"jpeg"==e||"gif"==e||"jpg"==e||"bmp"==e?"images/icon/file-avatar-image.png":"xls"==e||"xlsx"==e?"images/icon/file-avatar-excel.png":"ppt"==e||"pptx"==e?"images/icon/file-avatar-powerpoint.png":"doc"==e||"docx"==e?"images/icon/file-avatar-word.png":"mp3"==e||"ogg"==e||"wav"==e?"images/icon/file-avatar-music.png":"pdf"==e?"images/icon/file-avatar-pdf.png":"rar"==e?"images/icon/file-avatar-rar.png":"zip"==e||"gz"==e?"images/icon/file-avatar-zip.png":"txt"==e||"log"==e?"images/icon/file-avatar-txt.png":"mp4"==e||"mkv"==e||"avi"==e||"ts"==e?"images/icon/file-avatar-video.png":"psd"==e?"images/icon/file-avatar-psd.png":"exe"==e||"dll"==e?"images/icon/file-avatar-windows.png":"apk"==e?"images/icon/file-avatar-apk.png":"dmg"==e?"images/icon/file-avatar-dmg.png":"images/icon/file-avatar-unknown.png"};var n={iPhone:/iPhone/,iPad:/iPad/,Android:/Android/,Windows:/Windows/,Mac:/Macintosh/};e.helper.parseUserAgent=function(e){const t={browserName:"",browserVersion:"",osName:"",osVersion:"",coreName:"",coreVersion:"",deviceName:""};var a,i;for(i in/Trident/.test(e)?(t.coreName="Trident",t.coreVersion=e.split("Trident/")[1].split(";")[0]):/Firefox/.test(e)&&(t.coreName="Firefox",t.coreVersion=e.split("Firefox/")[1],t.browserName=t.coreName,t.browserVersion=t.coreVersion),/WeChat/.test(e)||/MicroMessenger/.test(e)?(t.browserName="WeChat",1<(a=e.split("MicroMessenger/")).length?t.browserVersion=a[1].split(" ")[0]:t.browserVersion=e.split("Version/")[1].split(" ")[0]):/MetaSr/.test(e)?(t.browserName="Sougou",t.browserVersion=e.split("MetaSr")[1].split(" ")[1]):/QQBrowser/.test(e)?(t.browserName="QQBrowser",t.browserVersion=e.split("QQBrowser/")[1].split(";")[0]):/MSIE/.test(e)?(t.browserName="MSIE",t.browserVersion=e.split("MSIE ")[1].split(" ")[1]):/Edge/.test(e)?(t.browserName="Edge",t.browserVersion=e.split("Edge/")[1]):/Presto/.test(e)?(t.browserName="Opera",t.browserVersion=e.split("Version/")[1]):/Version\/([\d.]+).*Safari/.test(e)?(t.browserName="Safari",t.browserVersion=e.split("Version/")[1].split(" ")[0]):/Chrome/.test(e)&&(t.browserName="Chrome",t.browserVersion=e.split("Chrome/")[1].split(" ")[0]),0==t.coreName.length&&/Chrome/.test(e)&&(t.coreName="Chrome",t.coreVersion=e.split("Chrome/")[1].split(" ")[0]),n)n[i].test(e)&&("Windows"===(t.osName=i)?(t.osVersion=e.split("Windows NT ")[1].split(";")[0],0<t.osVersion.indexOf(")")&&(t.osVersion=e.split("Windows NT ")[1].split(")")[0])):"Mac"===i?(t.osVersion=e.split("Mac OS X ")[1].split(";")[0],0<t.osVersion.indexOf(")")&&(t.osVersion=e.split("Mac OS X ")[1].split(")")[0],t.osVersion=t.osVersion.replaceAll("_","."))):"iPhone"===i?(t.osVersion=e.split("iPhone OS ")[1].split(" ")[0],t.osVersion=t.osVersion.replaceAll("_",".")):"iPad"===i?t.osVersion=e.split("iPad; CPU OS ")[1].split(" ")[0]:"Android"===i&&(t.osVersion=e.split("Android ")[1].split(";")[0],t.deviceName=e.split("(Linux; Android ")[1].split("; ")[1].split(" Build")[0]));return t}}(window),function(i){var n={Success:"success",Info:"info",Error:"error",Warning:"warning",Question:"question"},o=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}),l=Swal.mixin({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3}),s=function(){},r=function(){},c=null,d=null,p=!1,u=0,g=!1,e={getFullHeight:function(){return parseInt(document.body.clientHeight)+57+8},launchToast:function(e,t,a){(a?l:o).fire({icon:e,title:t})},toast:function(e,t,a){void 0!==t?i.dialog.launchToast(t,e,a):i.dialog.launchToast(n.Info,e,a)},showPrompt:function(e,t,a,i){var n=$("#modal_prompt");n.find(".modal-title").text(e),n.find(".prompt-label").text(t),i?n.find(".prompt-input").val(i):n.find(".prompt-input").val(""),s=a,n.modal()},closePrompt:function(e){var t,a=$("#modal_prompt");e?void 0!==(t=s(e,a.find(".prompt-input").val()))&&!t||a.modal("hide"):s(e,a.find(".prompt-input").val())},hidePrompt:function(e){void 0!==e?this.closePrompt(e):$("#modal_prompt").modal("hide")},showConfirm:function(e,t,a,i){var n=$("#modal_confirm");n.find(".modal-title").text(e),n.find(".modal-body").html("<p>"+t+"</p>"),n.find(".btn-primary").text(i||"确定"),r=a,n.modal()},closeConfirm:function(e){r(e)},hideConfirm:function(e){this.closeConfirm(e)},showAlert:function(e,t,a){var i=$("#modal_alert");i.find(".modal-body").html("<p>"+e+"</p>"),a?i.find("button.alert-confirm-button").text(a):i.find("button.alert-confirm-button").text("我知道了"),c=void 0===t?null:t,i.modal()},closeAlert:function(){null!=c&&(c(),c=null),$("#modal_alert").modal("hide")},hideAlert:function(){this.closeAlert()},showLoading:function(e,t){if(!g){g=!0,void 0===t&&(t=8e3);var a=0;null==d&&((d=$("#modal_loading")).on("hidden.bs.modal",function(){p=!1,0!=u&&(clearInterval(u),u=0),0!=a&&(clearTimeout(a),a=0),g=!1}),d.on("shown.bs.modal",function(){p=!0}));var i=d;i.find(".modal-title").html(e+"&hellip;");var n=i.find(".modal-elapsed-time");n.text("0 秒");var o=0;return u=setInterval(function(){++o,n.text(o+" 秒"),t<1e3*o&&(0!=u&&(clearInterval(u),u=0),0!=a&&(clearTimeout(a),a=0,i.modal("hide")))},1e3),i.modal({keyboard:!1,backdrop:"static"}),a=setTimeout(function(){clearInterval(u),u=0,clearTimeout(a),a=0,i.modal("hide")},t),i}},hideLoading:function(){0!=u&&(clearInterval(u),u=0),(null!=d?d:$("#modal_loading")).modal("hide"),p||setTimeout(function(){p?i.dialog.hideLoading():setTimeout(function(){i.dialog.hideLoading()},500)},500)},showImage:function(e){i.cube().fileStorage.getFileURL(e,function(e,t,a){!function(e){var t=new Image;t.src=e;var a=new Viewer(t,{hidden:function(){a.destroy()}});a.show()}(i.cube().fileStorage.secure?a:t)})},showImages:function(e,n){var o=document.createElement("div"),l=e.length,s=i.cube().fileStorage.secure;e.forEach(function(e){i.cube().fileStorage.getFileURL(e,function(e,t,a){var i,a=s?a:t,t=new Image;t.src=a,o.appendChild(t),0==--l&&(i=new Viewer(o,{initialViewIndex:void 0!==n?n:0,hidden:function(){i.destroy()}})).show()})})},downloadFile:function(e){i.cube().fileStorage.downloadFile(e)}};i.dialog=e,i.Toast=n}(window),function(t){function e(){var e=$("body");n=e.find('a[data-widget="pushmenu"]'),$(document).on("shown.lte.pushmenu",function(){o=!1,t.app.saveConfig("sidebarCollapse",o)}),$(document).on("collapsed.lte.pushmenu",function(){o=!0,t.app.saveConfig("sidebarCollapse",o)}),$(".main-sidebar").on("mouseleave",function(){o&&(0<l||(l=setTimeout(function(){clearTimeout(l),l=0,$(".main-sidebar").removeClass("sidebar-focused")},100)))})}var a="messaging",i="tab_messaging",n=null,o=!1,l=0,s=null,r=null;e.prototype.prepare=function(){var e=t.app.loadConfig("sidebarCollapse");null!=e&&void 0!==e&&(o=e)&&n.PushMenu("collapse"),s=$('audio[data-target="call-ring"]')[0],r=$('audio[data-target="waiting-tone"]')[0]},e.prototype.toggle=function(e){var t;a!=e&&(t="tab_"+e,$("#"+a).addClass("content-wrapper-hidden"),$("#"+e).removeClass("content-wrapper-hidden"),a=e,$("#"+i).removeClass("active"),$("#"+t).addClass("active"),i=t,"messaging"==e?$(".main-title").text("消息"):"files"==e?$(".main-title").text("文件"):"conference"==e?$(".main-title").text("会议"):"contacts"==e&&$(".main-title").text("联系人"))},e.prototype.hide=function(e){$("#"+("tab_"+e)).parent().css("display","none"),$("#"+e).removeClass("content-wrapper-hidden"),$("#"+e).addClass("content-wrapper-hidden")},e.prototype.playCallRing=function(){s.volume=1,s.paused&&(s.removeAttribute("muted"),s.play())},e.prototype.stopCallRing=function(){s.pause(),s.setAttribute("muted","muted")},e.prototype.playWaitingTone=function(){r.volume=1,r.paused&&(r.removeAttribute("muted"),r.play())},e.prototype.stopWaitingTone=function(){r.pause(),r.setAttribute("muted","muted")},t.MainPanel=e}(window),function(n){var a=null,i=null,o=null,l=0,s=null,r=null;function t(){0<l&&(clearTimeout(l),l=0)}function c(){0<l||(l=setTimeout(function(){a.hide()},500))}function d(){$(this).next().css("display","block")}function p(){$(this).next().css("display","none")}function u(){var e=$(this),t={code:e.text().codePointAt(0).toString(16),desc:e.next().text()};r(t),e.hasClass("recent-emoji")||a.appendRecent(t)}function e(e){a=this,r=e,(i=$(".emoji-panel")).on("mouseover",t),i.on("mouseout",c),i.blur(blur),i.find(".emoji").on("mouseover",d),i.find(".emoji").on("mouseout",p),i.find(".emoji").click(u),o=i.find(".recent"),setTimeout(function(){a.loadRecent()},1e3)}e.prototype.show=function(e){var t=n.getElementLeft(e[0]),e=n.getElementTop(e[0]);e-=338,i.css("left",t+"px"),i.css("top",e+"px"),i.css("display","block"),0<l&&(clearTimeout(l),l=0)},e.prototype.hide=function(){i.css("display","none")},e.prototype.tryHide=function(){0<l&&(clearTimeout(l),l=0),l=setTimeout(function(){a.hide()},500)},e.prototype.loadRecent=function(){if(null!=(s=n.app.loadConfig("recentEmoji")))for(var e=0;e<s.length;++e){var t=s[e],a=o.find(".recent-"+e);a.find(".emoji").html("&#x"+t.code+";"),a.find(".emoji-desc").html(t.desc),a.css("visibility","visible")}else s=[]},e.prototype.appendRecent=function(e){for(var t=0;t<s.length;++t)if(s[t].code==e.code){s.splice(t,1);break}s.unshift(e),10<s.length&&s.pop();for(t=0;t<s.length;++t){var a=s[t];(i=o.find(".recent-"+t)).find(".emoji").html("&#x"+a.code+";"),i.find(".emoji-desc").html(a.desc),i.css("visibility","visible")}for(var i,t=s.length;t<10;++t)(i=o.find(".recent-"+t)).find(".emoji").html("&nbsp;"),i.find(".emoji-desc").html("&nbsp;"),i.css("visibility","hidden");n.app.saveConfig("recentEmoji",s)},n.EmojiPanel=e}(window),function(i){"use strict";function e(e){t=this,(n=e).find('button[data-target="file-download"]').click(function(){i.app.filePanel.downloadFile(o.getFileCode()),t.close()}),e.find('button[data-target="file-share"]').click(function(){i.app.filePanel.openCreateSharingTagDialog(o.getFileCode()),t.close()}),e.find('button[data-target="file-delete"]').click(function(){i.app.filePanel.promptDeleteFile(o.getFileName(),o.getFileCode()),t.close()})}var t,n=null,o=null;e.prototype.open=function(e,t){var a;o=e,n.find('h3[data-target="file-name"]').text(e.getFileName()),n.find('h5[data-target="file-type"]').text(e.getFileType().toUpperCase()),n.find('h5[data-target="file-size"]').text(i.formatSize(e.getFileSize())),n.find('h5[data-target="file-date"]').text(i.formatYMDHMS(e.getLastModified())),n.find(".file-type-avatar").prop("src",i.helper.matchFileAvatar(e)),t?(i.recurseParent(e=[],t),a=[],1==e.length?a.push("/"):e.forEach(function(e){e.isRoot()||a.push(e.getName()+" &gt; ")}),n.find('h5[data-target="file-path"]').html(a.join(""))):n.find('h5[data-target="file-path"]').text("--"),n.modal("show")},e.prototype.close=function(){n.modal("hide")},i.FileDetails=e}(window),function(o){"use strict";var i=null,l=null,t=null,s=null,r={page:0,total:0,numEachPage:15,totalPage:0},n=!1,c=null;function d(e){return"View"==e?'<span class="text-primary">查看</span>':"Extract"==e?'<span class="text-success">下载</span>':"Share"==e?'<span class="text-danger">分享</span>':e}function p(e){return e==VisitTrace.PlatformBrowser?"浏览器":e==VisitTrace.PlatformAppletWeChat?"微信小程序":"未知"}function e(e){t=(l=e).find(".trace-tb"),i=this,s=e.find(".pagination"),l.on("hidden.bs.modal",function(e){s.find(".page-goto").remove()})}e.prototype.open=function(e){c=e,l.modal("show"),l.find(".overlay").css("visibility","visible");var a=setTimeout(function(){o.dialog.toast("数据超时"),i.close(),n=!1},1e4);n=!0;var t=r.page*r.numEachPage,e=t+r.numEachPage-1;o.engine.fs.listVisitTraces(c,t,e,function(e,t){clearTimeout(a),l.find(".overlay").css("visibility","hidden"),r.total=t,i.updateTable(e),i.updatePagination(),n=!1},function(e){n=!1,clearTimeout(a),o.dialog.toast("加载数据出错："+e.code),i.close()})},e.prototype.close=function(){l.find(".overlay").css("visibility","hidden"),l.modal("hide")},e.prototype.updateTable=function(e){var a=[],i=[],n=r.page*r.numEachPage+1;e.forEach(function(e){var t=function(e,t){if(null==t.userAgent)return null==t.agent?["<tr>","<td>","</td>","<td>","</td>","<td>","</td>","<td>","</td>","<td>","</td>","<td>","</td>","<td>","</td>","<td>","</td>","</tr>"]:(a=t.agent,["<tr>","<td>",e,"</td>","<td>",o.formatYMDHMS(t.time),"</td>",'<td data-target="',t.contactId,'"><i class="text-muted text-xs">未知</i>',"</td>","<td>",t.address,"</td>","<td>",a.model+" / "+a.osVersion,"</td>","<td>",a.hostName+" / "+a.hostVersion,"</td>","<td>",d(t.event),"</td>","<td>",p(t.platform),"</td>","</tr>"]);var a=o.helper.parseUserAgent(t.userAgent);return["<tr>","<td>",e,"</td>","<td>",o.formatYMDHMS(t.time),"</td>",'<td data-target="',t.contactId,'"><i class="text-muted text-xs">未知</i>',"</td>","<td>",t.address,"</td>","<td>",a.osName+" / "+a.osVersion,"</td>","<td>",a.browserName+" / "+a.browserVersion,"</td>","<td>",d(t.event),"</td>","<td>",p(t.platform),"</td>","</tr>"]}(n,e);a=a.concat(t),++n,0<e.contactId&&!i.contains(e.contactId)&&i.push(e.contactId)}),t[0].innerHTML=a.join(""),i.forEach(function(t){o.app.getContact(t,function(e){l.find('td[data-target="'+t+'"]').text(e.getPriorityName())})})},e.prototype.updatePagination=function(){var e=r.total,t=s.find(".page-prev"),a=Math.floor(e/r.numEachPage);0!=e%r.numEachPage&&(a+=1),r.totalPage=a;for(var i=[],n=0;n<a;++n){var o=n+1;i.push('<li class="page-item page-goto'),n==r.page&&i.push(" page-active"),i.push('" data-target="'),i.push(o),i.push('">'),i.push('<a class="page-link" href="javascript:app.visitTraceDialog.gotoPage('),i.push(o),i.push(');">'),i.push(o),i.push("</a></li>")}t.after($(i.join("")))},e.prototype.gotoPage=function(e){var t=e-1;r.page!=t&&(n||(n=!0,s.find(".page-active").removeClass("page-active"),s.find('li[data-target="'+e+'"]').addClass("page-active"),r.page=t,t=(e=r.page*r.numEachPage)+r.numEachPage-1,o.engine.fs.listVisitTraces(c,e,t,function(e,t){r.total=t,i.updateTable(e),n=!1},function(e){n=!1,o.dialog.toast("加载数据出错："+e.code)})))},e.prototype.prevPage=function(){0!=r.page&&this.gotoPage(r.page-1+1)},e.prototype.nextPage=function(){r.page+1>=r.totalPage||this.gotoPage(r.page+1+1)},o.VisitTraceListDialog=e}(window),function(t){"use strict";function e(e){this.el=e;var t=this;this.el.find('a[data-target="name"]').on("click",function(){t.showDetail()})}e.prototype.updateAvatar=function(e){this.el.find('img[data-target="avatar"]').attr("src",t.helper.getAvatarImage(e))},e.prototype.updateName=function(e){this.el.find('a[data-target="name"]').text(e)},e.prototype.showDetail=function(){},t.SidebarAccountPanel=e}(window),function(g){"use strict";function l(e,t){return 0==t.time&&0==e.time?t.label.localeCompare(e.label):t.time-e.time}function e(e){this.el=e.find('ul[data-target="catalogue"]'),this.noMsgEl=e.find(".no-message"),this.items=[],this.topItems=[],this.currentItem=null}e.prototype.getActiveItem=function(){return this.currentItem},e.prototype.getItem=function(e){for(var t=parseInt(e),a=0;a<this.items.length;++a){var i=this.items[a];if(i.id==t)return i}return null},e.prototype.getEntityList=function(){var t=[];return this.items.forEach(function(e){t.push(e.entity)}),t},e.prototype.appendItem=function(e,t){var a=this.items.length,i=0,n=null,o="images/group-avatar.png",l=null,s=null,r=null,c=0;if(e instanceof Group?(i=e.getId(),l=e.getName(),s="　",r=formatShortTime(e.getLastActiveTime()),c=e.getLastActiveTime()):e instanceof Contact?(i=e.getId(),o=g.helper.getAvatarImage(e.getContext().avatar),l=e.getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():e.getContext().name,s="　",r=""):"object"==typeof e&&(i=e.id,o="images/"+e.avatar,l=e.name,s="　",r=""),null==l||null==l)return!1;if(null!=(d=this.getItem(i)))return!1;this.noMsgEl.css("display","none");var d={index:a,id:i,el:n,entity:e,thumb:o,label:l,desc:s,lastDesc:"　",timeBadge:r,time:c,top:!1},n=$(['<li id="mc_item_',a,'" class="item pl-2 pr-2" data="',i,'">','<div class="item-img" style="background-image:url(',o,');">','<div class="item-state">',"</div>",'<div class="item-top"><div class="top-action" onclick="app.messageCatalog.topItem(',i,');">','<i class="fas fa-sort-up"></i><div>置顶</div>',"</div></div>",'<span class="badge badge-danger unread-badge"></span>','<div class="top-wrapper">','<div class="top text-primary"><i class="fas fa-caret-up"></i></div>',"</div>","</div>",'<div class="product-info ellipsis">','<span class="product-title ellipsis">','<span class="title">',l,"</span>",'<span class="badge badge-light float-right last-time">',r,"</span>","</span>",'<span class="product-description">',s,"</span>",'<div class="item-close">','<a href="javascript:;" onclick="app.messageCatalog.onItemClose(',i,');"><span class="badge badge-light"><i class="fas fa-times"></i></span></a>',"</div>","</div>","</li>"].join(""));if(d.el=n,t){if(0==this.items.length)this.el.append(n);else for(var p=0;p<this.items.length;++p){var u=this.items[p];if(!(0<=this.topItems.indexOf(u))){u.el.before(n);break}}this.items.unshift(d)}else this.el.append(n),this.items.push(d);return this.bindEvent(n),!0},e.prototype.removeItem=function(e){for(var t=0,t=e instanceof Group||e instanceof Contact?e.getId():parseInt(e),a=null,i=0;i<this.items.length;++i){var n=this.items[i];if(n.id==t){a=n,this.items.splice(i,1);break}}0==this.items.length&&this.noMsgEl.css("display","table"),null!=this.currentItem&&t==this.currentItem.id&&(this.currentItem=null),null!=a&&a.el.remove()},e.prototype.updateItem=function(e,t,a,i){var n=0;if("number"==typeof e)n=e;else if(e instanceof Group)n=e.getId();else{if(!(e instanceof Contact))return console.log("[App] MessageCatalogue#updateItem 输入参数错误"),!1;n=e.getId()}var o=this.getItem(n);if(null==o){if(!this.appendItem(e,!0))return!1;o=this.getItem(n)}var l=o.el;if(null!=t){if(o.lastDesc=o.desc,"string"==typeof t)o.desc=0==t.length?"　":t;else if(t instanceof TextMessage)o.desc=t.getSummary();else if(t instanceof HyperTextMessage)o.desc=t.getSummary();else if(t instanceof ImageMessage)o.desc=t.getSummary();else if(t instanceof FileMessage){n=t;n.hasAttachment()?o.desc=n.getSummary():o.desc="[文件]"}else if(t instanceof CallRecordMessage)t.getConstraint().video?o.desc="[视频通话]":o.desc="[语音通话]";else{if(!(t instanceof File))return!1;o.desc="[文件] "+t.name}l.find(".product-description").html(o.desc)}null!=a&&(o.time=a,l.find(".last-time").text(formatShortTime(a))),i&&(o.label=i,l.find(".title").text(i));for(var s=0;s<this.items.length;++s)if(this.items[s]==o){this.items.splice(s,1);break}if(this.items.unshift(o),o.top){for(s=0;s<this.topItems.length;++s)if(this.topItems[s]==o){this.topItems.splice(s,1);break}this.topItems.unshift(o),l.remove(),this.el.prepend(l)}else if(l.remove(),1==this.items.length)this.el.append(l);else{for(var r=!1,s=1;s<this.items.length;++s)if(!this.items[s].top){r=!0,this.items[s].el.before(l);break}r||this.el.append(l)}return this.bindEvent(l),!0},e.prototype.topItem=function(e){var n,o=this.getItem(e);null!=o&&(n=this,o.top?g.cube().contact.removeTopList(o.entity,function(){o.top=!1,o.el.find(".top-action").html('<i class="fas fa-sort-up"></i><div>置顶</div>'),o.el.find(".top-wrapper").css("visibility","hidden");var e=n.topItems.indexOf(o);n.topItems.splice(e,1),n.items.sort(l);for(var t=[],a=0;a<n.items.length;++a){var i=n.items[a];0<=n.topItems.indexOf(i)||t.push(i)}0==(e=t.indexOf(o))&&1<t.length?(o.el.remove(),t[e+1].el.before(o.el),n.bindEvent(o.el)):0<e&&(o.el.remove(),t[e-1].el.after(o.el),n.bindEvent(o.el))}):g.cube().contact.addTopList(o.entity,function(){o.top=!0,o.el.find(".top-action").html('<i class="fas fa-sort"></i>'),o.el.find(".top-wrapper").css("visibility","visible"),n.topItems.push(o),n.topItems.sort(l);var e=n.topItems.indexOf(o);0==e?(o.el.remove(),n.el.prepend(o.el)):(o.el.remove(),n.topItems[e-1].el.after(o.el)),n.bindEvent(o.el)}))},e.prototype.restoreDesc=function(e,t){var a=0;if("number"==typeof e)a=e;else if(e instanceof Contact)a=e.getId();else{if(!(e instanceof Group))return void console.log("[App] MessageCatalogue#restoreLastDesc 输入参数错误");a=e.getId()}a=this.getItem(a);null!=a&&(a.el.find(".product-description").html(t),a.desc=t)},e.prototype.updateBadge=function(e,t){e=this.getItem(e);null!=e&&(0==t?e.el.find(".unread-badge").text(""):99<t?e.el.find(".unread-badge").text("99+"):e.el.find(".unread-badge").text(t))},e.prototype.updateState=function(e,t){e=this.getItem(e);null!=e&&(e=e.el.find(".item-state"),"video"==t?e.html('<div><i class="fas fa-video"></i></div>'):"voice"==t||"audio"==t?e.html('<div><i class="fas fa-phone-alt"></i></div>'):e.html(""))},e.prototype.refreshOrder=function(){var o=this;o.topItems=[],g.cube().contact.queryTopList(function(e){for(var t=0;t<e.length;++t){var a=o.getItem(e[t].id);null!=a&&(o.topItems.push(a),a.top=!0)}o.items.sort(l),o.topItems.sort(l);for(var i=o.topItems.concat();0<i.length;){for(var n=i.pop(),t=0;t<o.items.length;++t)if(n.id==o.items[t].id){o.items.splice(t,1);break}o.items.unshift(n),n.el.find(".top-action").html('<i class="fas fa-sort"></i>'),n.el.find(".top-wrapper").css("visibility","visible")}o.el.empty(),o.items.forEach(function(e){o.el.append(e.el),o.bindEvent(e.el)})})},e.prototype.activeItem=function(e){if(null!=this.currentItem){if(this.currentItem.id==e)return;this.currentItem.el.removeClass("catalog-active")}e=this.getItem(e);e.el.addClass("catalog-active"),this.currentItem=e},e.prototype.onItemClick=function(e){if(null!=this.currentItem){if(this.currentItem.id==e)return;this.currentItem.el.removeClass("catalog-active")}e=this.getItem(e);e.el.addClass("catalog-active"),this.currentItem=e,g.app.messagingCtrl.toggle(this.currentItem.id)},e.prototype.onItemDoubleClick=function(e){var t=g.app.queryContact(e);null==t?g.cube().contact.getGroup(e,function(e){g.app.groupDetails.show(e)}):g.app.contactDetails.show(t)},e.prototype.onItemMouseover=function(e){this.getItem(e).el.find(".item-close").css("visibility","visible")},e.prototype.onItemMouseout=function(e){this.getItem(e).el.find(".item-close").css("visibility","hidden")},e.prototype.onItemClose=function(e){var t=g.app.queryContact(e);null==t?g.cube().contact.getGroup(e,function(e){g.app.messagingCtrl.removeGroup(e)}):g.app.messagingCtrl.removeContact(t)},e.prototype.bindEvent=function(e){var a=this;e.on("click",function(e){var t=parseInt($(this).attr("data"));a.onItemClick(t)}),e.on("dblclick",function(e){var t=parseInt($(this).attr("data"));a.onItemDoubleClick(t)}),e.on("mouseenter",function(e){var t=parseInt($(this).attr("data"));a.onItemMouseover(t)}),e.on("mouseleave",function(e){var t=parseInt($(this).attr("data"));a.onItemMouseout(t)})},g.MessageCatalogue=e}(window),function(b){var c=null;function C(e){return"png"==e||"jpeg"==e||"gif"==e||"jpg"==e||"bmp"==e?'<i class="file-icon ci-wide ci-file-image-wide"></i>':"xls"==e||"xlsx"==e?'<i class="file-icon ci-wide ci-file-excel-wide"></i>':"ppt"==e||"pptx"==e?'<i class="file-icon ci-wide ci-file-powerpoint-wide"></i>':"doc"==e||"docx"==e?'<i class="file-icon ci-wide ci-file-word-wide"></i>':"mp3"==e||"ogg"==e||"wav"==e?'<i class="file-icon ci-wide ci-file-music-wide"></i>':"pdf"==e?'<i class="file-icon ci-wide ci-file-pdf-wide"></i>':"rar"==e?'<i class="file-icon ci-wide ci-file-rar-wide"></i>':"zip"==e||"gz"==e?'<i class="file-icon ci-wide ci-file-zip-wide"></i>':"txt"==e||"log"==e?'<i class="file-icon ci-wide ci-file-text-wide"></i>':"mp4"==e||"mkv"==e||"avi"==e||"ts"==e?'<i class="file-icon ci-wide ci-file-video-wide"></i>':"psd"==e?'<i class="file-icon ci-wide ci-file-psd-wide"></i>':"exe"==e||"dll"==e?'<i class="file-icon ci-wide ci-file-windows-wide"></i>':"apk"==e?'<i class="file-icon ci-wide ci-file-apk-wide"></i>':"dmg"==e?'<i class="file-icon ci-wide ci-file-dmg-wide"></i>':'<i class="file-icon ci-wide ci-file-unknown-wide"></i>'}function e(e){this.el=e,this.panels={},(c=this).current=null,this.elTitle=this.el.find(".card-title"),this.elStateBar=this.el.find(".card-header").find(".state-bar"),this.elInfoBar=this.el.find(".card-header").find(".info-bar"),this.elContent=this.el.find(".card-body"),this.inputEditor=null,this.elInput=null,this.atPanel=this.el.find(".at-someone"),this.atPanel.blur(function(e){c.onAtPanelBlur(e)}),this.atElList=[],this.formatContents=[],this.lastInput="",this.el.find("textarea").parent().remove(),$("#message-editor").parent().css("display","flex");var t=new window.wangEditor("#message-editor");t.config.menus=[],t.config.height=70,t.config.placeholder="",t.config.fontSizes={normal:"14px",value:"3"},t.config.lineHeights=["1"],t.config.onchange=function(e){c.onEditorChange(e)},t.config.pasteTextHandle=function(e){return c.handlePasteText(e)},t.create(),t.disable(),this.inputEditor=t,(t=$("#message-editor").find(".w-e-text")).keypress(function(e){c.onEditorKeypress(e)}),this.weEl=t,this.infoBarDelayTimer=0,this.elStateBar.on("mouseenter",function(){0<c.infoBarDelayTimer&&(clearTimeout(c.infoBarDelayTimer),c.infoBarDelayTimer=0),c.toggleBarInfo()}),this.elStateBar.on("mouseleave",function(){c.infoBarDelayTimer=setTimeout(function(){c.toggleBarInfo(),clearTimeout(c.infoBarDelayTimer),c.infoBarDelayTimer=0},1e3)}),this.elInfoBar.on("mouseenter",function(){0<c.infoBarDelayTimer&&(clearTimeout(c.infoBarDelayTimer),c.infoBarDelayTimer=0)}),this.elInfoBar.on("mouseleave",function(){0<c.infoBarDelayTimer&&(clearTimeout(c.infoBarDelayTimer),c.infoBarDelayTimer=0),c.toggleBarInfo()}),this.btnSend=e.find('button[data-target="send"]'),this.btnSend.attr("disabled","disabled"),this.btnSend.on("click",function(e){c.onSend(e)}),this.emojiPanel=new EmojiPanel(c.onEmojiClick),this.btnEmoji=e.find('button[data-target="emoji"]'),this.btnEmoji.attr("disabled","disabled"),this.btnEmoji.on("mouseover",function(){null!=c.current&&c.emojiPanel.show(c.btnEmoji)}),this.btnEmoji.on("mouseout",function(){null!=c.current&&c.emojiPanel.tryHide()}),this.btnSendFile=e.find('button[data-target="send-file"]'),this.btnSendFile.attr("disabled","disabled"),this.btnSendFile.on("click",function(e){b.app.messagingCtrl.selectFile($("#select_file"))}),this.btnVideoCall=e.find('button[data-target="video-call"]'),this.btnVideoCall.attr("disabled","disabled"),this.btnVideoCall.on("click",function(){b.app.messagingCtrl.openVideoChat(c.current.entity)}),this.btnVoiceCall=e.find('button[data-target="voice-call"]'),this.btnVoiceCall.attr("disabled","disabled"),this.btnVoiceCall.on("click",function(){b.app.messagingCtrl.openVoiceCall(c.current.entity)}),e.find('button[data-target="new-group"]').on("click",function(e){c.onNewGroupClick(e)}),e.find('button[data-target="details"]').on("click",function(e){c.onDetailsClick(e)}),e.find('button[data-target="collapse"]').on("click",function(e){c.onCollapseClick(e)}),this.callTimer=0,this.callStartTime=0,this.initContextMenu()}function r(e){var n=[],e=$("<div>"+e+"</div>").find("p"),o=!1;return e.each(function(){var e,t,a=$(this);if(a.hasClass("emoji"))0<n.length&&160==n[n.length-1].data.charCodeAt(0)&&n.pop(),0!=(i=a.text()).length&&(e=i.codePointAt(0).toString(16),t=a.attr("desc"),n.push({format:"emoji",data:e,desc:t}),o=!0);else if(a.hasClass("at-wrapper")){0<n.length&&160==n[n.length-1].data.charCodeAt(0)&&n.pop();var i=a.text();n.push({format:"at",data:parseInt(a.attr("data")),name:i.substring(1)}),o=!0}else{if(o){if(o=!1,160==(i=a.text()).charCodeAt(0)&&1==i.length)return;if(0<(i=i.substring(1)).length)return void n.push({format:"txt",data:i})}0!=a.text().length&&n.push({format:"txt",data:a.text()})}}),n}e.prototype.initContextMenu=function(){this.elContent.contextMenu({selector:".direct-chat-text",callback:function(e,t){var a=c.current.entity;"delete"==e?b.app.messagingCtrl.deleteMessage(a,parseInt($(this).attr("data-id"))):"recall"==e&&b.app.messagingCtrl.recallMessage(a,parseInt($(this).attr("data-id")))},items:{recall:{name:"撤回",disabled:function(e,t){return"false"==$(this).attr("data-owner")}},delete:{name:"删除",disabled:function(e,t){return!1}}}})},e.prototype.getCurrentPanel=function(){return this.current},e.prototype.getPanel=function(e){return this.panels[e.toString()]},e.prototype.hasPanel=function(e){return"number"==typeof e?void 0!==this.panels[e.toString()]:void 0!==this.panels[e.getId().toString()]},e.prototype.updatePanel=function(e,t){var a=this.panels[e.toString()];void 0===a&&(a={id:e,el:$('<div class="direct-chat-messages"><div class="more-messages"><a href="javascript:app.messagingCtrl.prependMore('+e+');">查看更多消息</a></div></div>'),entity:t,messageIds:[],messageTimes:[],unreadCount:0,groupable:t instanceof Group},this.panels[e.toString()]=a),null!=this.current&&this.current.id==e&&(this.current.entity=t,a.groupable?this.elTitle.text(t.getName()):this.elTitle.text(t.getPriorityName()),this.refreshStateBar())},e.prototype.refreshStateBar=function(){if(null==this.current)return this.elInfoBar.css("visibility","hidden"),this.elStateBar.css("visibility","hidden"),0<this.callTimer&&(clearInterval(this.callTimer),this.callTimer=0),void(this.callStartTime=0);var e=this.current.entity;e instanceof Group?e.getAppendix().getCommId(function(n){0!=n?b.cube().mpComm.getCommField(n,function(e){0<c.callTimer&&clearInterval(c.callTimer);var t=e.mediaConstraint.videoEnabled;function a(){var e;0!=c.callStartTime?(e=Date.now()-c.callStartTime,c.elStateBar.find(".timer").text(b.formatClockTick(Math.round(e/1e3)))):b.cube().mpComm.getCommField(n,function(e){c.callStartTime=e.startTime,0==c.callStartTime&&(c.callStartTime=Date.now())})}c.elStateBar.find(".col-2").html(t?'<i class="fas fa-video"></i>':'<i class="fas fa-phone-alt"></i>'),c.elStateBar.find(".participant").text(e.numEndpoints()+"/"+(t?"6":"16")),c.callStartTime=e.startTime,c.callTimer=setInterval(a,1e3),c.elStateBar.find(".timer").text("--:--:--"),a(),c.elStateBar.css("visibility","visible");t=c.elInfoBar.find(".row").eq(0);t.empty();var i=[];e.getEndpoints().forEach(function(e){e=e.contact;b.app.getContact(e.getId(),function(e){i.push('<div class="col-3"><img src="'+b.helper.getAvatarImage(e.getContext().avatar)+'" /></div>')})}),t.html(i.join(""))}):(0<c.callTimer&&(clearInterval(c.callTimer),c.callTimer=0),c.callStartTime=0,c.elStateBar.css("visibility","hidden"))}):(this.elInfoBar.css("visibility","hidden"),this.elStateBar.css("visibility","hidden"))},e.prototype.toggleBarInfo=function(){var e=this.elInfoBar;"hidden"==e.css("visibility")?e.css("visibility","visible"):e.css("visibility","hidden")},e.prototype.changePanel=function(e,t){var a=this.panels[e.toString()];void 0===a&&(a={id:e,el:$('<div class="direct-chat-messages"><div class="more-messages"><a href="javascript:app.messagingCtrl.prependMore('+e+');">查看更多消息</a></div></div>'),entity:t,messageIds:[],messageTimes:[],unreadCount:0,groupable:t instanceof Group},this.panels[e.toString()]=a),null==this.current?(this.inputEditor.enable(),this.btnEmoji.removeAttr("disabled"),this.btnSend.removeAttr("disabled"),this.btnSendFile.removeAttr("disabled"),this.btnVideoCall.removeAttr("disabled"),this.btnVoiceCall.removeAttr("disabled")):(0<(e=(e=(e=this.inputEditor.txt.text().trim()).startsWith("&nbsp;")?e.substring(6,e.length):e).endsWith("&nbsp;")?e.substring(0,e.length-6):e).length?(e=this.serializeHyperText(),e=new HyperTextMessage(e),window.cube().messaging.saveDraft(this.current.entity,e)&&b.app.messageCatalog.updateItem(this.current.id,'<span class="text-danger">[草稿] '+e.getSummary()+"</span>",null,null)):window.cube().messaging.deleteDraft(this.current.id),this.inputEditor.txt.clear(),this.current.el.remove()),this.elContent.append(a.el),(this.current=a).unreadCount=0,a.groupable?this.elTitle.text(t.getName()):this.elTitle.text(t.getAppendix().hasRemarkName()?t.getAppendix().getRemarkName():t.getName()),this.refreshStateBar();t=parseInt(this.elContent.prop("scrollHeight"));this.elContent.scrollTop(t),a.messageIds.forEach(function(e){window.cube().messaging.markRead(e)}),window.cube().messaging.loadDraft(this.current.id,function(e){a.groupable?window.cube().messaging.queryLastMessageWithGroup(a.entity.getId(),function(e){b.app.messageCatalog.restoreDesc(a.id,e.getSummary())}):window.cube().messaging.queryLastMessageWithContact(a.entity.getId(),function(e){b.app.messageCatalog.restoreDesc(a.id,e.getSummary())});e=c.deserializeHyperText(e.getMessage(),!0);c.inputEditor.txt.append(e)})},e.prototype.clearPanel=function(e){var t=this.panels[e.toString()];void 0!==t&&(t.el.remove(),this.current==t&&(this.btnEmoji.attr("disabled","disabled"),this.btnVideoCall.attr("disabled","disabled"),this.btnVoiceCall.attr("disabled","disabled"),this.btnSendFile.attr("disabled","disabled"),this.elTitle.text(""),this.inputEditor.txt.clear(),this.inputEditor.disable(),this.formatContents=[],this.lastInput="",this.current=null,this.refreshStateBar()),delete this.panels[e.toString()])},e.prototype.removeMessage=function(e,t){var a=e.getId(),e=this.panels[a.toString()];void 0!==e&&(a=t.getId(),0<=(t=e.messageIds.indexOf(a))&&(e.messageIds.splice(t,1),e.messageTimes.splice(t,1)),e.el.find("#"+a).remove())},e.prototype.appendMessage=function(e,t,a,i,n){var o=e.getId(),l=this.panels[o.toString()];void 0===l&&(l={id:o,el:$('<div class="direct-chat-messages"><div class="more-messages"><a href="javascript:app.messagingCtrl.prependMore('+o+');">查看更多消息</a></div></div>'),entity:e,messageIds:[],messageTimes:[],unreadCount:0,groupable:e instanceof Group},this.panels[o.toString()]=l);var s=a.getId(),r=a.getRemoteTimestamp(),c=l.messageIds.indexOf(s);if(0<=c)return null;if(0==l.messageIds.length)l.messageTimes.push(r),l.messageIds.push(s);else for(var d=0,p=l.messageTimes.length;d<p;++d){if(r<=l.messageTimes[d]){l.messageTimes.splice(d,0,r),l.messageIds.splice(d,0,s);break}var u=d+1<p?l.messageTimes[d+1]:null;if(null==u){l.messageTimes.push(r),l.messageIds.push(s);break}if(r<u){l.messageTimes.splice(d+1,0,r),l.messageIds.splice(d+1,0,s);break}}c=l.messageIds.indexOf(s),a.isRead()||(l.unreadCount+=1);var g=null,e=null,o=null;if(a instanceof TextMessage)e=a.getText();else if(a instanceof HyperTextMessage)e=this.deserializeHyperText(a);else if(a instanceof ImageMessage||a instanceof FileMessage)var f=null,e=(null==(o=a.getAttachment()).getFileURL()?["<div>",o.getFileName(),"<div>"]:o.isImageType()?(f=["javascript:dialog.showImage('",o.getFileCode(),"');"],['<table class="file-label" border="0" cellspacing="4" cellpodding="0">',"<tr>","<td>",'<img class="thumb" src="',o.getDefaultThumbURL(),'" onclick="',f.join(""),'"',' onload="app.messagePanel.refreshScroll()"',' alt="',o.getFileName(),'"'," />","</td>","</tr>","</table>"]):(f=['<a class="btn btn-xs btn-default" title="下载文件" href="javascript:dialog.downloadFile(\'',o.getFileCode(),"');\">",'<i class="fas fa-download"></i>',"</a>"],['<table class="file-label" border="0" cellspacing="4" cellpodding="0">',"<tr>",'<td rowspan="2" valign="middle" align="center">',C(o.getFileType()),"</td>",'<td colspan="2" class="file-name">',o.getFileName(),"</td>","</tr>","<tr>",'<td class="file-size">',formatSize(o.getFileSize()),"</td>",'<td class="file-action">',f.join(""),"</td>","</tr>","</table>"])).join("");else if(a instanceof CallRecordMessage)e=(e=["<div>",a.getConstraint().video?'<i class="fas fa-video"></i>':'<i class="fas fa-phone-alt"></i>','&nbsp;&nbsp;<span style="font-size:14px;">',0<a.getAnswerTime()?"通话时长 "+b.formatClockTick(parseInt(a.getDuration()/1e3)):a.isCaller(b.app.getSelf().getId())?"对方未接听":"未接听","</span></div>"]).join("");else{if(!(a instanceof LocalNoteMessage))return null;var m=a.getText(),h=a.getLevel(),g=1==h?['<div id="',a.getId(),'" class="note">',m,"</div>"]:2==h?['<div id="',a.getId(),'" class="note"><span class="text-warning">',m,"</span></div>"]:['<div id="',a.getId(),'" class="note"><span class="text-danger">',m,"</span></div>"]}null==g&&(o="",f="float-left",h="float-right",t.getId()==b.app.getSelf().getId()&&(o="right",f="float-right",h="float-left"),m=[],0<o.length&&(a.getState()==MessageState.Sending?m.push('<div class="direct-chat-state"><i class="fas fa-spinner sending"></i></div>'):a.getState()!=MessageState.SendBlocked&&a.getState()!=MessageState.ReceiveBlocked||m.push('<div class="direct-chat-state"><i class="fas fa-exclamation-circle fault"></i></div>')),v=void 0!==n&&n?"direct-chat-text-anim":"",g=['<div id="',s,'" class="direct-chat-msg ',o,'"><div class="direct-chat-infos clearfix">','<span class="direct-chat-name ',f,l.groupable?"":" no-display",'">',t.getPriorityName(),'</span><span class="direct-chat-timestamp ',h,'">',formatFullTime(r),"</span></div>",'<img src="',b.helper.getAvatarImage(t.getContext().avatar),'" class="direct-chat-img">',m.join(""),'<div data-id="',s,'" data-owner="',0<o.length,'" class="direct-chat-text ',v,'">',e,"</div></div>"]);var v=$(g.join("")),e=l.el;return 0==c?e.find(".more-messages").after(v):c==l.messageIds.length-1?e.append(v):(g=0<=c-1?l.messageIds[c-1]:0,c=c+1<l.messageIds.length?l.messageIds[c+1]:0,0<g?e.find("#"+g).after(v):0<c&&e.find("#"+c).before(v)),void 0!==i&&(i?(i=parseInt(this.elContent.prop("scrollHeight")),this.elContent.scrollTop(i)):this.elContent.scrollTop(0)),this.loadDraft(l),v},e.prototype.refreshMessage=function(e,t){var a,i,n=this.current.el.find("#"+t.getId());0!=n.length&&(t instanceof ImageMessage||t instanceof FileMessage)&&(attachment=t.getAttachment(),i=a=null,i=attachment.isImageType()?(a=["javascript:dialog.showImage('",attachment.getFileCode(),"');"],['<table class="file-label" border="0" cellspacing="4" cellpodding="0">',"<tr>","<td>",'<img class="thumb" src="',attachment.getDefaultThumbURL(),'" onclick="',a.join(""),'"',' onload="app.messagePanel.refreshScroll()"',' alt="',attachment.getFileName(),'"'," />","</td>","</tr>","</table>"]):(a=['<a class="btn btn-xs btn-default" title="下载文件" href="javascript:dialog.downloadFile(\'',attachment.getFileCode(),"');\">",'<i class="fas fa-download"></i>',"</a>"],['<table class="file-label" border="0" cellspacing="4" cellpodding="0">',"<tr>",'<td rowspan="2" valign="middle" align="center">',C(attachment.getFileType()),"</td>",'<td colspan="2" class="file-name">',attachment.getFileName(),"</td>","</tr>","<tr>",'<td class="file-size">',formatSize(attachment.getFileSize()),"</td>",'<td class="file-action">',a.join(""),"</td>","</tr>","</table>"]),n.find('div[data-id="'+t.getId()+'"]').html(i.join("")))},e.prototype.changeMessageState=function(e){var t=this.elContent.find("#"+e.getId()).find(".direct-chat-state");e.getState()==MessageState.Sent?t.html(""):e.getState()==MessageState.SendBlocked||e.getState()==MessageState.ReceiveBlocked?t.html('<i class="fas fa-exclamation-circle fault"></i>'):e.getState()==MessageState.Sending&&t.html('<i class="fas fa-spinner sending"></i>')},e.prototype.appendNote=function(e,t){var a="number"==typeof e?e:e.getId(),i=this.panels[a.toString()];void 0===i&&(i={id:a,el:$('<div class="direct-chat-messages"><div class="more-messages"><a href="javascript:app.messagingCtrl.prependMore('+a+');">查看更多消息</a></div></div>'),entity:e,messageIds:[],messageTimes:[],groupable:e instanceof Group},this.panels[a.toString()]=i),i.el.append($(['<div class="note">',t,"</div>"].join("")));t=parseInt(this.elContent.prop("scrollHeight"));this.elContent.scrollTop(t)},e.prototype.refreshScroll=function(){var e=parseInt(this.elContent.prop("scrollHeight"));this.elContent.scrollTop(e)},e.prototype.loadDraft=function(t){window.cube().messaging.loadDraft(t.id,function(e){b.app.messageCatalog.restoreDesc(t.id,'<span class="text-danger">[草稿] '+e.getMessage().getSummary()+"</span>")})},e.prototype.serializeHyperText=function(){for(var e=[],t=0;t<this.formatContents.length;++t){var a,i=this.formatContents[t];"txt"==i.format?e.push(function(e){for(var t=[],a=0;a<e.length;++a){var i=e.charAt(a);"["!=i&&"]"!=i||t.push("\\"),t.push(i)}return t.join("")}(i.data)):"emoji"==i.format?(a=["[E",i.desc,"#",i.data,"]"],e.push(a.join(""))):"at"==i.format&&(a=["[@",i.name,"#",i.data,"]"],e.push(a.join("")))}return e.join("")},e.prototype.deserializeHyperText=function(e,t){var a=[];if(t){for(var i=e.getFormattedContents(),n=0,o=i.length-1;n<o;++n){var l=i[n];"text"==l.format?(a.push("<p>"),a.push(l.content),a.push("</p>")):"emoji"==l.format?(s=String.fromCodePoint("0x"+l.content.code),a.push('<p>&nbsp;</p><p class="emoji" desc="'),a.push(l.content.desc),a.push('">'),a.push(s),a.push("</p><p>&nbsp;</p>")):"at"==l.format&&(a.push('<p>&nbsp;</p><p class="at-wrapper"><span class="at">@'),a.push(l.content.name),a.push("</span></p><p>&nbsp;</p>"))}var s,t=i[i.length-1];"text"==t.format?a.push("<p>"+t.content+"<br></p>"):"emoji"==t.format?(s=String.fromCodePoint("0x"+t.content.code),a.push('<p>&nbsp;</p><p class="emoji" desc="'+t.content.desc+'">'+s+"</p><p><br></p>")):"at"==t.format&&a.push('<p>&nbsp;</p><p class="at-wrapper"><span class="at">@'+t.content.name+"</span></p><p><br></p>")}else e.getFormattedContents().forEach(function(e){var t;"text"==e.format?a.push(e.content):"emoji"==e.format?(t=String.fromCodePoint("0x"+e.content.code),a.push('&nbsp;<span class="emoji">'+t+"</span>&nbsp;")):"at"==e.format&&a.push('&nbsp;<span class="at">@'+e.content.name+"</span>&nbsp;")});return a.join("")},e.prototype.onEmojiClick=function(e){var t=String.fromCodePoint("0x"+e.code);c.inputEditor.cmd.do("insertHTML",'<p>&nbsp;</p><p class="emoji" desc="'+e.desc+'">'+t+"</p><p>&nbsp;</p>")},e.prototype.onSend=function(e){var t=this.inputEditor.txt.text();if(0!=t.length){if(t=this.serializeHyperText(),this.current.entity instanceof Group){var a=this.current.entity.getState();if(a==GroupState.Dismissed)return void this.appendNote(this.current.entity,"群组已解散");if(a==GroupState.Disabled)return void this.appendNote(this.current.entity,"群组已删除")}this.inputEditor.txt.clear(),null==b.app.messagingCtrl.fireSend(this.current.entity,t)&&b.dialog.launchToast(Toast.Error,"发送消息失败"),0<this.formatContents.length&&this.formatContents.splice(0,this.formatContents.length),this.lastInput=""}},e.prototype.onNewGroupClick=function(e){var o,l,s,r;null!=this.current&&(this.current.groupable?(o=this.current.entity,l=b.app.contactsCtrl.getContacts(),r=!(s=[]),o.getMembers(function(e,t){for(var a=0;a<l.length;++a){var i=l[a];r=!1;for(var n=0;n<e.length;++n)if(e[n].id==i.id){r=!0;break}r||s.push(i)}b.app.contactListDialog.show(s,[],function(e){0<e.length&&o.addMembers(e,function(e){b.app.messageSidebar.update(e)},function(e){b.dialog.launchToast(Toast.Error,"邀请入群操作失败 - "+e.code)})},"邀请入群","请选择您要邀请入群的联系人")})):b.app.newGroupDialog.show([this.current.entity.getId()]))},e.prototype.onDetailsClick=function(e){var t;null!=this.current&&(t=this.current.entity,(this.current.groupable?b.app.groupDetails:b.app.contactDetails).show(t))},e.prototype.onCollapseClick=function(e){null!=this.current&&b.app.messagingCtrl.toggleSidebar()},e.prototype.onEditorChange=function(e){if(0==e.length)return this.formatContents.splice(0,this.formatContents.length),this.lastInput="",void(null!=this.current&&window.cube().messaging.deleteDraft(this.current.id));if(this.lastInput!=e){var t=e.replace(/<[^<>]+>/g,"");if(0==t.length||" "==t||"&nbsp;"==t)return this.formatContents.splice(0,this.formatContents.length),this.lastInput="",void(null!=this.current&&window.cube().messaging.deleteDraft(this.current.id));t=function(e,t){for(var a=r(e),i=r(t),n=!1,o=0;o<a.length&&o<i.length;++o){var l=a[o],s=i[o];if("at"==l.format&&"at"==s.format&&l.name!=s.name){n=!0,i.splice(o,1);break}}return{deleted:n,newestContents:i,lastContents:a}}(this.lastInput,e);if(t.deleted){for(var a=t.newestContents,i=[],n=0;n<a.length;++n){var o,l=a[n];"txt"==l.format?i.push("<p>"+l.data+"</p>"):"emoji"==l.format?(o=String.fromCodePoint("0x"+l.data),i.push('<p>&nbsp;</p><p class="emoji" desc="'+l.desc+'">'+o+"</p><p>&nbsp;</p>")):"at"==l.format&&(l='<p>&nbsp;</p><p class="at-wrapper" data="'+l.data+'"><span class="at">@'+l.name+"</span></p><p>&nbsp;</p>",i.push(l))}setTimeout(function(){c.inputEditor.txt.html(i.join(""))},10)}this.formatContents=t.newestContents,this.lastInput=e}},e.prototype.handlePasteText=function(e){return e.replace(/<[^<>]+>/g,"")},e.prototype.onEditorKeypress=function(e){e=e||window.event;e&&13==e.keyCode&&e.ctrlKey?c.onSend(e):64==e.keyCode&&this.current.groupable&&(this.makeAtPanel(this.current.entity),this.atPanel.css("display","block"),this.atPanel.focus(),b.app.onKeyUp(c.onAtPanelKeyUp))},e.prototype.makeAtPanel=function(e){var a=this;e.getMembers(function(e,t){a._makeAtPanel(t,e)})},e.prototype._makeAtPanel=function(a,e){var t=e.length-1;this.atElList=[],this.atPanel.empty();var i=null,n=function(e){var t=window.getSelection(),a=-1,i=null;if(t.focusNode&&function(e,t){for(;null!==e;){if(e.id===t)return!0;e=e.parentNode}return!1}(t.focusNode,e))for(i=t.focusNode,a=t.focusOffset;i&&i.id!==e;)if(i.previousSibling)i=i.previousSibling,a+=i.textContent.length;else if(null===(i=i.parentNode))break;return{node:i,charCount:a}}($("#message-editor").find(".w-e-text").attr("id"));if(null!=(i=n.node)){var o=parseInt(i.clientWidth||i.offsetWidth||i.style.width||i.scrollWidth),l=parseInt(i.offsetLeft)+parseInt(i.offsetParent.offsetLeft),i=parseInt(i.offsetTop)+parseInt(i.offsetParent.offsetTop);o<=(l+=function(e){for(var t=0,a=c.lastInput.replace(/<[^<>]+>/g,"").replaceAll("&nbsp;"," "),i=0,n=0;n<a.length&&n<e;++n){var o=a.charCodeAt(n);127<o||94==o?(t+=2,i+=14):(t+=1,i+=105<=o&&o<=108||114==o||116==o?4:64<=o&&o<=90?10:8)}return[Math.round(i),t]}(n.charCount)[0])+12&&(i+=21*Math.floor((l+12)/o),l=12+(l+12)%o),t<=5?(this.atPanel.css("height",32*t+2+"px"),i-=32*t+4):(this.atPanel.css("height","162px"),i-=170);for(var s=0;s<e.length;++s){var r=e[s];r.getId()!=b.app.account.id&&b.app.getContact(r.getId(),function(e){a.modifyMember(e);var t=a.getMemberName(e),t=['<div class="row align-items-center" data="',e.getId(),'">','<div class="col-2 avatar"><img src="',b.helper.getAvatarImage(e.getContext().avatar),'" /></div>','<div class="col-10">',t,"</div>","</div>"],t=$(t.join(""));t.on("click",function(){c.onAtRowClick($(this))}),c.atElList.push(t),1==c.atElList.length&&c.atElList[0].addClass("active"),c.atPanel.append(t)})}this.atPanel.css("left",l+"px"),this.atPanel.css("top",i+"px")}},e.prototype.selectAtItem=function(){var e,t;c.current.groupable&&(e=parseInt(c.atPanel.find(".active").attr("data")),t=c.current.entity.getMemberById(e),t='<p>&nbsp;</p><p class="at-wrapper" data="'+e+'"><span class="at">@'+c.current.entity.getMemberName(t)+"</span></p><p>&nbsp;</p>",c.inputEditor.cmd.do("insertHTML",t),c.atPanel.blur())},e.prototype.onAtRowClick=function(e){for(var t=0,a=0;a<c.atElList.length;++a)if(c.atElList[a].hasClass("active")){t=a;break}c.atElList[t].removeClass("active"),e.addClass("active"),c.selectAtItem()},e.prototype.onAtPanelBlur=function(e){b.app.unKeyUp(c.onAtPanelKeyUp),c.atElList=[],c.atPanel.css("display","none")},e.prototype.onAtPanelKeyUp=function(e){if(13!=e.keyCode){if(27==e.keyCode)return c.atPanel.blur(),void c.inputEditor.txt.append("@");if(40==e.keyCode||38==e.keyCode){for(var t=0,a=0;a<c.atElList.length;++a)if(c.atElList[a].hasClass("active")){t=a;break}var i=c.atElList[t];40==e.keyCode?(i.removeClass("active"),t>=c.atElList.length-1?t=0:t+=1,c.atElList[t].addClass("active")):38==e.keyCode&&(i.removeClass("active"),0==t?t=c.atElList.length-1:--t,c.atElList[t].addClass("active"))}}else c.selectAtItem()},b.MessagePanel=e}(window),function(r){"use strict";var c,d=null,t=null,a=null,i=null,n=null,o=null,l=null,s=null,p=null,u=null,g=null,f=null,m=null;function h(){var e;p.prop("disabled")?(t=p.val().trim(),p.removeAttr("disabled"),p.focus()):(e=p.val().trim(),p.attr("disabled","disabled"),t!=e&&window.cube().contact.remarkGroup(d,e,function(){dialog.launchToast(Toast.Success,"已备注群组")},function(e){dialog.launchToast(Toast.Error,"修改群组备注失败："+e.code),p.val(t)}))}function v(){h()}function b(){var e;u.prop("disabled")?(a=u.val().trim(),u.removeAttr("disabled"),u.focus()):(e=u.val().trim(),u.attr("disabled","disabled"),a!=e&&d.getAppendix().updateNotice(e,function(){dialog.launchToast(Toast.Success,"已修改群组公告")},function(e){dialog.launchToast(Toast.Error,"修改群组公告失败："+e.code),u.val(a)}))}function C(){b()}function y(e){13==e.keyCode&&T($(this))}function w(e){T($(this))}function T(e){var t=e.val(),a=e.attr("predata"),i=e.attr("data-target");t==a||t.length<3?r.app.messageSidebar.recoverMemberName(i,e.parent(),a):(d.getAppendix().updateMemberRemark(i,t,function(){dialog.launchToast(Toast.Success,"已修改群组成员备注")},function(e){dialog.launchToast(Toast.Error,"备注群组成员失败："+e.code)}),r.app.messageSidebar.recoverMemberName(i,e.parent(),t))}function x(e){var o=r.app.contactsCtrl.getContacts(),l=[],s=!1;d.getMembers(function(e,t){for(var a=0;a<o.length;++a){var i=o[a];s=!1;for(var n=0;n<e.length;++n)if(e[n].id==i.id){s=!0;break}s||l.push(i)}r.app.contactListDialog.show(l,[],function(e){0<e.length&&d.addMembers(e,function(e){c.updateGroup(e)},function(e){r.dialog.launchToast(Toast.Error,"邀请入群操作失败 - "+e.code)})},"邀请入群","请选择您要邀请入群的联系人")})}function I(e){d.isOwner()?d.getMembers(function(e,t){if(2!=e.length){for(var a=0;a<e.length;++a)if(e[a].id==r.app.account.id){e.splice(a,1);break}r.app.contactListDialog.show(e,[],function(e){0<e.length&&d.removeMembers(e,function(e){c.updateGroup(e)},function(e){r.dialog.launchToast(Toast.Error,"移除成员操作失败 - "+e.code)})},"移除成员","请选择您要从群组移除的联系人")}else r.dialog.launchToast(Toast.Warning,"群里仅有两名成员，没有可移除的成员。")}):r.dialog.launchToast(Toast.Info,"您不能移除该群组成员。")}function k(){var e;f.prop("disabled")?(n=f.val().trim(),f.removeAttr("disabled"),f.focus()):(e=f.val().trim(),f.attr("disabled","disabled"),n!=e&&window.cube().contact.remarkContactName(i,e,function(){dialog.launchToast(Toast.Success,"已备注联系人")},function(e){dialog.launchToast(Toast.Error,"修改联系人备注失败："+e.code),f.val(n)}))}function P(){k()}function S(e,t){var a=r.cube().contact.getSelf().getAppendix();t?a.addNoNoticeGroup(d.getId()):a.removeNoNoticeGroup(d.getId())}function M(e,t){var a=r.cube().contact.getSelf().getAppendix();t?a.addNoNoticeContact(i.getId()):a.removeNoNoticeContact(i.getId())}function e(e){c=this,l=(o=e).find(".for-group"),s=o.find(".for-contact"),(p=l.find('input[data-target="group-remark"]')).attr("disabled","disabled"),p.blur(v),l.find('button[data-target="remark"]').click(h),(u=l.find('textarea[data-target="group-notice"]')).attr("disabled","disabled"),u.blur(C),l.find('button[data-target="notice"]').click(b),l.find('button[data-target="add-member"]').click(x),l.find('button[data-target="remove-member"]').click(I),g=l.find(".group-member-list"),l.find('input[data-target="no-noticing-switch"]').bootstrapSwitch({onText:"已开启",offText:"已关闭",size:"small",handleWith:50,labelWidth:15,onSwitchChange:S}),(f=s.find('input[data-target="contact-remark"]')).attr("disabled","disabled"),f.blur(P),s.find('button[data-target="remark"]').click(k),(m=s.find('input[data-target="no-noticing-switch"]')).bootstrapSwitch({onText:"已开启",offText:"已关闭",size:"small",handleWith:50,labelWidth:15,onSwitchChange:M})}e.prototype.update=function(e){null!=e&&(e instanceof Group?(this.updateGroup(e),l.hasClass("no-display")&&l.removeClass("no-display"),s.hasClass("no-display")||s.addClass("no-display")):(this.updateContact(e),s.hasClass("no-display")&&s.removeClass("no-display"),l.hasClass("no-display")||l.addClass("no-display")))},e.prototype.updateContact=function(e){i=e,s.find('input[data-target="contact-name"]').val(e.getName()),f.val(e.getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():""),r.app.getSelf().getAppendix().isNoNoticeContact(e)?m.bootstrapSwitch("state",!0):m.bootstrapSwitch("state",!1)},e.prototype.updateGroup=function(e){d=e,l.find('input[data-target="group-name"]').val(e.getName()),d.isOwner()?l.find(".group-notice-btn-group").css("display","block"):l.find(".group-notice-btn-group").css("display","none"),p.val(e.getAppendix().getRemark()),u.val(e.getAppendix().getNotice()),g.empty(),e.getMembers(function(e,t){for(var a=0;a<e.length;++a){var i=e[a];t.modifyMember(i);var n=['<button class="btn btn-sm btn-default btn-flat"',' onclick="javascript:app.messageSidebar.fireUpdateMemberRemark(',i.getId(),');"><i class="fas fa-edit"></i></button>'],n=['<div class="group-member-cell" data-target="',i.getId(),'" ondblclick="javascript:app.contactDetails.show(',i.getId(),');">','<div class="member-avatar"><img class="img-size-32 img-round-rect" src="',r.helper.getAvatarImage(i.getContext().avatar),'" /></div>','<div class="member-name">',t.getAppendix().hasMemberRemark(i)?t.getAppendix().getMemberRemark(i):i.getPriorityName(),"</div>",'<div class="member-operate">',t.isOwner()||i.getId()==r.app.account.id?n.join(""):"","</div>","</div>"];g.append($(n.join("")))}});r.app.getSelf().getAppendix()},e.prototype.appendImage=function(e){},e.prototype.fireUpdateMemberRemark=function(e){var t=o.find('div[data-target="'+e+'"]');t.find("button").attr("disabled","disabled");var a=parseInt(t.width()),i=(t=t.find(".member-name")).text();t.empty(),t.html(['<input class="form-control form-control-sm" type="text" style="width:',a-=100,'px;" predata="',i,'" data-target="',e,'" />'].join(""));t=t.find("input");t.blur(w),t.keyup(y),t.focus()},e.prototype.recoverMemberName=function(e,t,a){t.empty(),t.text(a),o.find('div[data-target="'+e+'"]').find(".member-operate").find("button").removeAttr("disabled")},r.MessageSidebar=e}(window),function(o){function e(){a=this;var e=$("#voice_call");this.panelEl=e,this.elPeerAvatar=e.find('img[data-target="avatar"]'),this.elPeerName=e.find('span[data-target="name"]'),this.elInfo=e.find('span[data-target="info"]'),this.remoteVideo=e.find('video[data-target="remote"]')[0],this.localVideo=e.find('video[data-target="local"]')[0],this.btnMic=e.find('button[data-target="microphone"]'),this.btnMic.attr("disabled","disabled"),this.btnMic.on("click",function(){o.app.callCtrl.toggleMicrophone()?a.btnMic.html('<i class="ci ci-btn ci-microphone-opened"></i>'):a.btnMic.html('<i class="ci ci-btn ci-microphone-closed"></i>')}),this.btnVol=e.find('button[data-target="volume"]'),this.btnVol.attr("disabled","disabled"),this.btnVol.on("click",function(){o.app.callCtrl.toggleLoudspeaker()?a.btnVol.html('<i class="ci ci-btn ci-volume-unmuted"></i>'):a.btnVol.html('<i class="ci ci-btn ci-volume-muted"></i>')}),this.btnHangup=e.find('button[data-target="hangup"]'),this.btnHangup.on("click",function(){a.terminate()}),e.draggable({handle:".modal-header"}),e.on("hide.bs.modal",function(){0<i&&(clearInterval(i),i=0),0<t&&(clearTimeout(t),t=0),n=0,a.btnMic.attr("disabled","disabled"),a.btnVol.attr("disabled","disabled")})}var a=null,i=0,t=0,n=0;e.prototype.open=function(e){console.log("发起语音通话 "+e.getId());function i(){o.app.callCtrl.makeCall(e,!1,n)?(a.elPeerAvatar.attr("src",o.helper.getAvatarImage(e.getContext().avatar)),a.elPeerName.text(e.getName()),a.elInfo.text("正在呼叫..."),a.panelEl.modal({keyboard:!1,backdrop:!1})):o.dialog.launchToast(Toast.Warning,"您当前正在通话中")}var n=null;o.cube().mpComm.listMediaDevices(function(e){if(0!=e.length){for(var a=[],t=0;t<e.length;++t)e[t].isAudioInput()&&a.push(e[t]);1<a.length?o.app.callCtrl.showSelectMediaDevice(a,function(e,t){e&&(t>=a.length?o.dialog.showAlert("选择的设备数据错误"):(n=a[t],i()))}):i()}else o.dialog.showAlert("没有找到可用的麦克风设备，请您确认是否正确连接了麦克风设备。")})},e.prototype.showAnswer=function(e){console.log("应答语音通话 "+e.getId()),this.elPeerAvatar.attr("src",o.helper.getAvatarImage(e.getContext().avatar)),this.elPeerName.text(e.getName()),this.elInfo.text("正在应答..."),this.btnMic.removeAttr("disabled"),this.btnVol.removeAttr("disabled"),this.panelEl.modal({keyboard:!1,backdrop:!1})},e.prototype.close=function(){this.panelEl.modal("hide"),o.app.mainPanel.stopWaitingTone(),o.app.mainPanel.stopCallRing(),this.btnMic.attr("disabled","disabled"),this.btnVol.attr("disabled","disabled")},e.prototype.tipWaitForAnswer=function(e){var t;0<i||(t=0,i=setInterval(function(){a.elInfo.text("等待应答，已等待 "+ ++t+" 秒...")},1e3),o.app.mainPanel.playWaitingTone(),a.btnMic.removeAttr("disabled"),a.btnVol.removeAttr("disabled"))},e.prototype.tipConnected=function(){0<i&&(clearInterval(i),i=0),0<t||(o.app.callCtrl.isMicrophoneOpened()?a.btnMic.html('<i class="ci ci-btn ci-microphone-opened"></i>'):a.btnMic.html('<i class="ci ci-btn ci-microphone-closed"></i>'),o.app.callCtrl.isUnmuted()?a.btnVol.html('<i class="ci ci-btn ci-volume-unmuted"></i>'):a.btnVol.html('<i class="ci ci-btn ci-volume-muted"></i>'),t=setInterval(function(){a.elInfo.text(o.formatClockTick(++n))},1e3),o.app.mainPanel.stopWaitingTone())},e.prototype.openNewCallToast=function(e){e=['<div class="toasts-info">                <div class="info-box">                    <span class="info-box-icon"><img src="',o.helper.getAvatarImage(e.getContext().avatar),'" /></span>                    <div class="info-box-content">                        <span class="info-box-text">',e.getName(),'</span>                        <span class="info-box-desc">邀请您参与语音通话</span>                    </div>                </div>                <div class="call-answer">                    <button type="button" class="btn btn-danger" onclick="javascript:app.callCtrl.hangupCall();"><i class="ci ci-hangup"></i> 拒绝</button>                    <button type="button" class="btn btn-success" onclick="javascript:app.callCtrl.answerCall();"><i class="ci ci-answer"></i> 接听</button>                </div>            </div>'];$(document).Toasts("create",{title:"语音通话邀请",position:"bottomRight",icon:"fas fa-phone-alt",close:!1,class:"voice-new-call",body:e.join("")}),o.app.mainPanel.playCallRing()},e.prototype.closeNewCallToast=function(){$("#toastsContainerBottomRight").find(".voice-new-call").remove(),o.app.mainPanel.stopCallRing()},e.prototype.terminate=function(){o.app.callCtrl.hangupCall()},o.VoiceCallPanel=e}(window),function(o){"use strict";function e(e){l=this,e=$("#video_chat"),this.panelEl=e,window.addEventListener("resize",this.onResize,!1),(i=e.find('button[data-target="minimize"]')).on("click",function(){l.minimize()}),(n=e.find('button[data-target="maximize"]')).on("click",function(){l.maximize()}),(s=e.find('button[data-target="restore"]')).on("click",function(){l.restore()}),s.css("display","none"),u=e.find('div[data-target="video-remote"]'),g=e.find('div[data-target="video-local"]'),u.on("click",function(e){v==h&&l.switchVideo()}),g.on("click",function(e){v==m&&l.switchVideo()}),a=g,m=(f=u)[0].querySelector("video"),h=g[0].querySelector("video"),(v=m).style.visibility="hidden",this.remoteVideo=m,this.localVideo=h,this.headerTip=e.find(".header-tip"),this.callTip=e.find(".call-tip"),this.elRemoteLabel=u.find(".video-label"),this.elLocalLabel=g.find(".video-label"),this.btnCam=e.find('button[data-target="camera"]'),this.btnMic=e.find('button[data-target="microphone"]'),this.btnVol=e.find('button[data-target="volume"]'),this.btnCam.attr("disabled","disabled"),this.btnMic.attr("disabled","disabled"),this.btnVol.attr("disabled","disabled"),this.btnCam.on("click",function(){o.app.callCtrl.toggleCamera()?l.btnCam.html('<i class="ci ci-btn ci-camera-opened"></i>'):l.btnCam.html('<i class="ci ci-btn ci-camera-closed"></i>')}),this.btnMic.on("click",function(){o.app.callCtrl.toggleMicrophone()?l.btnMic.html('<i class="ci ci-btn ci-microphone-opened"></i>'):l.btnMic.html('<i class="ci ci-btn ci-microphone-closed"></i>')}),this.btnVol.on("click",function(){o.app.callCtrl.toggleLoudspeaker()?l.btnVol.html('<i class="ci ci-btn ci-volume-unmuted"></i>'):l.btnVol.html('<i class="ci ci-btn ci-volume-muted"></i>')}),this.btnHangup=e.find('button[data-target="hangup"]'),this.btnHangup.on("click",function(){l.terminate()}),e.draggable({handle:".modal-header",containment:"document"}),e.on("hide.bs.modal",function(){0<b&&(clearInterval(b),b=0),0<t&&(clearInterval(t),t=0),C=0,m.style.visibility="hidden",l.callTip.text(""),l.headerTip.text("")})}var l=null,i=null,n=null,s=null,r=0,c="640px",d="0px",p=1,u=null,g=null,f=null,a=null,m=null,h=null,v=null,b=0,t=0,C=0;e.prototype.restore=function(){var e,t=this.panelEl.find(".modal-content"),a=this.panelEl.find(".modal-footer");0==p?(this.panelEl.removeClass("video-chat-panel-mini"),t.removeClass("modal-content-mini"),u.removeClass("video-mini"),g.removeClass("video-mini"),g.css("visibility","visible"),a.css("display","flex"),i.css("display","block"),n.css("display","block"),s.css("display","none")):2==p&&(0<r&&(clearTimeout(r),r=0),this.panelEl.css("left",c),this.panelEl.css("top",d),this.panelEl.css("width",""),this.panelEl.css("height",""),(e=this.panelEl.find(".modal-dialog")).css("width",""),e.css("height",""),t.css("width",""),t.css("height",""),a.css("width",""),u.css("width",""),u.css("height",""),g.css("width",""),g.css("height",""),i.css("display","block"),n.css("display","block"),s.css("display","none"),this.panelEl.draggable({handle:".modal-header",containment:"document",disabled:!1})),this.refresh(),p=1},e.prototype.minimize=function(){var e,t;1==p&&(p=0,e=this.panelEl.find(".modal-content"),t=this.panelEl.find(".modal-footer"),this.panelEl.addClass("video-chat-panel-mini"),e.addClass("modal-content-mini"),u.addClass("video-mini"),g.addClass("video-mini"),g.css("visibility","hidden"),t.css("display","none"),i.css("display","none"),n.css("display","none"),s.css("display","block"),this.refresh())},e.prototype.maximize=function(){1==p&&(p=2,this.resize(),i.css("display","none"),n.css("display","none"),s.css("display","block"),this.panelEl.draggable({disabled:!0}))},e.prototype.open=function(e){console.log("发起视频连线 "+e.getId());function i(){o.app.callCtrl.makeCall(e,!0,n)?(l.elRemoteLabel.text(e.getName()),l.elLocalLabel.text("我"),l.panelEl.modal({keyboard:!1,backdrop:!1})):o.dialog.launchToast(Toast.Warning,"您当前正在通话中")}var n=null;o.cube().mpComm.listMediaDevices(function(e){if(0!=e.length){for(var a=[],t=0;t<e.length;++t)e[t].isVideoInput()&&a.push(e[t]);1<a.length?o.app.callCtrl.showSelectMediaDevice(a,function(e,t){e&&(t>=a.length?o.dialog.showAlert("选择的设备数据错误"):(n=a[t],i()))}):i()}else o.dialog.showAlert("没有找到可用的摄像机设备，请您确认是否正确连接了摄像机设备。")})},e.prototype.showAnswer=function(e){console.log("应答视频通话 "+e.getId()),this.elRemoteLabel.text(e.getName()),this.elLocalLabel.text("我"),l.btnCam.removeAttr("disabled"),l.btnMic.removeAttr("disabled"),l.btnVol.removeAttr("disabled"),this.panelEl.modal({keyboard:!1,backdrop:!1})},e.prototype.close=function(){this.panelEl.modal("hide"),o.app.mainPanel.stopWaitingTone(),o.app.mainPanel.stopCallRing()},e.prototype.tipWaitForAnswer=function(e){var t,a;0<b||(t=l.callTip.parent().height(),l.callTip.css("top",.5*(t-21)+"px"),a=0,b=setInterval(function(){l.callTip.text("正在呼叫“"+e.getName()+"”："+ ++a+" 秒...")},1e3),o.app.mainPanel.playWaitingTone(),l.btnCam.removeAttr("disabled"),l.btnMic.removeAttr("disabled"),l.btnVol.removeAttr("disabled"))},e.prototype.tipConnected=function(){0<b&&(clearInterval(b),b=0),0<t||(l.callTip.text(""),m.style.visibility="visible",t=setInterval(function(){l.headerTip.text(o.formatClockTick(++C))},1e3),o.app.callCtrl.isCameraOpened()?l.btnCam.html('<i class="ci ci-btn ci-camera-opened"></i>'):l.btnCam.html('<i class="ci ci-btn ci-camera-closed"></i>'),o.app.callCtrl.isMicrophoneOpened()?l.btnMic.html('<i class="ci ci-btn ci-microphone-opened"></i>'):l.btnMic.html('<i class="ci ci-btn ci-microphone-closed"></i>'),o.app.callCtrl.isUnmuted()?l.btnVol.html('<i class="ci ci-btn ci-volume-unmuted"></i>'):l.btnVol.html('<i class="ci ci-btn ci-volume-muted"></i>'))},e.prototype.openNewCallToast=function(e){e=['<div class="toasts-info">                <div class="info-box">                    <span class="info-box-icon"><img src="',o.helper.getAvatarImage(e.getContext().avatar),'" /></span>                    <div class="info-box-content">                        <span class="info-box-text">',e.getName(),'</span>                        <span class="info-box-desc">邀请您参与视频通话</span>                    </div>                </div>                <div class="call-answer">                    <button type="button" class="btn btn-danger" onclick="javascript:app.callCtrl.hangupCall();"><i class="ci ci-hangup"></i> 拒绝</button>                    <button type="button" class="btn btn-success" onclick="javascript:app.callCtrl.answerCall();"><i class="ci ci-answer"></i> 接听</button>                </div>            </div>'];$(document).Toasts("create",{title:"视频通话邀请",position:"bottomRight",icon:"fas fa-video",close:!1,class:"video-new-call",body:e.join("")}),o.app.mainPanel.playCallRing()},e.prototype.closeNewCallToast=function(){$("#toastsContainerBottomRight").find(".video-new-call").remove()},e.prototype.switchVideo=function(){var e,t;a=v==m?(v=h,f=g,u):(v=m,f=u,g),f.removeClass("video-pip"),a.removeClass("video-main"),f.addClass("video-main"),a.addClass("video-pip"),2==p&&(e=parseInt(document.body.clientWidth),t=o.dialog.getFullHeight(),f.css("width",e-4+"px"),f.css("height",t-105-4+"px"),a.css("width",""),a.css("height",""))},e.prototype.terminate=function(){o.app.callCtrl.hangupCall()},e.prototype.onResize=function(e){2==p&&(0<r&&(clearTimeout(r),r=0),r=setTimeout(function(){clearTimeout(r),r=0,l.resize()},600))},e.prototype.resize=function(){var e,t,a,i,n;2==p&&(e=parseInt(document.body.clientWidth),t=o.dialog.getFullHeight(),c=this.panelEl.css("left"),d=this.panelEl.css("top"),this.panelEl.css("left","322px"),this.panelEl.css("top","-1px"),this.panelEl.css("width",e+"px"),this.panelEl.css("height",t+"px"),a=this.panelEl.find(".modal-dialog"),i=this.panelEl.find(".modal-content"),n=this.panelEl.find(".modal-footer"),t-=2,a.css("width",(e-=2)+"px"),a.css("height",t+"px"),i.css("width",e+"px"),i.css("height",t+"px"),f.css("width",e-2+"px"),f.css("height",t-105-2+"px"),n.css("width",e+"px"),this.refresh())},e.prototype.refresh=function(){var e=l.callTip.parent().height();l.callTip.css("top",.5*(e-21)+"px")},o.VideoChatPanel=e}(window),function(s){function e(){r=this,c=$("#group_voice_call"),n=c.find(".voice-group-minisize .duration"),r.localVideo=c.find('video[data-target="local"]')[0],r.remoteVideo=c.find('video[data-target="remote"]')[0],c.find('button[data-target="minimize"]').click(function(){r.minimize()}),c.find('button[data-target="restore"]').click(function(){r.restore()}),c.find('button[data-target="hangup"]').click(function(){r.terminate()}),c.draggable({handle:".modal-header"})}var r=null,c=null,d={list:null,timer:[]},t=!1,i=0,n=null;e.prototype.open=function(i){d.list=null,d.timer=[],c.find(".header-tip").text("");function n(e,t){s.app.callCtrl.makeCall(e,!1,l)?(c.find(".voice-group-default .modal-title").text("群通话 - "+e.getName()),c.find(".voice-group-minisize .modal-title").text(e.getName()),c.find(".header-tip").text("正在接通，请稍候..."),c.modal({keyboard:!1,backdrop:!1}),t&&(d.list=t)):s.dialog.launchToast(Toast.Warning,"您当前正在通话中")}function o(){c.find(".header-tip").text("正在启动麦克风..."),s.cube().mpComm.isCalling(i,function(e){var a;e?s.cube().mpComm.getCommField(i,function(t){var a=[s.app.getSelf().getId()];t.getEndpoints().forEach(function(e){a.push(e.getContact().getId()),a.length==t.numEndpoints()+1&&(r.resetLayout(a),a.shift(),setTimeout(function(){n(i)},1))})}):(a=[],i.getMembers(function(e,t){e.forEach(function(e){e.getId()!=s.app.getSelf().getId()&&s.app.getContact(e.getId(),function(e){a.push(e),a.length==t.numMembers()-1&&s.app.contactListDialog.show(a,[],function(e){return 0==e.length?(s.dialog.showAlert("没有邀请任何联系人参与群通话"),!1):(e.unshift(s.app.getSelf().getId()),16<e.length?(s.dialog.showAlert("超过最大通话人数（最大通话人数 16 人）"),!1):(r.resetLayout(e),e.shift(),void n(t,e)))},"群通话","请选择要邀请通话的群组成员",15)})})}))})}var l=null;s.cube().mpComm.listMediaDevices(function(e){if(0!=e.length){for(var a=[],t=0;t<e.length;++t)e[t].isAudioInput()&&a.push(e[t]);1<a.length?s.app.callCtrl.showSelectMediaDevice(a,function(e,t){e&&(t>=a.length?s.dialog.showAlert("选择的设备错误"):(l=a[t],console.log("Select device: "+l.label),o()))}):o()}else s.dialog.showAlert("没有找到可用的麦克风设备，请您确认是否正确连接了麦克风设备。")})},e.prototype.close=function(){c.modal("hide")},e.prototype.tipWaitForAnswer=function(e){c.find(".header-tip").text("正在等待服务器应答..."),null!=d.list&&(d.list.forEach(function(e){var t=setTimeout(function(){r.fireInviteTimeout(e)},3e4);d.timer.push(t)}),s.cube().mpComm.inviteCall(e.field,d.list))},e.prototype.tipConnected=function(e){c.find(".header-tip").text(""),this.refreshState(e)},e.prototype.refreshState=function(a){0<i&&clearInterval(i),i=setInterval(function(){if(null==a.field)return clearInterval(i),void(i=0);var e,t=a.field.startTime;t<=0||(e=Date.now(),t=Math.round((e-t)/1e3),t=s.formatClockTick(t),c.find(".header-tip").text(t),n.text(t))},1e3),c.find(".voice-group-minisize .number-of-member").text(a.field.numEndpoints())},e.prototype.unmark=function(e){c.find(".layout").find('div[data="'+e.getId()+'"]').find(".mask").css("visibility","hidden")},e.prototype.minimize=function(){t||(t=!0,c.addClass("voice-group-panel-mini"),c.find(".voice-group-default").css("display","none"),c.find(".voice-group-minisize").css("display","block"))},e.prototype.restore=function(){t&&(t=!1,c.removeClass("voice-group-panel-mini"),c.find(".voice-group-default").css("display","block"),c.find(".voice-group-minisize").css("display","none"))},e.prototype.terminate=function(){s.app.callCtrl.hangupCall()||r.close()},e.prototype.appendContact=function(e,t){var a=c.find(".layout");0<a.find('div[data="'+e.getId()+'"]').length||(t=['<div data="',e.getId(),'" class="',"col-3",'">','<div class="avatar">','<img src="',s.helper.getAvatarImage(e.getContext().avatar),'" />',"</div>",'<div class="name">',"<div>",e.getName(),"</div>","</div>",'<div class="mask"',t?"":' style="visibility:hidden;"',">","<div>",'<i class="fas fa-spinner"></i>',"</div>","</div>","</div>"],a.append($(t.join(""))))},e.prototype.removeContact=function(e){e=c.find(".layout").find('div[data="'+e.getId()+'"]');0!=e.length&&e.remove()},e.prototype.resetLayout=function(e){for(var t=c.find(".layout"),a=e.length,i=[],n=0;n<a;++n){var o=e[n];s.app.getContact(o,function(e){e=['<div data="',e.getId(),'" class="',"col-3",'">','<div class="avatar">','<img src="',s.helper.getAvatarImage(e.getContext().avatar),'" />',"</div>",'<div class="name">',"<div>",e.getName(),"</div>","</div>",'<div class="mask"',0==n?' style="visibility:hidden;"':"",">","<div>",'<i class="fas fa-spinner"></i>',"</div>","</div>","</div>"];i.push(e.join("")),i.length==a&&t.html(i.join(""))})}},e.prototype.openInviteToast=function(e){e=['<div class="toasts-info">                <div class="info-box">                    <span class="info-box-icon"><img src="images/group-avatar.png" /></span>                    <div class="info-box-content">                        <span class="info-box-text">',e.getName(),'</span>                        <span class="info-box-desc">邀请您参与群组通话</span>                    </div>                </div>                <div class="call-answer">                    <button type="button" class="btn btn-danger" onclick="javascript:app.callCtrl.rejectInvitation();"><i class="ci ci-hangup"></i> 拒绝</button>                    <button type="button" class="btn btn-success" onclick="javascript:app.callCtrl.acceptInvitation();"><i class="ci ci-answer"></i> 加入</button>                </div>            </div>'];$(document).Toasts("create",{title:"语音通话邀请",position:"bottomRight",icon:"fas fa-phone-alt",close:!1,class:"voice-new-call",body:e.join("")}),s.app.mainPanel.playCallRing()},e.prototype.closeInviteToast=function(){$("#toastsContainerBottomRight").find(".voice-new-call").remove(),s.app.mainPanel.stopCallRing()},e.prototype.fireInviteTimeout=function(e){var t,a=d.list.indexOf(e);0<=a&&(t=d.timer[a],clearTimeout(t),d.list.splice(a,1),d.timer.splice(a,1)),s.app.getContact(e,function(e){r.removeContact(e)})},s.VoiceGroupCallPanel=e}(window),function(s){var r=null,p=null,c={list:null,timer:[]},i=[],n=0,o=null;function a(e){e=e instanceof Contact?e.getId():parseInt(e);return p.find('video[data-target="'+e+'"]')[0]}function e(){r=this,p=$("#group_video_chat"),o=p.find(".video-group-minisize .duration"),r.localVideo=null,p.find('button[data-target="minimize"]').click(function(){r.minimize()}),p.find('button[data-target="restore"]').click(function(){r.restore()}),p.find('button[data-target="hangup"]').click(function(){r.terminate()}),p.draggable({handle:".modal-header"})}e.prototype.open=function(i){c.list=null,c.timer=[],p.find(".header-tip").text(""),s.cube().mpComm.setVideoElementAgent(a);function n(e,t){r.localVideo=a(s.app.getSelf().getId()),void 0===r.localVideo&&alert("查找本地视频标签错误"),s.app.callCtrl.makeCall(e,!0,l)?(p.find(".video-group-default .modal-title").text("群通话 - "+e.getName()),p.find(".video-group-minisize .modal-title").text(e.getName()),p.find(".header-tip").text("正在接通，请稍候..."),p.modal({keyboard:!1,backdrop:!1}),t&&(c.list=t)):s.dialog.launchToast(Toast.Warning,"您当前正在通话中")}function o(){p.find(".header-tip").text("正在启动摄像机..."),s.cube().mpComm.isCalling(i,function(e){var a;e?s.cube().mpComm.getCommField(i,function(t){var a=[s.app.getSelf().getId()];t.getEndpoints().forEach(function(e){a.push(e.getContact().getId()),a.length==t.numEndpoints()+1&&(r.resetLayout(a),a.shift(),setTimeout(function(){n(i)},100))})}):(a=[],i.getMembers(function(e,t){e.forEach(function(e){e.getId()!=s.app.getSelf().getId()&&s.app.getContact(e.getId(),function(e){a.push(e),a.length==t.numMembers()-1&&s.app.contactListDialog.show(a,[],function(e){return 0==e.length?(s.dialog.showAlert("没有邀请任何联系人参与视频通话"),!1):(e.unshift(s.app.getSelf().getId()),6<e.length?(s.dialog.showAlert("超过最大通话人数（最大通话人数 6 人）"),!1):(r.resetLayout(e),e.shift(),void n(t,e)))},"群视频","请选择要邀请视频通话的群组成员",5)})})}))})}var l=null;s.cube().mpComm.listMediaDevices(function(e){if(0!=e.length){for(var a=[],t=0;t<e.length;++t)e[t].isVideoInput()&&a.push(e[t]);1<a.length?s.app.callCtrl.showSelectMediaDevice(a,function(e,t){e&&(t>=a.length?s.dialog.showAlert("选择的设备错误"):(l=a[t],console.log("Select device: "+l.label),o()))}):o()}else s.dialog.showAlert("没有找到可用的摄像机设备，请您确认是否正确连接了摄像机设备。")})},e.prototype.tipWaitForAnswer=function(e){p.find(".header-tip").text("正在等待服务器应答..."),null!=c.list&&(c.list.forEach(function(e){var t=setTimeout(function(){r.fireInviteTimeout(e)},3e4);c.timer.push(t)}),s.cube().mpComm.inviteCall(e.field,c.list))},e.prototype.tipConnected=function(e){p.find(".header-tip").text(""),this.refreshState(e)},e.prototype.refreshState=function(a){0<n&&clearInterval(n),n=setInterval(function(){if(null==a.field)return clearInterval(n),void(n=0);var e,t=a.field.startTime;t<=0||(e=Date.now(),t=Math.round((e-t)/1e3),t=s.formatClockTick(t),p.find(".header-tip").text(t),o.text(t))},1e3),p.find(".video-group-minisize .number-of-member").text(a.field.numEndpoints())},e.prototype.unmark=function(e){e=p.find(".container").find('td[data="'+e.getId()+'"]');e.find(".mask").css("visibility","hidden"),e.find(".toolbar").css("visibility","visible")},e.prototype.close=function(){0<n&&(clearInterval(n),n=0),p.modal("hide"),p.find(".header-tip").text(""),c.timer.forEach(function(e){clearTimeout(e)}),c.timer.splice(0,c.timer.length)},e.prototype.terminate=function(){s.app.callCtrl.hangupCall()||r.close()},e.prototype.appendContact=function(e){for(var t=0;t<i.length;++t)if(i[t].getId()==e.getId())return;i.push(e),this.updateLayout(i),p.find(".video-group-minisize .number-of-member").text(i.length)},e.prototype.removeContact=function(e){for(var t=0;t<i.length;++t)if(i[t].getId()==e.getId()){i.splice(t,1);break}this.updateLayout(i),p.find(".video-group-minisize .number-of-member").text(i.length)},e.prototype.updateLayout=function(e){var a=[],i=p.find(".container");e.forEach(function(e){var t=i.find('td[data="'+e.getId()+'"]');0<t.length?t.hasClass("colspan")&&(t.removeClass("colspan"),t.removeAttr("colspan")):t=$(['<td data="',e.getId(),'">','<div class="viewport"><video autoplay data-target="',e.getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e.context.avatar,');"><div>接入“',e.getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e.getPriorityName(),"</div></div>","</td>"].join("")),a.push(t)});var t=null,n=null;if(e.length<=2)t=['<table class="table table-borderless layout-pattern-1">',"<tr></tr>","</table>"],n=$(t.join("")),a.forEach(function(e){n.find("tr").append(e)}),p.css("height","366px");else if(3==e.length){var t=['<table class="table table-borderless layout-pattern-1">',"<tr></tr>","<tr></tr>","</table>"],n=$(t.join("")),o=a[0];o.attr("colspan","2"),o.addClass("colspan"),n.find("tr").eq(0).append(o),n.find("tr").eq(1).append(a[1]),n.find("tr").eq(1).append(a[2]),p.css("height","606px")}else if(4==e.length){t=['<table class="table table-borderless layout-pattern-2">',"<tr></tr>","<tr></tr>","</table>"];o=(n=$(t.join(""))).find("tr").eq(0);o.append(a[0]),o.append(a[1]);o=n.find("tr").eq(1);o.append(a[2]),o.append(a[3]),p.css("height","606px")}else if(5<=e.length){var l=parseInt(Math.ceil(e.length/3)),s=0;for(t=['<table class="table table-borderless layout-pattern-3">'];s<l;)t.push("<tr></tr>"),++s;t.push("</table>"),n=$(t.join(""));for(var s=0,r=0;r<l;++r)for(var c=n.find("tr").eq(r),d=0;d<3;++d)c.append(a[s]),++s;p.css("height","406px")}i.empty(),i.append(n)},e.prototype.resetLayout=function(t){i=[];for(var e=0;e<t.length;++e){var a=t[e];s.app.getContact(a,function(e){i.push(e),i.length==t.length&&r.doLayout(i)})}},e.prototype.doLayout=function(e){var t=null;if(2==e.length)t=['<table class="table table-borderless layout-pattern-1">',"<tr>",'<td data="',e[0].getId(),'">','<div class="viewport"><video autoplay data-target="',e[0].getId(),'"></video></div>','<div class="toolbar"><div class="name">',e[0].getPriorityName(),"</div></div>","</td>",'<td data="',e[1].getId(),'">','<div class="viewport"><video autoplay data-target="',e[1].getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e[1].context.avatar,');"><div>正在邀请“',e[1].getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e[1].getPriorityName(),"</div></div>","</td>","</tr>","</table>"],p.css("height","366px");else if(3==e.length)t=['<table class="table table-borderless layout-pattern-1">',"<tr>",'<td colspan="2" class="colspan" data="',e[0].getId(),'">','<div class="viewport"><video autoplay data-target="',e[0].getId(),'"></video></div>','<div class="toolbar"><div class="name">',e[0].getPriorityName(),"</div></div>","</td>","</tr>","<tr>",'<td data="',e[1].getId(),'">','<div class="viewport"><video autoplay data-target="',e[1].getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e[1].context.avatar,');"><div>正在邀请“',e[1].getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e[1].getPriorityName(),"</div></div>","</td>",'<td data="',e[2].getId(),'">','<div class="viewport"><video autoplay data-target="',e[2].getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e[2].context.avatar,');"><div>正在邀请“',e[2].getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e[2].getPriorityName(),"</div></div>","</td>","</tr>","</table>"],p.css("height","606px");else if(4==e.length)t=['<table class="table table-borderless layout-pattern-2">',"<tr>",'<td data="',e[0].getId(),'">','<div class="viewport"><video autoplay data-target="',e[0].getId(),'"></video></div>','<div class="toolbar"><div class="name">',e[0].getPriorityName(),"</div></div>","</td>",'<td data="',e[1].getId(),'">','<div class="viewport"><video autoplay data-target="',e[1].getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e[1].context.avatar,');"><div>正在邀请“',e[1].getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e[1].getPriorityName(),"</div></div>","</td>","</tr>","<tr>",'<td data="',e[2].getId(),'">','<div class="viewport"><video autoplay data-target="',e[2].getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e[2].context.avatar,');"><div>正在邀请“',e[2].getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e[2].getPriorityName(),"</div></div>","</td>",'<td data="',e[3].getId(),'">','<div class="viewport"><video autoplay data-target="',e[3].getId(),'"></video></div>','<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/',e[3].context.avatar,');"><div>正在邀请“',e[3].getPriorityName(),"”...</div></div>",'<div class="toolbar"><div class="name">',e[3].getPriorityName(),"</div></div>","</td>","</tr>","</table>"],p.css("height","606px");else if(5<=e.length){for(var t=['<table class="table table-borderless layout-pattern-3">'],a=3,i=parseInt(Math.ceil(e.length/a)),n=0;0<i;){for(t.push("<tr>");0<a;){var o=e[n],o=['<td data="',o.getId(),'">','<div class="viewport"><video autoplay data-target="',o.getId(),'"></video></div>',0!=n?'<div class="mask" style="background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)), url(images/'+o.context.avatar+');"><div>正在邀请“'+o.getPriorityName()+"”...</div></div>":"",'<div class="toolbar"><div class="name">',o.getPriorityName(),"</div></div>","</td>"];if(t.push(o.join("")),--a,++n>=e.length)break}if(t.push("</tr>"),--i,a=3,n>=e.length)break}t.push("</table>"),p.css("height","406px")}p.find(".container").html(t.join(""))},e.prototype.minimize=function(){var e=s.app.getSelf().getId(),t=p.find('video[data-target="'+e+'"]'),a=p.find(".video-group-minisize"),i=p.find(".video-group-default"),e=a.find(".viewport");e.empty(),t.remove(),e.append(t),p.addClass("video-group-panel-mini"),i.css("visibility","collapse"),a.css("visibility","visible"),i.insertAfter(a)},e.prototype.restore=function(){var e=s.app.getSelf().getId(),t=p.find('video[data-target="'+e+'"]'),a=p.find(".video-group-minisize"),i=p.find(".video-group-default");t.remove(),p.find('td[data="'+e+'"]').find(".viewport").append(t),p.removeClass("video-group-panel-mini"),i.css("visibility","visible"),a.css("visibility","collapse"),a.insertAfter(i)},e.prototype.openInviteToast=function(e){e=['<div class="toasts-info">                <div class="info-box">                    <span class="info-box-icon"><img src="images/group-avatar.png" /></span>                    <div class="info-box-content">                        <span class="info-box-text">',e.getName(),'</span>                        <span class="info-box-desc">邀请您参与群组视频通话</span>                    </div>                </div>                <div class="call-answer">                    <button type="button" class="btn btn-danger" onclick="javascript:app.callCtrl.rejectInvitation();"><i class="ci ci-hangup"></i> 拒绝</button>                    <button type="button" class="btn btn-success" onclick="javascript:app.callCtrl.acceptInvitation();"><i class="ci ci-answer"></i> 加入</button>                </div>            </div>'];$(document).Toasts("create",{title:"视频通话邀请",position:"bottomRight",icon:"fas fa-video",close:!1,class:"video-new-call",body:e.join("")}),s.app.mainPanel.playCallRing()},e.prototype.closeInviteToast=function(){$("#toastsContainerBottomRight").find(".video-new-call").remove(),s.app.mainPanel.stopCallRing()},e.prototype.fireInviteTimeout=function(e){var t,a=c.list.indexOf(e);0<=a&&(t=c.timer[a],clearTimeout(t),c.list.splice(a,1),c.timer.splice(a,1)),s.app.getContact(e,function(e){r.removeContact(e)})},s.VideoGroupChatPanel=e}(window),function(n){function t(){a.getId()==n.app.getSelf().getId()?dialog.showPrompt("修改我的昵称","请输入新昵称：",function(e,t){if(e){if(t.length<3)return n.dialog.launchToast(Toast.Warning,"昵称至少3个字符"),!1;n.cube().contact.modifyContact(t,null,function(i){i.getName()==t?$.ajax({type:"POST",url:server.url+"/account/info/",data:{name:t,token:n.token},dataType:"json",success:function(e,t,a){null!=e&&(i.context=e,n.app.updateContact(i),n.app.sidebarAccountPanel.updateName(i.getName()),o.find(".widget-user-username").text(e.name))},error:function(e,t){console.log(t)}}):n.dialog.launchToast(Toast.Warning,"不被允许使用的新昵称")},function(e){n.dialog.launchToast(Toast.Warning,"不允许修改昵称"),console.log(e)})}}):dialog.showPrompt("修改联系人备注","请输入“"+a.getName()+"”的备注名：",function(e,t){e&&a.getAppendix().updateRemarkName(t,function(e){dialog.launchToast(Toast.Success,"已修改联系人备注名"),o.find(".widget-user-username").text(e.hasRemarkName()?e.getRemarkName():a.getName()),n.app.messagingCtrl.updateContact(a)},function(e){dialog.launchToast(Toast.Success,"修改联系人备注名失败: "+e.code)})},a.getAppendix().getRemarkName())}function e(e){(i=(o=e).find('button[data-target="edit-remarkname"]')).click(t)}var o=null,i=null,a=null;e.prototype.show=function(e){function t(e){var t=o,a=e.getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():e.getName();t.find(".widget-user-username").text(a),t.find(".user-avatar").attr("src",n.helper.getAvatarImage(e.getContext().avatar)),t.find(".user-id").text(e.getId()),t.find(".user-region").text(e.getContext().region),t.find(".user-department").text(e.getContext().department),e.getId()==n.app.getSelf().getId()?(i.attr("title","修改昵称"),t.find(".widget-user-desc").text("")):(i.attr("title","修改备注"),t.find(".widget-user-desc").text(e.getName())),t.modal("show")}e instanceof Contact?t(a=e):n.app.getContact(e,function(e){null!=(a=e)&&t(a)})},e.prototype.hide=function(){o.modal("hide")},n.ContactDetails=e}(window),function(c){function t(){c.dialog.showPrompt("修改群名称","请输入新的群组名",function(e,t){if(e){if(!(3<=t.length))return c.dialog.showAlert("输入的群组名称不能少于3个字符。"),!1;c.app.messagingCtrl.modifyGroupName(o,t,function(e){s.text(e.getName())})}})}function a(){var a=c.app.getMyContacts();o.getMembers(function(t,e){c.app.contactListDialog.show(a,t,function(e){return a.length==t.length+1||(0==e.length?(c.dialog.showAlert("没有选择联系人"),!1):(o.addMembers(e,function(){c.app.groupDetails.refresh()},function(e){c.dialog.launchToast(Toast.Error,"添加群组成员失败: "+e.code)}),!0))})})}function i(){o.isOwner()?c.dialog.showAlert("您是该群组的群主，不能退出该群。",null,"我知道了"):c.dialog.showConfirm("退出群组","您确定要退出“"+o.getName()+"”群组吗？",function(e){e&&window.cube().contact.quitGroup(o,function(){c.app.messagingCtrl.removeGroup(o),c.app.groupDetails.hide()},function(e){c.dialog.launchToast(Toast.Error,"退出群组失败: "+e.code)})})}function n(){o.isOwner()?c.dialog.showConfirm("解散群组","您确定要解散“"+o.getName()+"”群组吗？",function(e){e&&window.cube().contact.dissolveGroup(o,function(e){c.app.groupDetails.hide()},function(e){c.dialog.launchToast(Toast.Error,"解散群组失败: "+e.code)})}):c.dialog.showAlert("您不是该群组的群主，不能解散该群。",null,"我知道了")}function e(e){this.el=e,s=e.find(".widget-user-username"),(r=$("#group_details_modify")).click(t),(d=$("#group_details_add")).click(a),(p=$("#group_details_quit")).click(i),(u=$("#group_details_dissolve")).click(n)}var o=null,l=0,s=null,r=null,d=null,p=null,u=null;e.prototype.show=function(e){var t,a;null==o||o.getId()!=e.getId()||e.getLastActiveTime()!=l?(l=(o=e).getLastActiveTime(),t=this.el,s.text(e.getName()),r.attr("data",e.getId()),d.attr("data",e.getId()),p.attr("data",e.getId()),u.attr("data",e.getId()),(a=t.find(".table")).find("tbody").remove(),this.createGroupDetailsTable(e,function(e){a.append(e),t.modal("show")})):this.el.modal("show")},e.prototype.hide=function(){this.el.modal("hide")},e.prototype.refresh=function(){var t,a;null!=o&&(t=this.el,(a=t.find(".table")).find("tbody").remove(),this.createGroupDetailsTable(o,function(e){a.append(e),t.modal("show")}))},e.prototype.createGroupDetailsTable=function(e,o){var l=$("<tbody></tbody>"),s=e.isOwner(),r=(r=["app.contactsCtrl.removeGroupMember(","parseInt($(this).attr('data-group')),","parseInt($(this).attr('data-member'))",");"]).join("");e.getMembers(function(e,t){for(var a=0;a<e.length;++a){var i=e[a],n=s?['<button class="btn btn-danger btn-xs" onclick="',r,'"',' data-member="',i.getId(),'"',' data-group="',t.getId(),'"',' data-original-title="从本群中移除" data-placement="top" data-toggle="tooltip"><i class="fas fa-minus"></i></button>']:[],n=(n=s&&i.equals(c.app.getSelf())?[]:n).join(""),i=c.app.queryContact(i.getId()),n=["<tr>","<td>",a+1,"</td>",'<td><img class="table-avatar" src="',c.helper.getAvatarImage(i.getContext().avatar),'" /></td>',"<td>",i.getPriorityName(),"</td>","<td>",i.getId(),"</td>","<td>",i.getContext().region,"</td>","<td>",i.getContext().department,"</td>","<td>",n,"</td>","</tr>"],n=$(n.join(""));l.append(n)}o(l)})},c.GroupDetails=e}(window),function(l){"use strict";function e(e){c=(r=e).find('div[data-target="my-contacts"]'),d=e.find('input[data-target="group-name"]'),e.find('button[data-target="confirm"]').click(function(){var e=d.val().trim();0==e.length&&(e=l.app.getSelf().getName()+"创建的群组");var a=[];c.find('input[type="checkbox"]:checked').each(function(e,t){a.push(parseInt($(t).attr("data")))}),0!=a.length?window.cube().contact.createGroup(e,a,function(e){l.app.messageCatalog.appendItem(e),r.modal("hide")},function(e){l.dialog.launchToast(Toast.Error,"创建群组失败: "+e.code)}):l.dialog.showAlert("请选择群组成员。",null,"我知道了")})}var s,r=null,c=null,d=null;e.prototype.show=function(e){s=l.app.getMyContacts(),d.val(""),c.empty();for(var t=0;t<s.length;++t){var a=s[t],i=a.getId(),n=l.helper.getAvatarImage(a.getContext().avatar),o=a.getPriorityName(),a=void 0!==e&&0<=e.indexOf(i);c.append($(['<div class="col-6"><div class="form-group"><div class="custom-control custom-checkbox select-group-member">','<input class="custom-control-input" type="checkbox"',a?' checked="checked"':"",' id="group_member_',t,'" data="',i,'" />','<label class="custom-control-label" for="group_member_',t,'">','<img src="',n,'" />',"<span>",o,"</span>","</label>","</div></div></div>"].join("")))}r.modal("show")},l.NewGroupDialog=e}(window),function(d){"use strict";var p=null,u=null,g=-1,f=[],m=null;function h(e,t){for(var a="number"==typeof e?e:e.getId(),i=0;i<t.length;++i){var n=t[i];if(n.getId()==a)return n}return null}function e(){var a,e;null!=m&&(a=[],p.find("tbody").find('input[type="checkbox"]:checked').each(function(e,t){t=parseInt($(t).attr("data"));null==h(t,u)&&a.push(t)}),void 0!==(e=m(a))&&!e||(p.modal("hide"),m=null))}function t(){(p=$("#contact_list_dialog")).find('button[data-target="confirm"]').click(e)}t.prototype.show=function(e,t,a,i,n,o){u=t,g=void 0!==o?o:-1,f.splice(0,f.length),i?p.find(".modal-title").text(i):p.find(".modal-title").text("联系人列表"),n?p.find(".tip").text(n):p.find(".tip").text("请选择联系人"),a&&(m=a);a=p.find("tbody");a.empty();for(var l=[],s=0;s<e.length;++s)var r=e[s],c=null!=h(r,t),r=['<tr onclick="app.contactListDialog.toggleChecked(',r.getId(),')">',"<td>",'<div class="custom-control custom-checkbox">','<input class="custom-control-input" type="checkbox" data="',r.getId(),'" id="list_contact_',r.getId(),'"',c?' checked="checked" disabled="disabled"':"",">","</input>",'<label class="custom-control-label" for="list_contact_',r.getId(),'">',"</label>","</div>","</td>",'<td><img class="table-avatar" src="',d.helper.getAvatarImage(r.getContext().avatar),'" /></td>',"<td>",r.getName(),"</td>","<td>",r.getId(),"</td>","<td>",r.getContext().region,"</td>","<td>",r.getContext().department,"</td>","</tr>"],l=l.concat(r);a.append(l.join("")),p.modal("show")},t.prototype.hide=function(){p.modal("hide"),m=null},t.prototype.toggleChecked=function(e){var t,a=p.find('input[data="'+e+'"]');a.prop("checked")?(a.prop("checked",!1),0<=(t=f.indexOf(e))&&f.splice(t,1)):(a.prop("checked",!0),(t=f.indexOf(e))<0&&f.push(e)),0<g&&setTimeout(function(){var e;f.length>g&&(e=f.pop(),p.find('input[data="'+e+'"]').prop("checked",!1),d.dialog.launchToast(Toast.Info,"最多只能选择"+g+"个联系人"))},10)},d.ContactListDialog=t}(window),function(p){var i=null,u=null,t=null,a=null,n=null,o=!0,l=!0;function s(e){i.onNewMessage(e.data)}function r(e){e=e.data;p.app.messagePanel.appendMessage(p.app.messagePanel.current.entity,p.app.getSelf(),e,!0,!0),e.isFromGroup()?p.app.messageCatalog.updateItem(e.getSource(),e,e.getRemoteTimestamp()):p.app.messageCatalog.updateItem(e.getTo(),e,e.getRemoteTimestamp())}function c(e){p.app.messagePanel.changeMessageState(e.data),p.app.messagePanel.refreshMessage(p.app.getSelf(),e.data)}function d(e){e=e.data;p.app.messagePanel.appendMessage(e.getReceiver(),p.app.getSelf(),e,!0)}function g(e){var t=e.data;p.app.messagePanel.changeMessageState(t);e=new LocalNoteMessage("“"+t.getReceiver().getName()+"”在你的“黑名单”里，不能向他发送消息！");e.setLevel(3),u.messaging.markLocalOnlyOwner(t.getReceiver(),e)}function f(e){var t=e.data;p.app.messagePanel.changeMessageState(t);e=new LocalNoteMessage("“"+t.getReceiver().getName()+"”已拒收你的消息！");e.setLevel(3),u.messaging.markLocalOnlyOwner(t.getReceiver(),e)}function m(e){e.data.data}function h(e){var t=e.data,e=t.getAppendix().getCommId();0!=e?u.mpComm.getCommField(e,function(e){e.mediaConstraint.videoEnabled?p.app.messageCatalog.updateState(t.getId(),"video"):p.app.messageCatalog.updateState(t.getId(),"audio"),p.app.messagePanel.refreshStateBar()}):(p.app.messageCatalog.updateState(t.getId()),p.app.messagePanel.refreshStateBar())}function e(e){u=e,i=this,$("#col_messaging_catalog"),a=$("#col_messaging_content"),(n=$("#col_messaging_sidebar")).hasClass("no-display")||n.addClass("no-display"),u.messaging.on(MessagingEvent.Sending,r),u.messaging.on(MessagingEvent.Sent,c),u.messaging.on(MessagingEvent.Notify,s),u.messaging.on(MessagingEvent.MarkOnlyOwner,d),u.messaging.on(MessagingEvent.SendBlocked,g),u.messaging.on(MessagingEvent.ReceiveBlocked,f),u.messaging.on(MessagingEvent.Fault,m),u.contact.on(ContactEvent.GroupAppendixUpdated,h)}e.prototype.ready=function(){p.app.messageCatalog.refreshOrder();for(var e=p.app.messageCatalog.getEntityList(),t=0;t<e.length;++t){var a=e[t];a instanceof Group&&(0!=(a=a.getAppendix().getCommId())&&u.mpComm.getCommField(a,function(e){e.mediaConstraint.videoEnabled?p.app.messageCatalog.updateState(e.group.getId(),"video"):p.app.messageCatalog.updateState(e.group.getId(),"audio")}))}},e.prototype.fireJoin=function(){var e,t=p.app.messagePanel.getCurrentPanel();null==t||!t.groupable||0!=(e=t.entity.getAppendix().getCommId())&&u.mpComm.getCommField(e,function(e){e.hasJoin()?p.dialog.launchToast(Toast.Info,"您已经加入了当前群通话。"):p.app.callCtrl.launchGroupCall(t.entity,e.mediaConstraint.videoEnabled)})},e.prototype.updateContactMessages=function(e,s){var r;e.getId()!=p.app.account.id&&(r=0,u.messaging.queryRecentMessagesWithContact(e,10,function(e,t){if(0!=(r=t.length)){for(var a,i=0,n=0;n<t.length;++n){var o=t[n];a=o,u.messaging.isSender(a)?p.app.messagePanel.appendMessage(a.getReceiver(),a.getSender(),a,!0):p.app.messagePanel.appendMessage(a.getSender(),a.getSender(),a,!0),--r,s&&0==r&&s(),o.isRead()||++i}for(n=t.length-1;0<=n;--n){var l=t[n];if(p.app.messageCatalog.updateItem(e,l,l.getRemoteTimestamp())){0<i&&p.app.messageCatalog.updateBadge(e,i);break}}}else s&&s()}))},e.prototype.updateGroupMessages=function(l,s){var r=0,c=null,d=new OrderMap;u.messaging.queryRecentMessagesWithGroup(l,10,function(e,t){if(0!=(r=t.length)){c=t;for(var a=0,i=0;i<t.length;++i){var n=t[i];!function(a,t){p.app.getContact(t.getFrom(),function(e){d.put(t.getId(),e),0==--r&&(c.forEach(function(e){var t=d.get(e.getId());p.app.messagePanel.appendMessage(a,t,e,!0)}),c=null,d.clear(),d=null,s&&s())})}(l,n),n.isRead()||++a}for(i=t.length-1;0<=i;--i){var o=t[i];if(p.app.messageCatalog.updateItem(e,o,o.getRemoteTimestamp())){0<a&&p.app.messageCatalog.updateBadge(e,a);break}}}else s&&s()})},e.prototype.updateContact=function(e){p.app.messagePanel.updatePanel(e.getId(),e),p.app.messageCatalog.updateItem(e,null,null,e.getAppendix().hasRemarkName()?e.getAppendix().getRemarkName():e.getName()),p.app.messageSidebar.update(group)},e.prototype.updateGroup=function(e){p.app.messagePanel.updatePanel(e.getId(),e),p.app.messageCatalog.updateItem(e,null,null,e.getName()),p.app.messageSidebar.update(e)},e.prototype.selectFile=function(e){null==t&&(t=e).on("change",function(e){e=e.target.files[0];i.fireSend(p.app.messagePanel.current.entity,e)}),t.click()},e.prototype.fireSend=function(e,t){if(e instanceof Group&&e.getState()!=GroupState.Normal)return null;var a=null;if("string"==typeof t)a=new HyperTextMessage(t);else{if(!(t instanceof File))return p.dialog.launchToast(Toast.Warning,"程序内部错误"),null;a=new(0<=t.type.indexOf("image")?ImageMessage:FileMessage)(t)}return a=u.messaging.sendTo(e,a)},e.prototype.toggle=function(t){var a;t!=p.app.account.id&&(a=function(e){null!=e&&(p.app.messagePanel.changePanel(t,e),p.app.messageCatalog.activeItem(t),p.app.messageCatalog.updateBadge(t,0))},p.app.getGroup(t,function(e){null==e?p.app.getContact(t,function(e){a(e),p.app.messageSidebar.update(e),l?i.showSidebar():i.hideSidebar()}):(a(e),p.app.messageSidebar.update(e),o?i.showSidebar():i.hideSidebar())}))},e.prototype.toggleSidebar=function(){n.hasClass("no-display")?(this.showSidebar(),p.app.messagePanel.getCurrentPanel().groupable?o=!0:l=!0):(this.hideSidebar(),p.app.messagePanel.getCurrentPanel().groupable?o=!1:l=!1)},e.prototype.showSidebar=function(){n.hasClass("no-display")&&(a.removeClass("col-md-9"),a.removeClass("col-sm-10"),a.addClass("col-md-6"),a.addClass("col-sm-6"),n.removeClass("no-display"))},e.prototype.hideSidebar=function(){n.hasClass("no-display")||(a.removeClass("col-md-6"),a.removeClass("col-sm-6"),a.addClass("col-md-9"),a.addClass("col-sm-10"),n.addClass("no-display"))},e.prototype.showGroupMember=function(){},e.prototype.recallMessage=function(t,e){u.messaging.recallMessage(e,function(e){p.app.messagePanel.appendNote(t,"消息已撤回 "+p.formatFullTime(Date.now())),p.app.messagePanel.removeMessage(t,e)},function(e){p.dialog.launchToast(Toast.Error,e.code==MessagingServiceState.DataTimeout?"消息发送超过2分钟，不能撤回":"撤回消息失败"),console.log("撤回消息失败 - "+e)})},e.prototype.deleteMessage=function(t,e){u.messaging.deleteMessage(e,function(e){p.dialog.launchToast(Toast.Success,"消息已删除"),p.app.messagePanel.removeMessage(t,e)},function(e){p.dialog.launchToast(Toast.Error,"删除消息失败"),console.log("删除消息失败 - "+e)})},e.prototype.prependMore=function(e){var a=p.app.messagePanel.getPanel(e),t=0==a.messageTimes.length?Date.now():a.messageTimes[0]-1,i=10;a.groupable?u.messaging.reverseIterateMessageWithGroup(e,t,function(e,t){return p.app.messagePanel.appendMessage(a.entity,t.getSender(),t,!1),0!=--i},function(){10==i&&p.dialog.launchToast(Toast.Info,"没有更多消息了")}):u.messaging.reverseIterateMessageWithContact(e,t,function(e,t){return p.app.messagePanel.appendMessage(a.entity,t.getSender(),t,!1),0!=--i},function(){10==i&&p.dialog.launchToast(Toast.Info,"没有更多消息了")})},e.prototype.openVoiceCall=function(e){e instanceof Group?p.app.callCtrl.launchGroupCall(e,!1):p.app.callCtrl.callContact(e,!1)},e.prototype.openVideoChat=function(e){e instanceof Group?p.app.callCtrl.launchGroupCall(e,!0):p.app.callCtrl.callContact(e,!0)},e.prototype.onNewMessage=function(e){e.isFromGroup()?(p.app.messagePanel.hasPanel(e.getSourceGroup())?p.app.messagePanel.appendMessage(e.getSourceGroup(),e.getSender(),e):i.updateGroupMessages(e.getSourceGroup(),function(){p.app.messagePanel.appendMessage(e.getSourceGroup(),e.getSender(),e,!1)}),p.app.messageCatalog.updateItem(e.getSourceGroup(),e,e.getRemoteTimestamp())||console.debug("#onNewMessage - update catalog item failed"),i.updateUnread(e.getSource(),e)):p.app.account.id==e.getFrom()?(p.app.messagePanel.hasPanel(e.getReceiver())?p.app.messagePanel.appendMessage(e.getReceiver(),e.getSender(),e):i.updateContactMessages(e.getReceiver(),function(){p.app.messagePanel.appendMessage(e.getReceiver(),e.getSender(),e,!1)}),p.app.messageCatalog.updateItem(e.getReceiver(),e,e.getRemoteTimestamp()),i.updateUnread(e.getTo(),e)):(p.app.messagePanel.hasPanel(e.getSender())?p.app.messagePanel.appendMessage(e.getSender(),e.getSender(),e,!1):i.updateContactMessages(e.getSender(),function(){p.app.messagePanel.appendMessage(e.getSender(),e.getSender(),e,!1)}),p.app.messageCatalog.updateItem(e.getSender(),e,e.getRemoteTimestamp()),i.updateUnread(e.getFrom(),e))},e.prototype.updateUnread=function(e,t){var a;t.isRead()||(null==(a=p.app.messagePanel.getCurrentPanel())||a.id!=e?void 0!==(a=p.app.messagePanel.getPanel(e))&&0<a.unreadCount&&p.app.messageCatalog.updateBadge(e,a.unreadCount):u.messaging.markRead(t))},e.prototype.modifyGroupName=function(e,t,a){e.modifyName(t,function(e){p.dialog.launchToast(Toast.Success,"已修改群组名称"),a&&a(e)},function(e){p.dialog.launchToast(Toast.Warning,"修改群名称失败: "+e.code)})},e.prototype.removeGroup=function(e){p.app.messageCatalog.removeItem(e),p.app.messagePanel.clearPanel(e.getId()),this.hideSidebar(),u.messaging.deleteRecentMessager(e)},e.prototype.removeContact=function(e){p.app.messageCatalog.removeItem(e),p.app.messagePanel.clearPanel(e.getId()),this.hideSidebar(),u.messaging.deleteRecentMessager(e)},p.MessagingController=e}(window),function(o){var a,l=null,r=null,c=null,d=!1,p=[],u=-1,s=!1,g=!1,i=!1,n=1,f=0;function t(e){var t=e.data,e=t.getCaller();null!=e&&(t.callerMediaConstraint.videoEnabled?(s=!(g=!1),o.app.videoChatPanel.openNewCallToast(e)):(s=g=!0,o.app.voiceCallPanel.openNewCallToast(e)))}function m(e){e=e.data;null!=e.group&&(s?o.dialog.launchToast(Toast.Warning,"收到来自“"+e.group.getName()+"”通话邀请"):((e.mediaConstraint.videoEnabled?o.app.videoGroupChatPanel:o.app.voiceGroupCallPanel).openInviteToast(e.group),f=setTimeout(function(){a.rejectInvitation()},3e4)))}function h(e){o.app.getContact(e.data.contact.getId(),function(e){(g?o.app.voiceGroupCallPanel:o.app.videoGroupChatPanel).appendContact(e)}),o.app.messagePanel.refreshStateBar()}function v(e){o.app.getContact(e.data.contact.getId(),function(e){(g?o.app.voiceGroupCallPanel:o.app.videoGroupChatPanel).removeContact(e)}),o.app.messagePanel.refreshStateBar()}function b(e){e=e.data;(g?o.app.voiceGroupCallPanel:o.app.videoGroupChatPanel).unmark(e.contact)}function C(e){}function y(e){console.log("#onInProgress")}function w(e){i?(g?o.app.voiceGroupCallPanel:o.app.videoGroupChatPanel).tipWaitForAnswer(e.data):(g?o.app.voiceCallPanel:o.app.videoChatPanel).tipWaitForAnswer(e.data.getCallee())}function T(e){i?((g?o.app.voiceGroupCallPanel:o.app.videoGroupChatPanel).tipConnected(e.data),o.app.messagePanel.refreshStateBar()):(g?o.app.voiceCallPanel:o.app.videoChatPanel).tipConnected(e.data)}function x(e){console.log("#onMediaConnected")}function I(e){console.log("#onMediaDisconnected")}function k(e){var t=e.data;s=!1,i?(g?(o.app.voiceGroupCallPanel.close(),o.dialog.launchToast(Toast.Info,"群组语音通话已结束")):(o.app.videoGroupChatPanel.close(),o.dialog.launchToast(Toast.Info,"群组视频通话已结束")),o.app.messagePanel.refreshStateBar(),0<f&&(clearTimeout(f),f=0)):((g?o.app.voiceCallPanel:o.app.videoChatPanel).close(),t.isCaller()&&(e=new CallRecordMessage(t),l.messaging.sendTo(t.getCallee(),e)),t=1e3<(t=t.getDuration())?"通话结束 - "+o.formatClockTick(parseInt(t/1e3)):"通话结束",console.log(t),o.dialog.launchToast(Toast.Info,t))}function P(e){var t=e.data;s=!1;e=null,e=t.isCaller()?"被叫忙，拒绝通话":"已拒绝通话邀请";console.log(e),o.dialog.launchToast(Toast.Info,e),g?(o.app.voiceCallPanel.close(),o.app.voiceCallPanel.closeNewCallToast()):(o.app.videoChatPanel.close(),o.app.videoChatPanel.closeNewCallToast())}function S(e){i||(g?(o.app.voiceCallPanel.close(),o.app.voiceCallPanel.closeNewCallToast()):(o.app.videoChatPanel.close(),o.app.videoChatPanel.closeNewCallToast()),e.data.isCaller()&&o.dialog.launchToast(Toast.Info,"对方无应答"))}function M(e){var t=e.data;s=!1,console.log("onFailed - "+t),t.code==CallState.MediaPermissionDenied?g?o.dialog.launchToast(Toast.Warning,"未能获得麦克风使用权限"):o.dialog.launchToast(Toast.Warning,"未能获得摄像头/麦克风使用权限"):t.code==CallState.BeCallerBlocked?o.dialog.showAlert("你已经把“"+t.data.field.callee.getName()+"”添加到黑名单里，不能邀请他通话！"):t.code==CallState.BeCalleeBlocked?o.dialog.showAlert("“"+t.data.field.callee.getName()+"”已经阻止了你的通话邀请！"):(o.dialog.launchToast(Toast.Warning,"通话失败，故障码："+t.code),a.hangupCall()),setTimeout(function(){i?console.log("#onFailed: "+t.code):g?(o.app.voiceCallPanel.close(),o.app.voiceCallPanel.closeNewCallToast()):(o.app.videoChatPanel.close(),o.app.videoChatPanel.closeNewCallToast())},500)}function e(e){a=this,(l=e).mpComm.on(CommEvent.NewCall,t),l.mpComm.on(CommEvent.Invited,m),l.mpComm.on(CommEvent.InProgress,y),l.mpComm.on(CommEvent.Ringing,w),l.mpComm.on(CommEvent.Connected,T),l.mpComm.on(CommEvent.Bye,k),l.mpComm.on(CommEvent.Arrived,h),l.mpComm.on(CommEvent.Left,v),l.mpComm.on(CommEvent.Followed,b),l.mpComm.on(CommEvent.Unfollowed,C),l.mpComm.on(CommEvent.Busy,P),l.mpComm.on(CommEvent.Timeout,S),l.mpComm.on(CommEvent.Failed,M),l.mpComm.on(CommEvent.MediaConnected,x),l.mpComm.on(CommEvent.MediaDisconnected,I)}e.prototype.showSelectMediaDevice=function(e,t){var a;if(c=t,u=-1,d=!!e[0].isVideoInput(),null==r&&((a=$("#select_media_device")).find('button[data-target="cancel"]').click(function(){for(var e=0;e<p.length;++e)if(void 0===p[e].stream)return;u=-1,r.modal("hide")}),a.find('button[data-target="confirm"]').click(function(){for(var e=0;e<p.length;++e)if(void 0===(t=p[e]).stream)return;var t=r.find(d?'input:radio[name="VideoDevice"]:checked':'input:radio[name="AudioDevice"]:checked').attr("data");u=parseInt(t),r.modal("hide")}),a.on("hide.bs.modal",function(){if(0<p.length){for(var e=0;e<p.length;++e){var t=p[e];MediaDeviceTool.stopStream(t.stream,t.videoEl)}p.splice(0,p.length)}0<=u?setTimeout(function(){c(!0,u)},1e3):setTimeout(function(){c(!1)},500)}),r=a),d){(a=r.find(".modal-dialog")).hasClass("modal-lg")||a.addClass("modal-lg"),r.find('div[data-target="audio"]').css("display","none");var i=r.find('div[data-target="video"]');i.css("display","flex"),i.find(".col-6").css("display","none"),e.forEach(function(e,t){t=i.find('div[data-target="video-'+t+'"]');t.find("label").text(e.label),p.push({device:e}),MediaDeviceTool.loadVideoDeviceStream(t.find("video")[0],e,!1,function(e,t,a){for(var i=0;i<p.length;++i)if(p[i].device==t){p[i]={videoEl:e,device:t,stream:a};break}},function(e){console.log(e)}),t.css("display","block")})}else{r.find(".modal-dialog").removeClass("modal-lg"),r.find('div[data-target="video"]').css("display","none");var n=r.find('div[data-target="audio"]');n.css("display","block"),n.find(".custom-radio").css("display","none");for(var o=0;o<e.length;++o){var l=e[o],s=n.find('div[data-target="audio-'+o+'"]');s.find("label").text(l.label),s.css("display","block")}}r.modal("show")},e.prototype.callContact=function(t,a){i=!1,l.contact.queryBlockList(function(e){0<=e.indexOf(t.getId())?o.dialog.showAlert("你已经把“"+t.getName()+"”添加到黑名单里，不能邀请他通话！"):(a?o.app.videoChatPanel:o.app.voiceCallPanel).open(t)})},e.prototype.launchGroupCall=function(e,t){var a;e.getState()==GroupState.Normal?(a=function(){i=!0,g=!t,(t?o.app.videoGroupChatPanel:o.app.voiceGroupCallPanel).open(e)},0!=e.getAppendix().getCommId()?l.mpComm.getCommField(e,function(e){e.mediaConstraint.videoEnabled==t?a():o.dialog.launchToast(Toast.Info,"当前群组正在通话")}):a()):o.dialog.showAlert("群组“"+e.getName()+"”已不存在！")},e.prototype.makeCall=function(e,t,a,i){if(s)return!1;s=!0,g=!t;var n=new MediaConstraint(t,!0);return e instanceof Contact?(t?(l.mpComm.setRemoteVideoElement(o.app.videoChatPanel.remoteVideo),l.mpComm.setLocalVideoElement(o.app.videoChatPanel.localVideo),a&&n.setVideoDevice(a)):(l.mpComm.setRemoteVideoElement(o.app.voiceCallPanel.remoteVideo),l.mpComm.setLocalVideoElement(o.app.voiceCallPanel.localVideo),a&&n.setAudioDevice(a)),l.mpComm.makeCall(e,n,i)):e instanceof Group&&(t?(n.setVideoDimension(VideoDimension.VGA_IDEAL),l.mpComm.setLocalVideoElement(o.app.videoGroupChatPanel.localVideo),a&&n.setVideoDevice(a)):(l.mpComm.setLocalVideoElement(o.app.voiceGroupCallPanel.localVideo),l.mpComm.setRemoteVideoElement(o.app.voiceGroupCallPanel.remoteVideo),a&&n.setAudioDevice(a)),l.mpComm.makeCall(e,n,i))},e.prototype.answerCall=function(){if(!s)return!1;if(g){o.app.voiceCallPanel.closeNewCallToast(),l.mpComm.setRemoteVideoElement(o.app.voiceCallPanel.remoteVideo),l.mpComm.setLocalVideoElement(o.app.voiceCallPanel.localVideo);var e=new MediaConstraint(!1,!0);if(l.mpComm.answerCall(e))return o.app.voiceCallPanel.showAnswer(l.mpComm.getActiveRecord().getCaller()),!0}else{o.app.videoChatPanel.closeNewCallToast(),l.mpComm.setRemoteVideoElement(o.app.videoChatPanel.remoteVideo),l.mpComm.setLocalVideoElement(o.app.videoChatPanel.localVideo);e=new MediaConstraint(!0,!0);if(l.mpComm.answerCall(e))return o.app.videoChatPanel.showAnswer(l.mpComm.getActiveRecord().getCaller()),!0}return!1},e.prototype.hangupCall=function(){return!!s&&(s=!1,l.mpComm.hangupCall()||console.log("CallController : 终止通话时发生错误。"),i?(g?o.app.voiceGroupCallPanel:o.app.videoGroupChatPanel).close():g?(o.app.voiceCallPanel.close(),o.app.voiceCallPanel.closeNewCallToast()):(o.app.videoChatPanel.close(),o.app.videoChatPanel.closeNewCallToast()),!0)},e.prototype.acceptInvitation=function(){0<f&&(clearTimeout(f),f=0);var e=l.mpComm.getActiveRecord().field;e.mediaConstraint.videoEnabled?(o.app.videoGroupChatPanel.closeInviteToast(),o.app.videoGroupChatPanel.open(e.group)):(o.app.voiceGroupCallPanel.closeInviteToast(),o.app.voiceGroupCallPanel.open(e.group))},e.prototype.rejectInvitation=function(){0<f&&(clearTimeout(f),f=0),(l.mpComm.getActiveRecord().field.mediaConstraint.videoEnabled?o.app.videoGroupChatPanel:o.app.voiceGroupCallPanel).closeInviteToast()},e.prototype.isCameraOpened=function(){var e=o.cube().mpComm.getActiveField();if(null==e)return!1;e=e.getRTCDevice();return null!=e&&e.outboundVideoEnabled()},e.prototype.toggleCamera=function(){var e=l.mpComm.getActiveField();if(null==e)return console.debug("CallController - #toggleCamera() field is null"),!0;e=e.getRTCDevice();return null==e?(console.debug("CallController - #toggleCamera() rtcDevice is null"),!0):(e.outboundVideoEnabled()?e.enableOutboundVideo(!1):e.enableOutboundVideo(!0),e.outboundVideoEnabled())},e.prototype.isMicrophoneOpened=function(){var e=o.cube().mpComm.getActiveField();if(null==e)return!1;e=e.getRTCDevice();return null!=e&&e.outboundAudioEnabled()},e.prototype.toggleMicrophone=function(){var e=l.mpComm.getActiveField();if(null==e)return console.debug("CallController - #toggleMicrophone() field is null"),!0;e=e.getRTCDevice();return null==e?(console.debug("CallController - #toggleMicrophone() rtcDevice is null"),!0):(e.outboundAudioEnabled()?e.enableOutboundAudio(!1):e.enableOutboundAudio(!0),e.outboundAudioEnabled())},e.prototype.isUnmuted=function(){var e=o.cube().mpComm.getActiveField();if(null==e)return!1;e=e.getRTCDevice();return null!=e&&0<e.getVolume()},e.prototype.toggleLoudspeaker=function(){var e=l.mpComm.getActiveField();if(null==e)return console.debug("CallController - #toggleLoudspeaker() field is null"),!0;var t=e.getRTCDevice();if(null==t)return console.debug("CallController - #toggleLoudspeaker() rtcDevice is null"),!0;e=t.getVolume();return console.debug("CallController - #toggleLoudspeaker() volume is "+e),0<e?(n=e,t.setVolume(0),!1):(t.setVolume(n),!0)},o.CallController=e}(window),function(t){"use strict";function e(e,t,a){o=t,l=a,s=(n=e).find("#btn_all_files"),r=n.find("#btn_image_files"),c=n.find("#btn_doc_files"),d=n.find("#btn_recyclebin"),p=o.find("#btn_trans_upload"),u=o.find("#btn_trans_download"),g=o.find("#btn_trans_complete"),f=l.find("#btn_sharing"),m=l.find("#btn_sharing_expired"),h=s,i=this}var i=null,n=null,o=null,l=null,s=null,r=null,c=null,d=null,p=null,u=null,g=null,f=null,m=null,h=null,a=new OrderMap,v=[],b=0;e.prototype.prepare=function(){t.app.filePanel.showRoot(),s.click(function(){i.select($(this).attr("id"))}),r.click(function(){i.select($(this).attr("id"))}),c.click(function(){i.select($(this).attr("id"))}),d.click(function(){i.select($(this).attr("id"))}),p.click(function(){}),u.click(function(){}),g.click(function(){}),f.click(function(){i.select($(this).attr("id"))}),m.click(function(){i.select($(this).attr("id"))})},e.prototype.select=function(e){h.attr("id")!=e&&(h.removeClass("active"),s.attr("id")==e?(h=s,t.app.filePanel.showRoot(),t.app.fileSharingPanel.hide()):r.attr("id")==e?(h=r,t.app.filePanel.showImages(),t.app.fileSharingPanel.hide()):c.attr("id")==e?(h=c,t.app.filePanel.showDocuments(),t.app.fileSharingPanel.hide()):d.attr("id")==e?(h=d,t.app.filePanel.showRecyclebin(),t.app.fileSharingPanel.hide()):f.attr("id")==e?(h=f,t.app.fileSharingPanel.showSharingPanel(),t.app.filePanel.hide()):m.attr("id")==e&&(h=m,t.app.fileSharingPanel.showExpiresPanel(),t.app.filePanel.hide()),h.addClass("active"),t.app.filePanel.setTitle(h.attr("title")))},e.prototype.onFileUpload=function(e){a.put(e.name,e),p.find(".badge").text(a.size())},e.prototype.onFileUploading=function(e){},e.prototype.onFileUploaded=function(e){++b,g.find(".badge").text(b),a.remove(e.getFileName()),0<a.size()?p.find(".badge").text(a.size()):p.find(".badge").text("")},e.prototype.onFileDownload=function(e){v.contains(e)||v.push(e),u.find(".badge").text(v.length)},e.prototype.onFileDownloaded=function(e){++b,g.find(".badge").text(b);e="string"==typeof e?e:e.getFileCode();v.remove(e),0<v.length?u.find(".badge").text(v.length):u.find(".badge").text("")},t.FileCatalogue=e}(window),function(r){"use strict";var t,a=null,i=null,n=null;function c(e,t){var a=e.getId(),i=e.getName(),n=e.getLastModified();return["<tr ondblclick=\"app.filePanel.changeDirectory('",a,'\')" id="ftr_',a,'">',"<td onclick=\"app.filePanel.toggleSelect('",a,"')\">",'<div class="icheck-primary">','<input type="checkbox" data-type="folder" id="',a,'">','<label for="',a,'"></label></div></td>','<td class="file-icon"><i class="ci ci-file-directory"></i></td>','<td class="file-name"><a href="javascript:app.filePanel.changeDirectory(\'',a,"');\">",i=t?i+" （于 "+r.formatYMDHMS(e.getTrashTimestamp())+"）":i,"</a></td>",'<td class="file-size">--</td>','<td class="file-lastmodifed">',r.formatYMDHMS(n),"</td>",'<td class="file-operate"></td>',"</tr>"]}function d(e){e=e.getFileType();return"png"==e||"jpeg"==e||"gif"==e||"jpg"==e||"bmp"==e?'<i class="ci ci-file-image"></i>':"xls"==e||"xlsx"==e?'<i class="ci ci-file-excel"></i>':"ppt"==e||"pptx"==e?'<i class="ci ci-file-powerpoint"></i>':"doc"==e||"docx"==e?'<i class="ci ci-file-word"></i>':"mp3"==e||"ogg"==e||"wav"==e?'<i class="ci ci-file-music"></i>':"pdf"==e?'<i class="ci ci-file-pdf"></i>':"rar"==e?'<i class="ci ci-file-rar"></i>':"zip"==e||"gz"==e?'<i class="ci ci-file-zip"></i>':"txt"==e||"log"==e?'<i class="ci ci-file-text"></i>':"mp4"==e||"mkv"==e||"avi"==e||"ts"==e?'<i class="ci ci-file-video"></i>':"psd"==e?'<i class="ci ci-file-psd"></i>':"exe"==e||"dll"==e?'<i class="ci ci-file-windows"></i>':"apk"==e?'<i class="ci ci-file-apk"></i>':"dmg"==e?'<i class="ci ci-file-dmg"></i>':"ipa"==e?'<i class="ci ci-file-ipa"></i>':'<i class="fa fa-file-alt ci-fa-file"></i>'}function e(e){a=e,i=$("#table_files_nofile"),t=e.find('tbody[data-target="surface-a"]'),e.find('tbody[data-target="surface-b"]'),n=t}e.prototype.updatePage=function(e,l){if(0==e.length)return n[0].innerHTML="",void i.css("display","block");var s=[];e.forEach(function(e){var t,a,i,n,o=null,o=e instanceof FileLabel||e instanceof TrashFile?(i=l,n=(a=e).getFileName(),i&&(n=n+" （于 "+r.formatYMDHMS(a.getTrashTimestamp())+"）"),i=a.getId(),["<tr ondblclick=\"app.filePanel.openFileDetails('",a.getFileCode(),'\')" id="ftr_',i,'">',"<td onclick=\"app.filePanel.toggleSelect('",i,"')\">",'<div class="icheck-primary">','<input type="checkbox" data-type="file" id="',i,'">','<label for="',i,'"></label></div></td>','<td class="file-icon">',d(a),"</td>",'<td class="file-name" title="',n,'"><a href="javascript:app.filePanel.openFile(\'',a.getFileCode(),"');\">",n,"</a></td>",'<td class="file-size">',r.formatSize(a.getFileSize()),"</td>",'<td class="file-lastmodifed">',r.formatYMDHMS(a.getLastModified()),"</td>",'<td class="file-operate">',"<button ","onclick=\"app.filePanel.downloadFile('",a.getFileCode(),"')\"",' type="button" class="btn btn-primary btn-sm" title="下载"><i class="fas fa-download"></i></button>',"<button ","onclick=\"app.filePanel.openCreateSharingTagDialog('",a.getFileCode(),"')\"",' type="button" class="btn btn-info btn-sm" title="分享" data-target="share-file"><i class="fas fa-share-alt"></i></button>',"<button ","onclick=\"app.filePanel.promptDeleteFile('",a.getFileName(),"', '",a.getFileCode(),"')\"",' type="button" class="btn btn-danger btn-sm" title="删除" data-target="recycle-file"><i class="far fa-trash-alt"></i></button>',"</td>","</tr>"]):e instanceof SearchItem?(i=(t=e).file,n=t.directory,"root"==(a=n.getName())&&(a="/"),['<tr id="ftr_',t=i.getId(),'">',"<td onclick=\"app.filePanel.toggleSelect('",t,'\')"><div class="icheck-primary">','<input type="checkbox" data-type="file" id="',t,'">','<label for="',t,'"></label></div></td>','<td class="file-icon">',d(i),"</td>",'<td class="file-name"><a href="javascript:app.filePanel.openFile(\'',i.getFileCode(),"','",n.getId(),"');\">",i.getFileName(),"</a>",'<span class="desc">所在目录: ',a,"</span>","</td>",'<td class="file-size">',r.formatSize(i.getFileSize()),"</td>",'<td class="file-lastmodifed">',r.formatYMDHMS(i.getLastModified()),"</td>",'<td class="file-operate">',"<button ","onclick=\"app.filePanel.downloadFile('",i.getFileCode(),"')\"",' type="button" class="btn btn-primary btn-sm" title="下载"><i class="fas fa-download"></i></button>',"<button ","onclick=\"app.filePanel.openCreateSharingTagDialog('",i.getFileCode(),"')\"",' type="button" class="btn btn-info btn-sm" title="分享" data-target="share-file"><i class="fas fa-share-alt"></i></button>',"<button ","onclick=\"app.filePanel.promptDeleteFile('",i.getFileName(),"', '",i.getFileCode(),"')\"",' type="button" class="btn btn-danger btn-sm" title="删除" data-target="recycle-file"><i class="far fa-trash-alt"></i></button>',"</td>","</tr>"]):c(e,l);s=s.concat(o)}),0<s.length&&i.css("display","none"),n[0].innerHTML=s.join("")},e.prototype.toggleSelect=function(e){r.app.filePanel.resetSelectAllButton();var t=a.find("#"+e);t.prop("checked")?(t.prop("checked",!1),a.find("#ftr_"+e).removeClass("table-primary")):(t.prop("checked",!0),a.find("#ftr_"+e).addClass("table-primary"))},e.prototype.unselect=function(e){var t=a.find("#"+e);t.prop("checked")&&(t.prop("checked",!1),a.find("#ftr_"+e).removeClass("table-primary"))},e.prototype.insertFolder=function(e){e=c(e);n.prepend($(e.join("")))},r.FileTable=e}(window),function(r){"use strict";var a,o,l,s,c,d=null,p=null,t=null,i=null,n=null,u=null,g=null,f=null,m=null,h=null,v=null,b=0,C=0,y=null,w=null,T=null,x=null,I=null,k={page:0,loaded:0},P=null,S=null,M=!1,E=!1,N=null;function A(e,t){e?(N.isDocumentType()?(o.prop("disabled",!1),o.prop("checked",!1),l.prop("disabled",!0),l.prop("checked",!1),s.prop("disabled",!1)):N.isImageType()?(o.prop("disabled",!1),o.prop("checked",!0),l.prop("disabled",!1),l.prop("checked",!0),s.prop("disabled",!1)):(o.prop("disabled",!0),o.prop("checked",!1),l.prop("disabled",!0),l.prop("checked",!1),s.prop("disabled",!0)),s.prop("checked",!0),c.prop("disabled",!1),c.prop("checked",!0)):t?((N.isDocumentType()||N.isImageType())&&(o.prop("checked")?(l.prop("checked",N.isImageType()),l.prop("disabled",!1)):(l.prop("checked",!1),l.prop("disabled",!0))),o.prop("checked")||s.prop("checked")||s.prop("checked",!0)):(s.prop("checked")?c.prop("disabled",!1):c.prop("disabled",!0),c.prop("checked",!0),o.prop("checked")||s.prop("checked")||o.prop("checked",!0))}function e(e){p=e,T=new FileTable(e.find(".file-table")),t=e.find(".checkbox-toggle"),i=e.find('button[data-target="upload"]'),u=e.find('button[data-target="empty-trash"]'),g=e.find('button[data-target="restore"]'),n=e.find('button[data-target="new-dir"]'),m=e.find('button[data-target="refresh"]'),f=e.find('button[data-target="parent"]'),h=e.find('button[data-target="recycle"]'),v=e.find('button[data-target="share"]'),b=e.find(".info-loaded"),C=e.find(".info-total"),(y=e.find('button[data-target="prev"]')).attr("disabled","disabled"),(w=e.find('button[data-target="next"]')).attr("disabled","disabled"),(d=this).initUI()}e.prototype.initUI=function(){a=$("#create_file_sharing_dialog"),(o=a.find("#preview-switch")).change(function(){A(!1,!0)}),l=a.find("#watermark-switch"),(s=a.find("#download-switch")).change(function(){A(!1,!1)}),c=a.find("#download-trace-switch"),t.click(function(){$(this).prop("checked")?$('.file-table input[type="checkbox"]').prop("checked",!0):$('.file-table input[type="checkbox"]').prop("checked",!1)}),i.click(function(){null!=I?window.cube().launchFileSelector(function(e){e=e.target.files;209715200<e[0].size?r.dialog.showAlert("为了文档分享体验更加便捷，我们不建议分享超过 200MB 大小的文件。"):(r.app.fileCatalog.onFileUpload(e[0]),I.uploadFile(e[0],function(e){r.app.fileCatalog.onFileUploading(e)},function(e,t){r.app.fileCatalog.onFileUploaded(t),d.refreshTable(!0)},function(e){r.dialog.toast("上传文件失败："+e.code)}))}):r.dialog.toast("文件服务模块未就绪")}),n.click(function(){r.dialog.showPrompt("新建文件夹","请输入新建文件夹的名称",function(e,t){if(e){t=t.trim();return 0==t.length?(alert("文件夹名称不能为空。"),!1):(d.newDirectory(t),!0)}})}),u.click(function(){r.dialog.showConfirm("清空回收站",'您确认清空回收站吗？<p class="text-danger tip">清空回收站将删除回收站内的所有文件，不可恢复！</p>',function(e){e&&window.cube().fs.emptyTrash(function(e){d.showRecyclebin()},function(e){r.dialog.launchToast(Toast.Error,"清空回收站失败: "+e.code)})},"清空回收站")}),g.click(function(){for(var e=[],t=p.find('.file-table input[type="checkbox"]'),a=0;a<t.length;++a){var i=$(t.get(a));i.prop("checked")&&e.push(parseInt(i.attr("id")))}0!=e.length&&window.cube().fs.restoreTrash(e,function(e,t){d.showRecyclebin(),app.fileCtrl.resetPageData(e)},function(e){r.dialog.launchToast(Toast.Error,"清空回收站失败: "+e.code)})}),f.click(function(){var e;I!=x&&(e=I.getParent(),d.changeDirectory(e))}),m.click(function(){r.dialog.showLoading("正在刷新数据……"),d.refreshTable(!1,function(){r.dialog.hideLoading()}),t.prop("checked",!1)}),h.click(function(){for(var t,e,a,i,o=[],n=p.find('.file-table input[type="checkbox"]'),l=0;l<n.length;++l){var s=$(n.get(l));s.prop("checked")&&o.push({id:parseInt(s.attr("id")),type:s.attr("data-type")})}0!=o.length&&(i=null,E?(t=[],o.forEach(function(e){t.push(e.id)}),i=['您确定要删除所选择的“<span class="text-danger">',t.length,"</span>”个项目吗？",'<p class="text-danger tip">将立即删除此项目。您不能撤销此操作。</p>'],r.dialog.showConfirm("立即删除",i.join(""),function(e){e&&window.cube().fs.eraseTrash(t,function(e){d.showRecyclebin()},function(e){r.dialog.launchToast(Toast.Error,"删除文件失败: "+e.code)})},"立即删除")):(i=1==o.length?(a="",a=null==(e=I.getDirectory(o[0].id))?(e=I.getFile(o[0].id)).getFileName():e.getName(),["您确定要删除","folder"==o[0].type?"文件夹":"文件",' “<span class="text-danger">',a,"</span>” 吗？"]):["您确定要删除所选择的<b>",o.length,"</b>个项目吗？"],r.dialog.showConfirm("删除文件",i.join(""),function(e){var t,a,i,n;e&&(t=[],a=[],o.forEach(function(e){("folder"==e.type?t:a).push(e.id)}),i=0==t.length,n=0==a.length,I.deleteDirectory(t,!0,function(e,t){i=!0,n&&d.refreshTable(!0)},function(e){r.dialog.launchToast(Toast.Error,"删除文件夹失败: "+e.code)}),I.deleteFiles(a,function(e,t){n=!0,i&&d.refreshTable(!0)},function(e){r.dialog.launchToast(Toast.Error,"删除文件失败: "+e.code)}))},"删除")))}),v.click(function(){for(var e,t=[],a=p.find('.file-table input[type="checkbox"]'),i=0;i<a.length;++i){var n=$(a.get(i));n.prop("checked")&&t.push({id:parseInt(n.attr("id")),type:n.attr("data-type")})}0==t.length||1<t.length?r.dialog.toast("请选择一个您需要分享的文件。"):1!=t.length||null!=(e=I.getFile(t[0].id))&&d.openCreateSharingTagDialog(e)}),y.click(function(){E||(M?0!=P.begin&&(P.end=P.begin,P.begin=P.begin-r.app.fileCtrl.numPerPage,0==P.begin&&y.attr("disabled","disabled"),window.cube().fs.searchFile(P,function(e,t){t.length<r.app.fileCtrl.numPerPage&&(w.attr("disabled","disabled"),0==t.length)||(T.updatePage(t),b.text(t.length),w.removeAttr("disabled"))},function(e){r.dialog.launchToast(Toast.Error,"过滤文件错误: "+e.code)})):0!=k.page&&(--k.page,0==k.page&&y.attr("disabled","disabled"),d.refreshTable(),w.removeAttr("disabled")))}),w.click(function(){E||(M?(P.begin=P.end,P.end=P.end+r.app.fileCtrl.numPerPage,window.cube().fs.searchFile(P,function(e,t){return t.length<r.app.fileCtrl.numPerPage&&(w.attr("disabled","disabled"),0==t.length)?(P.end=P.end-r.app.fileCtrl.numPerPage,void(P.begin=P.end-r.app.fileCtrl.numPerPage)):(y.removeAttr("disabled"),T.updatePage(t),void b.text(t.length))},function(e){r.dialog.launchToast(Toast.Error,"过滤文件错误: "+e.code)})):r.app.fileCtrl.getPageData(I,k.page+1,function(e){null==e?(w.attr("disabled","disabled"),0!=k.page&&y.removeAttr("disabled"),r.dialog.launchToast(Toast.Info,"没有更多数据")):(k.page+=1,d.refreshTable())}))})},e.prototype.hide=function(){p.css("display","none"),S=null},e.prototype.setTitle=function(e){p.find(".fp-title").text(e)},e.prototype.updateTitlePath=function(){if(null!=I){var e=[];this.recurseParent(e,I);for(var t=['<ol class="breadcrumb float-sm-right">','<li class="breadcrumb-item',0==e.length?" active":"",'">',0==e.length?"我的文件":"<a href=\"javascript:app.filePanel.changeDirectory('"+x.getId()+"');\">我的文件</a>","</li>"],a=0;a<e.length;++a){var i=e[a];t.push('<li class="breadcrumb-item'),a+1==e.length?(t.push(" active"),t.push('">'),t.push(i.getName()),t.push("</li>")):(t.push('"><a href="javascript:;">'),t.push(i.getName()),t.push("</a></li>"))}t.push("</ol>"),p.find(".fp-path").html(t.join(""))}},e.prototype.recurseParent=function(e,t){var a=t.getParent();null!=a&&(e.push(t),this.recurseParent(e,a))},e.prototype.refreshTable=function(e,t){e&&r.app.fileCtrl.resetPageData(I),r.app.fileCtrl.getPageData(I,k.page,function(e){return null==e?(w.attr("disabled","disabled"),T.updatePage([]),b.text(0),C.text(0)):(T.updatePage(e),k.loaded=e.length,b.text(k.page*r.app.fileCtrl.numPerPage+e.length),C.text(I.totalDirs()+I.totalFiles()),k.loaded<r.app.fileCtrl.numPerPage?w.attr("disabled","disabled"):w.removeAttr("disabled")),void(t&&t.call(null))}),0==k.page?y.attr("disabled","disabled"):y.removeAttr("disabled"),k.loaded<r.app.fileCtrl.numPerPage?w.attr("disabled","disabled"):w.removeAttr("disabled")},e.prototype.showRoot=function(){t.prop("checked",!1),p.css("display","block"),E=M=!1,(S=null)!=I?(i.css("display","inline-block"),n.css("display","inline-block"),f.css("display","block"),u.css("display","none"),g.css("display","none"),this.refreshTable(),this.updateTitlePath()):r.app.fileCtrl.getRoot(function(e){I=x=e,d.showRoot()})},e.prototype.showImages=function(){t.prop("checked",!1),p.css("display","block"),E=!(M=!0),u.css("display","none"),g.css("display","none"),p.find(".fp-path").html(""),i.css("display","none"),n.css("display","none"),f.css("display","none"),y.attr("disabled","disabled"),w.attr("disabled","disabled"),P={begin:0,end:r.app.fileCtrl.numPerPage,type:["jpg","png","gif","bmp"]},window.cube().fs.searchFile(P,function(e,t){S=[],t.forEach(function(e){S.push(e.file)}),T.updatePage(t),b.text(t.length),t.length==r.app.fileCtrl.numPerPage&&w.removeAttr("disabled")},function(e){r.dialog.launchToast(Toast.Error,"过滤图片文件: "+e.code)}),C.text("--")},e.prototype.showDocuments=function(){t.prop("checked",!1),p.css("display","block"),E=!(M=!0),S=null,u.css("display","none"),g.css("display","none"),p.find(".fp-path").html(""),i.css("display","none"),n.css("display","none"),f.css("display","none"),y.attr("disabled","disabled"),w.attr("disabled","disabled"),P={begin:0,end:r.app.fileCtrl.numPerPage,type:["pdf","doc","docx","xls","xlsx","ppt","pptx","docm","dotm","dotx","ett","xlsm","xlt","dpt","ppsm","ppsx","pot","potm","potx","pps","ptm"]},window.cube().fs.searchFile(P,function(e,t){T.updatePage(t),b.text(t.length),t.length==r.app.fileCtrl.numPerPage&&w.removeAttr("disabled")},function(e){r.dialog.launchToast(Toast.Error,"过滤文档文件: "+e.code)}),C.text("--")},e.prototype.showRecyclebin=function(){t.prop("checked",!1),p.css("display","block"),E=!(M=!1),S=null,u.css("display","inline-block"),g.css("display","inline-block"),p.find(".fp-path").html(""),i.css("display","none"),n.css("display","none"),f.css("display","none"),y.attr("disabled","disabled"),w.attr("disabled","disabled"),window.cube().fs.listTrash(0,20,function(e,t,a,i){T.updatePage(t,!0),b.text(t.length),C.text("--")},function(e){r.dialog.launchToast(Toast.Error,"读取回收站数据错误: "+e.code),T.updatePage([]),b.text(0),C.text("--")})},e.prototype.toggleSelect=function(e){T.toggleSelect(e)},e.prototype.changeDirectory=function(e){if(!E&&!M){var t=typeof e;if("number"==t||"string"==t){var a=parseInt(e);if(I.getId()==a)return;I=a==x.getId()?x:t=null==(t=I.getDirectory(a))?r.cube().fs.querySelfDirectory(a):t,T.unselect(a)}else{if(e==I)return;I=e}this.refreshTable(),this.updateTitlePath()}},e.prototype.openFile=function(e,t){var a=null,i=null;if(E||(M?null!=(n=window.cube().fs.querySearch(t,e))&&(i=n.directory,a=n.file):a=(i=I).getFile(e)),null!=a){var n=a.getFileType();if("png"==n||"jpeg"==n||"gif"==n||"jpg"==n||"bmp"==n)if(T.unselect(e),null==S)r.dialog.showImage(a);else{for(var o=0,l=0;l<S.length;++l)if(S[l].getFileCode()==a.getFileCode()){o=l;break}r.dialog.showImages(S,o)}else T.unselect(e),r.app.fileDetails.open(a,i)}},e.prototype.openFileDetails=function(e){var t;E||M||null!=(t=I.getFile(e))&&(T.unselect(e),r.app.fileDetails.open(t,I))},e.prototype.newDirectory=function(e){r.dialog.launchToast(Toast.Info,"新建文件夹“"+e+"”"),I.newDirectory(e,function(e){T.insertFolder(e),r.app.fileCtrl.resetPageData(I)},function(e){r.dialog.launchToast(Toast.Error,"新建文件夹失败: "+e.code)})},e.prototype.resetSelectAllButton=function(){},e.prototype.openCreateSharingTagDialog=function(e){function t(i){n.find("#file-name").val(i.getFileName()),n.find("#file-size").val(r.formatSize(i.getFileSize())),N=i,A(!0),n.find('button[data-target="confirm"]').click(function(){n.find(".overlay").css("visibility","visible");var e=n.find("#file-sharing-duration").val(),e="24h"==(a=e)?864e5:"48h"==a?1728e5:"72h"==a?2592e5:"7d"==a?6048e5:"30d"==a?2592e6:0,t=n.find("#sharing-password").val().trim();0==t.length&&(t=null);var a=null;l.prop("checked")&&(a=r.app.account.name,r.app.account.phone&&(a=a+"_"+r.app.account.phone.substr(r.app.account.phone.length-4,4))),r.engine.fs.createSharingTag(i,{duration:e,password:t,preview:o.prop("checked"),watermark:a,download:s.prop("checked"),traceDownload:c.prop("checked")},e=>{n.modal("hide");var t=e.getURL(),e=e.id,e=["<p>已创建 “",i.getFileName(),"” 的分享链接：</p>",'<div class="input-group input-group-sm">','<input id="url_',e,'" type="text" class="form-control" value="',t,'" />','<span class="input-group-append">','<button type="button" class="btn btn-default btn-flat alert-clippy-button" title="复制分享链接到剪贴板" data-clipboard-target="#url_',e,'"><i class="fas fa-clipboard"></i></button>',"</span>","</div>"],a=null;r.dialog.showAlert(e.join(""),function(){null!=a&&a.destroy()},"关闭"),setTimeout(function(){(a=new ClipboardJS(".alert-clippy-button")).on("success",function(){r.dialog.toast("链接地址已复制到剪贴板",Toast.Success)})},500)},e=>{n.modal("hide")})}),n.find(".overlay").css("visibility","hidden"),n.modal("show")}var n=a;"string"==typeof e?r.cube().fs.getFileLabel(e,function(e){t(e)},function(e){r.dialog.toast("未找到文件："+e.code)}):t(e)},e.prototype.promptDeleteFile=function(e,t){r.dialog.showConfirm("删除文件",["您确定要删除文件 ",'“<span class="text-danger">',e,"</span>” 吗？"].join(""),function(e){e&&I.deleteFiles([t],function(e,t){d.refreshTable(!0)},function(e){r.dialog.launchToast(Toast.Error,"删除文件失败: "+e.code)})},"删除")},e.prototype.downloadFile=function(t){r.app.fileCatalog.onFileDownload(t),cube().fs.downloadFileWithHyperlink(t,function(e){r.app.fileCatalog.onFileDownloaded(e)},function(e){r.app.fileCatalog.onFileDownloaded(t)})},r.FilePanel=e}(window),function(s){"use strict";var t,a=null,i=null,n=null,r=[];function e(e){i=$("#table_sharing_nodata"),t=e.find('tbody[data-target="surface-a"]'),e.find('tbody[data-target="surface-b"]'),n=t,a=this}e.prototype.updatePage=function(e,o){if(r.forEach(function(e){e.destroy()}),r.splice(0,r.length),0==e.length)return n[0].innerHTML="",void i.css("display","block");var l=[];e.forEach(function(e){var t,a,i,n;l=l.concat((a=o,i=(t=e).id,n=t.fileLabel,e=null!=t.password?t.password:"<i>无</i>",i=["<tr ondblclick=\"app.fileSharingPanel.showTraceDialog('",t.code,"')\">","<td>",'<div class="icheck-primary">','<input type="checkbox" data-type="sharing" id="',i,'">','<label for="',i,'"></label>',"</div>","</td>",'<td class="file-icon">',s.helper.matchFileIcon(n),"</td>",'<td class="file-name ellipsis" title="',n.getFileName(),'">',n.getFileName(),"</td>",'<td class="file-size">',s.formatSize(n.getFileSize()),"</td>",'<td class="sharing-url">','<div class="input-group input-group-sm">','<input id="url_',i,'" type="text" class="form-control" value="',t.getURL(),'" readonly />','<span class="input-group-append">','<button id="clippy_',i,'" type="button" class="btn btn-default btn-flat" title="复制分享链接到剪贴板" data-clipboard-target="#url_',i,'"><i class="fas fa-clipboard"></i></button>','<button id="qrcode_',i,'" type="button" class="btn btn-default btn-flat" data-toggle="tooltip" data-placement="top" data-html="true" title="',"<img class='file-sharing-qrcode-img' src='",t.getQRCodeURL(),"'/>",'"><i class="fas fa-qrcode"></i></button>',"</span>","</div>","</td>",'<td class="sharing-expire" title="',0<t.expiryDate?s.formatYMDHM(t.expiryDate):"永久有效",'">',0<t.expiryDate?s.formatYMD(t.expiryDate):"<i>永久有效</i>","</td>",'<td class="sharing-password">',e,"</td>",'<td class="sharing-preview">','<div class="custom-control custom-checkbox">','<input class="custom-control-input" type="checkbox" ',t.preview?"checked":"",' id="preview_',i,'" disabled />','<label class="custom-control-label" for="preview_',i,'"></label>',"</div>","</td>",'<td class="sharing-download">','<div class="custom-control custom-checkbox">','<input class="custom-control-input" type="checkbox" ',t.download?"checked":"",' id="download_',i,'" disabled />','<label class="custom-control-label" for="download_',i,'"></label>',"</div>","</td>",'<td class="sharing-operate">','<button type="button" title="查看分享记录" class="btn btn-info btn-sm" onclick="app.fileSharingPanel.showTraceDialog(\'',t.code,"');\">",'<i class="fas fa-share-square"></i>',"</button>"],a&&(i.push('<button type="button" title="取消分享" class="btn btn-danger btn-sm" onclick="app.fileSharingPanel.promptCancelSharing(\''),i.push(t.code),i.push("');\">"),i.push('<i class="fas fa-times-circle"></i>'),i.push("</button>")),i.push("</td></tr>"),i))}),0<l.length&&i.css("display","none"),n[0].innerHTML=l.join(""),setTimeout(function(){e.forEach(function(e){var t=new ClipboardJS("#clippy_"+e.id);t.on("success",a.fireClipboard),r.push(t),$("#qrcode_"+e.id).tooltip()})},1e3)},e.prototype.fireClipboard=function(){s.dialog.toast("链接地址已复制到剪贴板",Toast.Success)},s.FileSharingTable=e}(window),function(l){"use strict";var s=null;function e(e){a=e,r=new FileSharingTable(e.find(".sharing-table")),(s=this).initUI()}var a=null,r=null,i=0,n=0,o=null,c=null,d=!0,p={page:0,loaded:0,total:0},u={page:0,loaded:0,total:0};e.prototype.initUI=function(){a.removeClass("files-hidden"),a.css("display","none"),i=a.find(".page-num"),n=a.find(".page-total"),(o=a.find('button[data-target="prev"]')).attr("disabled","disabled"),(c=a.find('button[data-target="next"]')).attr("disabled","disabled"),o.click(function(){s.prevPage()}),c.click(function(){s.nextPage()})},e.prototype.showSharingPanel=function(){l.dialog.showLoading("正在加载分享标签数据"),d=!0,a.css("display","block");var e=15*p.page,t=15+e-1;l.cube().fs.listSharingTags(e,t,!0,function(e,t,a,i,n){l.dialog.hideLoading(),r.updatePage(e,n),p.loaded=e.length,p.total=t,s.updatePagination()},function(e){l.dialog.hideLoading(),l.dialog.launchToast(Toast.Error,"获取分享列表失败："+e.code)})},e.prototype.showExpiresPanel=function(){l.dialog.showLoading("正在加载分享标签数据"),d=!1,a.css("display","block");var e=15*u.page,t=15+e-1;l.cube().fs.listSharingTags(e,t,!1,function(e,t,a,i,n){l.dialog.hideLoading(),r.updatePage(e,n),u.loaded=e.length,u.total=t,s.updatePagination()},function(e){l.dialog.hideLoading(),l.dialog.launchToast(Toast.Error,"获取分享列表失败："+e.code)})},e.prototype.hide=function(){a.css("display","none")},e.prototype.showTraceDialog=function(e){app.visitTraceDialog.open(e)},e.prototype.promptCancelSharing=function(t){l.cube().fs.getSharingTag(t,function(e){e=["您确定要取消该分享码？<p>取消的分享不可恢复。</p>",'<p style="margin-left:1rem;">','<span class="text-muted ellipsis">文件名：',e.fileLabel.fileName,"</span><br/>",'<span class="text-muted">有效期：',0<e.expiryDate?l.formatYMDHM(e.expiryDate):"永久有效","</span><br/>",'<span class="text-muted">访问码：',null==e.password?"<i>无</i>":e.password,"</span>","</p>"];l.dialog.showConfirm("取消分享",e.join(""),function(e){e&&(l.dialog.showLoading("正在取消标签"),l.cube().fs.cancelSharingTag(t,function(e){l.dialog.hideLoading(),setTimeout(function(){d?s.showSharingPanel():s.showExpiresPanel()},100)},function(e){alert("访问出错: "+e.code)}))})},function(e){alert("访问出错: "+e.code)})},e.prototype.updatePagination=function(){var e=null,e=d?p:u,t=Math.ceil(e.total/15),e=e.page+1;i.text(e),n.text(t),1==e||1==t?o.attr("disabled","disabled"):o.removeAttr("disabled"),e==t||1==t?c.attr("disabled","disabled"):c.removeAttr("disabled")},e.prototype.prevPage=function(){var e,t,o=null,o=d?p:u;Math.ceil(o.total/15);1!=o.page+1&&(--o.page,t=15+(e=15*o.page)-1,l.cube().fs.listSharingTags(e,t,!0,function(e,t,a,i,n){r.updatePage(e),o.loaded=e.length,o.total=t,s.updatePagination()},function(e){l.dialog.launchToast(Toast.Error,"获取分享列表失败："+e.code)}))},e.prototype.nextPage=function(){var e,o=null,o=d?p:u,t=Math.ceil(o.total/15);o.page+1!=t&&(o.page+=1,t=15+(e=15*o.page)-1,l.cube().fs.listSharingTags(e,t,!0,function(e,t,a,i,n){r.updatePage(e),o.loaded=e.length,o.total=t,s.updatePagination()},function(e){l.dialog.launchToast(Toast.Error,"获取分享列表失败："+e.code)}))},l.FileSharingPanel=e}(window),function(e){"use strict";function t(){this.pages=new OrderMap,this.list=[],this.fileIndex=0}var a=null,i=null,r=new OrderMap;t.prototype.get=function(e){return this.pages.get(e)},t.prototype.append=function(e,t){if(this.contains(t))return!1;var a=this.pages.get(e);return null==a&&this.pages.put(e,a=[]),a.push(t),this.list.push(t),!0},t.prototype.size=function(e){e=this.pages.get(e);return null==e?0:e.length},t.prototype.contains=function(e){for(var t=0;t<this.list.length;++t)if(this.list[t].getId()==e.getId())return!0;return!1};function n(e){a=e,this.numPerPage=20}n.prototype.getRoot=function(t){null==i?a.fs.getSelfRoot(function(e){t(i=e)},function(e){console.log(e)}):t(i)},n.prototype.resetPageData=function(e){r.remove(e.getId())},n.prototype.sizePage=function(e,t){e=r.get(e.getId());if(null==e)return 0;t=e.get(t);return null==t?0:t.length},n.prototype.getPageData=function(i,n,o){var l=r.get(i.getId());null==l&&(l=new t,r.put(i.getId(),l));var s=l.get(n);null==s?i.listDirectories(function(e,t){if(l.list.length<t.length){for(var a=0;a<t.length&&(l.append(n,t[a]),20!=l.size(n));++a);if(null!=(s=l.get(n))&&20==s.length)return void o(s)}i.listFiles(l.fileIndex,l.fileIndex+20,function(e,t){for(var a=0;a<t.length&&(!l.append(n,t[a])||(l.fileIndex+=1,20!=l.size(n)));++a);o(l.get(n))})}):o(s)},e.FileController=n}(window),function(e){function t(e){i=(a=e).find(".table"),l=i.find("tbody"),s=e.find(".pagination")}var a=null,i=null,l=null,s=null,n=[],o=null,r=1,c=0;t.prototype.getCurrentContact=function(e){return o[e]},t.prototype.update=function(e){if(0==e.length)return l.empty(),s.css("visibility","hidden"),void a.find(".no-record").css("display","table");a.find(".no-record").css("display","none"),s.css("visibility","visible"),(n=e).sort(function(e,t){return e.getName().localeCompare(t.getName())}),o=[];for(var t=0;t<10&&t<n.length;++t)o.push(n[t]);c=Math.ceil(n.length/10),this.paging(c),r=0,this.show(1,o)},t.prototype.showPage=function(e){if(r!=e&&!(e<1||c<e)){o=[];for(var t=10*(e-1);t<n.length&&o.length<10;++t)o.push(n[t]);this.show(e,o)}},t.prototype.paging=function(e){for(var t=['<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.prevPage();">«</a></li>'],a=1;a<=e;++a)t.push('<li class="page-item page-'+a+'"><a class="page-link" href="javascript:app.contactsCtrl.showPage('+a+');">'+a+"</a></li>");t.push('<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.nextPage();">»</a></li>'),s.html(t.join(""))},t.prototype.show=function(e,t){if(e!=r){0<r&&s.find(".page-"+r).removeClass("active"),s.find(".page-"+e).addClass("active"),r=e,l.empty();for(var a=0;a<t.length;++a){var i=t[a],n=i.getContext(),o=i.getAppendix(),n=['<tr data-target="',a,'">',"<td>",10*(e-1)+(a+1),"</td>",'<td><img class="table-avatar" src="images/',n.avatar,'" /></td>',"<td>",i.getName(),"</td>",'<td class="text-muted">',o.hasRemarkName()?o.getRemarkName():"","</td>","<td>",i.getId(),"</td>","<td>",n.region,"</td>","<td>",n.department,"</td>",'<td class="text-right">','<a class="btn btn-primary btn-sm" href="javascript:app.contactsCtrl.goToMessaging(',a,');"><i class="fas fa-comments"></i> 发消息</a>','<a class="btn btn-info btn-sm" href="javascript:app.contactsCtrl.editRemark(',a,');" style="margin-left:8px;"><i class="fas fa-pencil-alt"></i> 备注</a>','<a class="btn btn-danger btn-sm" href="javascript:app.contactsCtrl.remove(',a,');" style="margin-left:8px;"><i class="fas fa-user-minus"></i> 删除</a>','<a class="btn btn-secondary btn-sm" href="javascript:app.contactsCtrl.blockContact(',a,');" style="margin-left:8px;"><i class="fas fa-user-slash"></i> 黑名单</a>',"</td>","</tr>"];l.append($(n.join("")))}}},t.prototype.prevPage=function(){1!=r&&this.showPage(r-1)},t.prototype.nextPage=function(){r!=c&&this.showPage(r+1)},t.prototype.modifyRemark=function(e,t){this.modifyCell(e,3,t)},t.prototype.modifyCell=function(e,t,a){l.find('tr[data-target="'+e+'"]').find("td").eq(t).text(a)},e.ContactsTable=t}(window),function(e){function t(e){i=(a=e).find(".table"),o=i.find("tbody"),l=e.find(".pagination")}var a=null,i=null,o=null,l=null,n=[],s=null,r=1,c=0;t.prototype.getCurrentContact=function(e){return s[e]},t.prototype.update=function(e){if(0==e.length)return o.empty(),l.css("visibility","hidden"),void a.find(".no-record").css("display","table");a.find(".no-record").css("display","none"),l.css("visibility","visible"),(n=e).sort(function(e,t){return e.getName().localeCompare(t.getName())}),s=[];for(var t=0;t<10&&t<n.length;++t)s.push(n[t]);c=Math.ceil(n.length/10),this.paging(c),r=0,this.show(1,s)},t.prototype.showPage=function(e){if(r!=e&&!(e<1||c<e)){s=[];for(var t=10*(e-1);t<n.length&&s.length<10;++t)s.push(n[t]);this.show(e,s)}},t.prototype.paging=function(e){for(var t=['<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.prevPage();">«</a></li>'],a=1;a<=e;++a)t.push('<li class="page-item page-'+a+'"><a class="page-link" href="javascript:app.contactsCtrl.showPage('+a+');">'+a+"</a></li>");t.push('<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.nextPage();">»</a></li>'),l.html(t.join(""))},t.prototype.show=function(e,t){if(e!=r){0<r&&l.find(".page-"+r).removeClass("active"),l.find(".page-"+e).addClass("active"),r=e,o.empty();for(var a=0;a<t.length;++a){var i=t[a],n=i.getAppendix();i.tableSN=a,i.listMembers(function(e,t){var a=4,i=8,n=['<ul class="list-inline">'];e.some(function(e){var t=e.getContext(),t=(t=null==t?(e=app.queryContact(e.getId())).getContext():t).avatar;if(n.push('<li class="list-inline-item">'),n.push('<img title="'+e.getPriorityName()+'" class="table-avatar" src="images/'+t+'" />'),n.push("</li>"),--a,0==--i)return!0;0==a&&(n.push('</ul><ul class="list-inline">'),a=4)}),n.push("</ul>"),o.find('tr[data-target="'+t.tableSN+'"]').find(".members").html(n.join(""))});n=['<tr data-target="',a,'">',"<td>",10*(e-1)+(a+1),"</td>",'<td><img class="table-avatar" src="',"images/group-avatar.png",'" /></td>','<td><a href="javascript:app.contactsCtrl.showGroup(',a,');">',i.getName(),"</a></td>",'<td class="text-muted">',n.hasRemark()?n.getRemark():"","</td>","<td>",i.getId(),"</td>","<td>",n.getNotice(),"</td>",'<td class="members">',"</td>",'<td class="text-right">','<a class="btn btn-primary btn-sm" href="javascript:app.contactsCtrl.goToMessaging(',a,');"><i class="fas fa-comments"></i> 发消息</a>','<a class="btn btn-info btn-sm" href="javascript:app.contactsCtrl.editRemark(',a,');" style="margin-left:8px;"><i class="fas fa-pencil-alt"></i> 备注</a>',"</td>","</tr>"];o.append($(n.join("")))}}},t.prototype.prevPage=function(){1!=r&&this.showPage(r-1)},t.prototype.nextPage=function(){r!=c&&this.showPage(r+1)},t.prototype.modifyRemark=function(e,t){this.modifyCell(e,3,t)},t.prototype.modifyCell=function(e,t,a){o.find('tr[data-target="'+e+'"]').find("td").eq(t).text(a)},e.GroupsTable=t}(window),function(n){function e(e){t=(a=e).find(".table"),o=t.find("tbody"),l=e.find(".pagination")}var a=null,t=null,o=null,l=null,i=[],s=null,r=1,c=0;e.prototype.getCurrentContact=function(e){return s[e]},e.prototype.update=function(e){if(0==e.length)return o.empty(),l.css("visibility","hidden"),void a.find(".no-record").css("display","table");a.find(".no-record").css("display","none"),l.css("visibility","visible"),(i=e).sort(function(e,t){return e.getName().localeCompare(t.getName())}),s=[];for(var t=0;t<10&&t<i.length;++t)s.push(i[t]);c=Math.ceil(i.length/10),this.paging(c),r=0,this.show(1,s)},e.prototype.showPage=function(e){if(r!=e&&!(e<1||c<e)){s=[];for(var t=10*(e-1);t<i.length&&s.length<10;++t)s.push(i[t]);this.show(e,s)}},e.prototype.paging=function(e){for(var t=['<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.prevPage();">«</a></li>'],a=1;a<=e;++a)t.push('<li class="page-item page-'+a+'"><a class="page-link" href="javascript:app.contactsCtrl.showPage('+a+');">'+a+"</a></li>");t.push('<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.nextPage();">»</a></li>'),l.html(t.join(""))},e.prototype.show=function(e,t){if(e!=r){0<r&&l.find(".page-"+r).removeClass("active"),l.find(".page-"+e).addClass("active"),r=e,o.empty();for(var a=0;a<t.length;++a){var i=t[a],i=['<tr data-target="',a,'">',"<td>",10*(e-1)+(a+1),"</td>",'<td><img class="table-avatar" src="',i instanceof Group?"images/group-avatar.png":n.helper.getAvatarImage(i.getContext().avatar),'" /></td>',"<td>",i.getName(),"</td>",'<td class="text-muted">',i.getId(),"</td>","<td>",i.postscript,"</td>",'<td class="text-right">','<a class="btn btn-primary btn-sm" href="javascript:app.contactsCtrl.acceptPendingContact(',a,');"><i class="fas fa-user-check"></i> 添加联系人</a>',"</td>","</tr>"];o.append($(i.join("")))}}},e.prototype.prevPage=function(){1!=r&&this.showPage(r-1)},e.prototype.nextPage=function(){r!=c&&this.showPage(r+1)},e.prototype.modifyRemark=function(e,t){this.modifyCell(e,3,t)},e.prototype.modifyCell=function(e,t,a){o.find('tr[data-target="'+e+'"]').find("td").eq(t).text(a)},n.PendingTable=e}(window),function(l){function e(e){s=this,t=(o=e).find(".table"),r=t.find("tbody"),c=e.find(".pagination")}var s,o,t=null,r=null,c=null,d=null,p=1,u=0,g=null,f=null;e.prototype.getCurrentContact=function(e){return d[e]},e.prototype.update=function(e){if(0==e.length)return r.empty(),c.css("visibility","hidden"),void o.find(".no-record").css("display","table");o.find(".no-record").css("display","none"),c.css("visibility","visible"),(g=e).reverse(),f=[];for(var t=0;t<g.length;++t)f.push(null);for(var a=0,i=Math.min(g.length,10),t=0;t<g.length&&t<10;++t){var n=g[t];l.app.getContact(n,function(e){++a;var t=g.indexOf(e.getId());f[t]=e,a==i&&s.handleUpdate()})}},e.prototype.handleUpdate=function(){d=[];for(var e=0;e<10&&e<f.length;++e)d.push(f[e]);u=Math.ceil(g.length/10),this.paging(u),p=0,this.show(1,d)},e.prototype.showPage=function(e){if(p!=e&&!(e<1||u<e)){for(var t=[],a=10*(e-1);a<g.length&&t.length<10;++a)t.push(a);function i(){t.length==d.length&&s.show(e,d)}d=[];for(a=0;a<t.length;++a){var n=t[a],o=f[n];null==o?(n=g[n],l.app.getContact(n,function(e){d.push(e),i()})):d.push(o),i()}}},e.prototype.paging=function(e){for(var t=['<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.prevPage();">«</a></li>'],a=1;a<=e;++a)t.push('<li class="page-item page-'+a+'"><a class="page-link" href="javascript:app.contactsCtrl.showPage('+a+');">'+a+"</a></li>");t.push('<li class="page-item"><a class="page-link" href="javascript:app.contactsCtrl.nextPage();">»</a></li>'),c.html(t.join(""))},e.prototype.show=function(e,t){if(e!=p){0<p&&c.find(".page-"+p).removeClass("active"),c.find(".page-"+e).addClass("active"),p=e,r.empty();for(var a=0;a<t.length;++a){var i=t[a],i=['<tr data-target="',a,'">',"<td>",10*(e-1)+(a+1),"</td>",'<td><img class="table-avatar" src="',l.helper.getAvatarImage(i.getContext().avatar),'" /></td>',"<td>",i.getName(),"</td>","<td>",i.getId(),"</td>",'<td class="text-right">','<a class="btn btn-danger btn-sm" href="javascript:app.contactsCtrl.unblockContact(',a,');"><i class="fas fa-user-times"></i> 解除阻止</a>',"</td>","</tr>"];r.append($(i.join("")))}}},e.prototype.prevPage=function(){1!=p&&this.showPage(p-1)},e.prototype.nextPage=function(){p!=u&&this.showPage(p+1)},l.BlockListTable=e}(window),function(o){"use strict";var n=null,l=null,i=[],s=[],t=[],r=null,c=null,a=null,d=null,p=null,u=0,g=0,f=0;function m(e){p="contacts-tabs-default-tab"==e.target.id?r:"contacts-tabs-groups-tab"==e.target.id?c:"contacts-tabs-pending-tab"==e.target.id?a:d}function e(e){n=this,l=e,$("#contacts-tabs-tab").on("show.bs.tab",m),r=new ContactsTable($('div[data-target="contacts-table"]')),c=new GroupsTable($('div[data-target="groups-table"]')),a=new PendingTable($('div[data-target="pending-table"]')),d=new BlockListTable($('div[data-target="block-table"]')),$(".contacts-card").find('a[data-target="add-contact"]').on("click",function(){o.app.searchDialog.show()}),$(".contacts-card").find('a[data-target="new-group"]').on("click",function(){o.app.newGroupDialog.show()}),$(".contacts-card").find('button[data-target="refresh"]').on("click",function(){n.update()}),p=r}e.prototype.ready=function(e){t=[],l.contact.queryBlockList(function(e){d.update(e)})},e.prototype.getContacts=function(){return i},e.prototype.addContact=function(e){i.push(e),0<u&&clearTimeout(u),u=setTimeout(function(){clearTimeout(u),u=0,r.update(i)},1e3)},e.prototype.removeContact=function(e){for(var t=!1,a=0;a<i.length;++a)if(i[a].getId()==e.getId()){i.splice(a,1),t=!0;break}t&&r.update(i)},e.prototype.updateGroup=function(e){var t=function(e){for(var t=0;t<s.length;++t)if(s[t].getId()==e.getId())return t;return-1}(e);0<=t&&s.splice(t,1),s.push(e),0<g&&clearTimeout(g),g=setTimeout(function(){clearTimeout(g),g=0,c.update(s)},1e3)},e.prototype.removeGroup=function(e){for(var t=!1,a=0;a<s.length;++a)if(s[a].getId()==e.getId()){s.splice(a,1),t=!0;break}t&&c.update(s)},e.prototype.addPending=function(e){t.push(e),0<f&&clearTimeout(f),f=setTimeout(function(){clearTimeout(f),f=0,a.update(t)},1e3)},e.prototype.showGroup=function(e){e=p.getCurrentContact(e);void 0!==e&&o.app.groupDetails.show(e)},e.prototype.goToMessaging=function(e){var t=p.getCurrentContact(e);void 0!==t&&(app.messageCatalog.appendItem(t,!0),app.toggle("messaging"),setTimeout(function(){t instanceof Group?app.messagingCtrl.updateGroupMessages(t,function(){app.messagingCtrl.toggle(t.getId())}):app.messagingCtrl.updateContactMessages(t,function(){app.messagingCtrl.toggle(t.getId())})},100))},e.prototype.editRemark=function(i){var n;p!=r||void 0!==(n=r.getCurrentContact(i))&&o.dialog.showPrompt("备注联系人","请填写联系人“"+n.getName()+"”的备注：",function(e,t){if(e){var a=t.trim();if(0==a.length)return o.dialog.launchToast(o.Toast.Warning,"请正确填写联系人备注"),!1;n.getAppendix().updateRemarkName(a,function(){r.modifyRemark(i,a)})}})},e.prototype.remove=function(e){var a=r.getCurrentContact(e);o.dialog.showConfirm("删除联系人","您确认要从“我的联系人”里删除“<b>"+a.getPriorityName()+"</b>”？",function(e){e&&l.contact.removeContactFromZone(o.app.contactZone,a.getId(),function(e,t){n.removeContact(a),o.app.messagingCtrl.removeContact(a)})})},e.prototype.blockContact=function(e){var a=r.getCurrentContact(e);o.dialog.showConfirm("阻止联系人","您确认要将“<b>"+a.getPriorityName()+"</b>”加入“黑名单”吗？",function(e){e&&l.contact.addBlockList(a.getId(),function(e,t){n.removeContact(a),d.update(t)})})},e.prototype.acceptPendingContact=function(e){var t=p.getCurrentContact(e);o.dialog.showConfirm("添加联系人","您确认要添加联系人“<b>"+t.getName()+"</b>”吗？",function(e){e&&l.contact.addContactToZone(o.app.contactZone,t.getId(),null,function(){i.push(t),n.ready(function(){n.update()})})})},e.prototype.addContactToZone=function(e,t,a,i){l.contact.addContactToZone(e,t,a,function(e,t){o.app.getContact(t,function(e){n.addContact(e),i&&i(e)})},function(e){console.log(e),i&&i(null)})},e.prototype.unblockContact=function(e){var t=d.getCurrentContact(e);o.dialog.showConfirm("解除阻止","您确认要将“<b>"+t.getPriorityName()+"</b>”移出“黑名单”并添加为“我的联系人”吗？",function(e){e&&l.contact.removeBlockList(t,function(e,t){d.update(t),n.addContactToZone(o.app.contactZone,e,"")})})},e.prototype.showPage=function(e){p.showPage(e)},e.prototype.prevPage=function(){p.prevPage()},e.prototype.nextPage=function(){p.nextPage()},e.prototype.update=function(){r.update(i),c.update(s),a.update(t)},e.prototype.removeGroupMember=function(e,a,n){l.contact.getGroup(e,function(t){o.app.getContact(a,function(e){var i=e.getName();o.dialog.showConfirm("移除群成员","您确定要把“"+i+"”移除群组吗？",function(e){e&&t.removeMembers([a],function(e,t,a){o.dialog.launchToast(Toast.Success,"已移除成员“"+i+"”"),n&&n(e,t,a),o.app.groupDetails.refresh()},function(e){o.dialog.launchToast(Toast.Warning,"移除群成员失败: "+e.code)})})})})},o.ContactsController=e}(window),function(p){"use strict";function e(e){this.container=e,this.timelineEl=e.find(".timeline")}e.prototype.update=function(e){if(this.timelineEl.empty(),0<e.length){this.container.find(".no-conference").css("display","none");for(var t=Date.now(),a=0;a<e.length;++a){var i=e[a],n=new Date(i.scheduleTime),o=new Date(i.expireTime),l=null,s=[];t>=i.scheduleTime&&t<=i.expireTime?(l="bg-red",s.push('<button class="btn btn-success btn-sm" onclick="javascript:;">进入会议</button>'),i.getFounder().getId()==app.getSelf().getId()&&s.push('<button class="btn btn-danger btn-sm">结束会议</button>')):t>i.expireTime?(l="bg-green",s.push('<button class="btn btn-default btn-sm" onclick="javascript:;">查看会议记录</button>')):(l="bg-blue",s.push('<button class="btn btn-success btn-sm" onclick="javascript:;">进入会议</button>'),i.getFounder().getId()==app.getSelf().getId()&&s.push('<button class="btn btn-danger btn-sm" onclick="javascript:;">取消会议</button>'));var r=i.hasPassword()?'<i class="fas fa-lock" title="会议已设置密码"></i>':'<i class="fas fa-unlock" title="会议无密码"></i>',c=i.getInvitees();c.unshift(i.getFounder());var d=[];c.forEach(function(e,t){var a=app.queryContact(e.id),i=null,i=0==t?['<span class="badge badge-info"><i class="fas fa-user-cog"></i></span>']:0<e.acceptionTime?e.accepted?['<span class="badge badge-success"><i class="fas fa-check-circle"></i></span>']:['<span class="badge badge-danger"><i class="fas fa-ban"></i></span>']:['<span class="badge badge-info"><i class="fas fa-question-circle"></i></span>'],t=null,t=null!=a?['<div class="participant" data="',a.getId(),'">','<div class="avatar"><img src="',p.helper.getAvatarImage(a.getContext().avatar),'"></div>','<div class="name"><div>',a.getName(),"</div></div>",i.join(""),"</div>"]:['<div class="participant" data="',e.id,'">','<div class="avatar"><img src="',"images/favicon.png",'"></div>','<div class="name"><div>',e.displayName,"</div></div>",i.join(""),"</div>"];d.push(t.join(""))});s=['<div class="time-label">','<span class="bg-blue">',n.getMonth()+1,"月",n.getDate(),"日</span>","</div>","<div>",'<i class="fas fa-users ',l,'"></i>','<div class="timeline-item">','<span class="time">',r,'&nbsp;&nbsp;<i class="fas fa-clock"></i> ',p.formatNumber(n.getHours()),":",p.formatNumber(n.getMinutes())," - ",p.formatNumber(o.getHours()),":",p.formatNumber(o.getMinutes()),"</span>",'<h3 class="timeline-header">',i.subject,"</h3>",'<div class="timeline-body">',"<p>",0==i.summary.length?'<i class="text-muted" style="font-size:12px;">无会议描述信息</i>':i.summary,"</p>",'<div class="invitees">',d.join(""),"</div>","</div>",'<div class="timeline-footer">',s.join(""),"</div>","</div>","</div>"];this.timelineEl.append($(s.join("")))}this.timelineEl.append($('<div><i class="fas fa-clock bg-gray"></i></div>'))}else this.container.find(".no-conference").css("display","table")},p.ConferenceTimeline=e}(window),function(s){"use strict";var r=null,c=null,d=null,p=null,u=null,g=null;function e(e){var t=g;t.find('input[name="conf-subject"]').val(""),t.find('input[name="conf-pwd"]').val(""),t.find('textarea[name="conf-summary"]').val("");var a=new Date,i=(i=a.getMinutes())<=15?15:15<i&&i<=30?30:30<i&&i<=45?45:0;a.setMinutes(i),0==i&&a.setHours(a.getHours()+1);var i=a.getMinutes()+30;60<=i?(a.setHours(a.getHours()+1),a.setMinutes(0)):a.setMinutes(i),t.find('input[name="conf-schedule"]').val(s.datetimePickerToString(a)),t.find("div.participant").each(function(){$(this).remove()}),t.find(".overlay").css("visibility","hidden"),t.modal("show")}function t(e){s.app.selectContactsDialog.show(function(e){var a=g.find("#conf-participant");e.forEach(function(e,t){e=['<div class="participant" data="',e.getId(),'">','<div class="avatar">','<img src="',s.helper.getAvatarImage(e.getContext().avatar),'" />',"</div>",'<div class="name">',"<div>",e.getPriorityName(),"</div>","</div>",'<a href="javascript:app.confCtrl.removeParticipantInNewDialog(',e.getId(),');"><span class="badge badge-danger">&times;</span></a>',"</div>"];a.append($(e.join("")))})},f())}function f(){var t=[];return g.find("div.participant").each(function(){var e=$(this).attr("data");t.push(parseInt(e))}),t}function a(){var e,t,a,i,n,o=g.find('input[name="conf-subject"]'),l=o.val().trim();l.length<3?s.validate(o,"请填写会议主题，会议主题不能少于3个字符。"):(e=(o=g.find('input[name="conf-pwd"]')).val().trim(),t=(o=g.find('textarea[name="conf-summary"]')).val().trim(),(i=(o=g.find('input[name="conf-schedule"]')).val().trim()).length<=10?s.validate(o):(a=s.datetimePickerToDate(i).getTime(),o=(o=g.find('select[name="conf-duration"]')).find(":selected"),i=a+60*parseInt(o.attr("data"))*60*1e3,o=f(),n=[],o.forEach(function(e){e=app.queryContact(e);n.push(new Invitation(e.getId(),e.getName(),e.getPriorityName()))}),g.find(".overlay").css("visibility","visible"),r.cs.createConference(l,e,t,a,i,n,function(e){g.modal("hide"),s.dialog.showAlert("会议“<b>"+e.subject+"</b>”已创建，计划开始时间是<b>"+s.formatFullTime(e.scheduleTime)+"</b>。"),setTimeout(function(){app.confCtrl.ready()},1e3)},function(e){g.modal("hide"),s.dialog.showAlert("创建会议失败，请稍后再试！错误码："+e.code)})))}function i(e){r=e,this.init()}i.prototype.init=function(){c=new ConferenceTimeline($("#conf-timeline-all")),d=new ConferenceTimeline($("#conf-timeline-active")),p=new ConferenceTimeline($("#conf-timeline-scheme")),u=new ConferenceTimeline($("#conf-timeline-closed")),$('button[data-toggle="new-conference"]').on("click",e),(g=$("#new_conference_dialog")).find("#datetimepicker-schedule").datetimepicker({locale:"zh-cn",stepping:5}),g.find("#conf-participant button").on("click",t),g.find('button[data-target="confirm"]').on("click",a)},i.prototype.ready=function(){var l=Date.now();r.cs.listConferences(l-2592e6,l,function(e,t,a){c.update(e);var i=[],n=[],o=[];e.forEach(function(e){l<e.scheduleTime?n.push(e):l>=e.scheduleTime&&l<=e.expireTime?i.push(e):l>e.expireTime&&o.push(e)}),d.update(i),p.update(n),u.update(o)},function(e){console.log(e)})},i.prototype.removeParticipantInNewDialog=function(e){g.find("#conf-participant").find('div[data="'+e+'"]').remove()},i.prototype.fireNewConference=function(){e()},s.ConferenceController=i}(window),function(c){var a=null,d=null,p=null,u=!1;function t(){var a;p&&(a=[],u&&d.find(".selected-table").find('input[type="checkbox"]').each(function(e,t){a.push(app.queryContact(parseInt(t.getAttribute("data"))))}),p(a)),d.find(".selected-table").empty()}function g(){var e=$(this),t=app.queryContact(parseInt(e.attr("data")));e[0].checked?a.append(t):a.remove(t)}function i(){var e=$(this),t=app.queryContact(parseInt(e.attr("data")));e[0].checked||a.remove(t)}function n(){u=!0,d.modal("hide")}function e(e){a=this,(d=$("#select_contacts_dialog")).on("hidden.bs.modal",t),d.find('button[data-target="confirm"]').on("click",n)}e.prototype.show=function(e,t){p=e,u=!1;var a=d.find("#select-contact-tabs-default div");a.empty();for(var i=app.getMyContacts(),n=0;n<i.length;++n){var o=i[n],l=o.getId(),s=c.helper.getAvatarImage(o.getContext().avatar),r=o.getPriorityName(),o=0<=t.indexOf(l);a.append($(['<div class="form-group"><div class="custom-control custom-checkbox select-group-member">','<input class="custom-control-input" type="checkbox" id="contact_',n,'" data="',l,'" ',o?'disabled="disabled"':""," />",'<label class="custom-control-label" for="contact_',n,'">','<img src="',s,'" />',"<span>",r,"</span>","</label>","</div></div>"].join("")))}d.modal("show"),a.find('input[type="checkbox"]').change(g)},e.prototype.append=function(e){var t=e.getId(),e=['<tr id="selected_tr_',t,'">','<td class="text-center pl-3" width="40">','<div class="custom-control custom-checkbox">','<input class="custom-control-input" type="checkbox" id="selected_',t,'" data="',t,'" checked="">','<label for="selected_',t,'" class="custom-control-label">&nbsp;</label>',"</div>","</td>",'<td width="50">','<img src="',c.helper.getAvatarImage(e.getContext().avatar),'" class="avatar" />',"</td>","<td>",e.getPriorityName(),"</td>","</tr>"],e=$(e.join(""));d.find(".selected-table").append(e),e.find('input[type="checkbox"]').change(i)},e.prototype.remove=function(e){d.find(".selected-table").find("#selected_tr_"+e.getId()).remove()},c.SelectContactsDialog=e}(window),function(o){"use strict";function e(){var e=this;this.el=$("#search_dialog"),this.overlay=this.el.find(".item-overlay"),this.input=this.el.find('input[data-target="search-input"]'),this.input.on("input",function(){e.onInputChanged()}),this.resultEl=this.el.find('div[data-target="search-result"]'),this.submitTimer=0}e.prototype.show=function(){this.overlay.css("display","none"),this.input.val(""),this.resultEl.empty(),this.el.modal("show")},e.prototype.onInputChanged=function(){var e=this,t=e.input.val().trim();if(0==t.length)return 0<e.submitTimer&&(clearTimeout(e.submitTimer),e.submitTimer=0),e.overlay.css("display","none"),void e.resultEl.empty();0<e.submitTimer&&clearTimeout(e.submitTimer),e.submitTimer=setTimeout(function(){clearTimeout(e.submitTimer),e.submitTimer=0,e.overlay.css("display","flex"),e.resultEl.empty(),0==(t=e.input.val().trim()).length?e.overlay.css("display","none"):e.search(t),console.log('Search keyword: "'+t+'"')},1e3)},e.prototype.search=function(e){var t=this;o.cube().contact.search(e,function(e){0==e.contactList.length&&0==e.groupList.length?t.resultEl.html('<div class="no-result">没有找到匹配的结果</div>'):(e.contactList.forEach(function(e){t.appendContact(e)}),t.resultEl.append($("<hr/>")),e.groupList.forEach(function(e){t.appendGroup(e)})),t.overlay.css("display","none")},function(){t.overlay.css("display","none"),t.resultEl.html('<div class="no-result">发生错误，请稍候再试</div>')})},e.prototype.appendContact=function(e){var t=o.helper.getAvatarImage(e.getContext().avatar),t=['<div class="row align-items-center" data="',e.getId(),'">','<div class="col-2"><img src="',t,'" class="avatar"></div>','<div class="col-7">','<span><a href="javascript:app.contactDetails.show(',e.getId(),');">',e.getName(),"</a></span>",'&nbsp;<span class="text-muted">(',e.getId(),")</span>","</div>",'<div class="col-3" data-target="action">',"</div>","</div>"],n=$(t.join(""));this.resultEl.append(n),o.cube().contact.containsContactInZone(o.app.contactZone,e,function(e,t,a){var i=null,i=e?'<span class="text-muted">已添加</span>':'<button class="btn btn-sm btn-default" onclick="app.searchDialog.fireAddContactToZone(\''+t+"', "+a+')">添加联系人</button>';n.find('div[data-target="action"]').html(i)})},e.prototype.appendGroup=function(e){var t=['<div class="row align-items-center" data="',e.getId(),'">','<div class="col-2"><img src="images/',"group-avatar.png",'" class="avatar"></div>','<div class="col-7">','<span><a href="javascript:;">',e.getName(),"</a></span>",'&nbsp;<span class="text-muted">(',e.getId(),")</span>","</div>",'<div class="col-3" data-target="action">',"</div>","</div>"],t=$(t.join(""));this.resultEl.append(t),o.cube().contact.getGroup(e.getId(),function(e){})},e.prototype.fireAddContactToZone=function(a,i){var n=this;o.dialog.showPrompt("添加联系人","附言",function(e,t){e&&o.app.contactsCtrl.addContactToZone(a,i,t,function(e){null!=e&&n.resultEl.find('div[data="'+i+'"]').find('div[data-target="action"]').html('<span class="text-muted">已添加</span>')})},"我是“"+o.app.account.name+"”。")},o.SearchDialog=e}(window),function(i){var t=null,n=null,a=null;function o(e){a.appendLog(e.name,e.data.getName())}function l(e){a.appendLog(e.name,e.data.field.getName())}function s(e){a.appendLog(e.name,e.data.field.getName())}function r(e){a.appendLog(e.name,e.data.field.getName())}function c(e){a.appendLog(e.name,e.data.field.getName())}function d(e){a.appendLog(e.name,e.data.field.getName())}function p(e){a.appendLog(e.name,e.data.getName())}function u(e){a.appendLog(e.name,e.data.getName())}function g(e){a.appendLog(e.name,e.data.getName())}function f(e){a.appendLog(e.name,e.data.getName())}function m(e){a.appendLog(e.name,e.data.getName())}function e(){a=this,n=$("aside.control-sidebar").find("#app-details-log")}e.prototype.start=function(e){(t=e).on("network",function(e){"failed"==e.name?i.dialog.launchToast(Toast.Error,"网络错误："+e.error.code,!0):"connected"==e.name&&(i.dialog.launchToast(Toast.Info,"已连接到服务器",!0),a.appendLog("Network","Ready"))}),t.contact.on(ContactEvent.SignIn,function(e){a.appendLog(e.name,e.data.id)}),t.contact.on(ContactEvent.SignOut,function(e){a.appendLog(e.name,e.data.id)}),t.contact.on(ContactEvent.Comeback,function(e){a.appendLog(e.name,e.data.id)}),t.contact.on(ContactEvent.GroupUpdated,function(e){a.appendLog(e.name,e.data.name),a.onGroupUpdated(e.data)}),t.contact.on(ContactEvent.GroupCreated,function(e){a.appendLog(e.name,e.data.name),a.onGroupCreated(e.data)}),t.contact.on(ContactEvent.GroupDissolved,function(e){a.appendLog(e.name,e.data.name),a.onGroupDissolved(e.data)}),t.contact.on(ContactEvent.GroupMemberAdded,function(e){a.appendLog(e.name,e.data.group.getName()),a.onGroupMemberAdded(e.data.group)}),t.contact.on(ContactEvent.GroupMemberRemoved,function(e){a.appendLog(e.name,e.data.group.getName()),a.onGroupMemberRemoved(e.data.group)}),t.messaging.on(MessagingEvent.Notify,function(e){var t=[e.data.getType()," - ",e.data.getSender().getName()," -> ",(e.data.isFromGroup()?e.data.getSourceGroup():e.data.getReceiver()).getName()];a.appendLog(e.name,t.join(""))}),t.messaging.on(MessagingEvent.Sent,function(e){var t=[e.data.getType()," - ",e.data.getSender().getName()," -> ",(e.data.isFromGroup()?e.data.getSourceGroup():e.data.getReceiver()).getName()];a.appendLog(e.name,t.join(""))}),t.messaging.on(MessagingEvent.Recall,function(e){console.log(e.data)}),t.messaging.on(MessagingEvent.SendBlocked,function(e){var t=[e.data.getType()," - ",e.data.getSender().getName()," -> ",(e.data.isFromGroup()?e.data.getSourceGroup():e.data.getReceiver()).getName()];a.appendLog(e.name,t.join(""))}),t.messaging.on(MessagingEvent.ReceiveBlocked,function(e){var t=[e.data.getType()," - ",e.data.getSender().getName()," -> ",(e.data.isFromGroup()?e.data.getSourceGroup():e.data.getReceiver()).getName()];a.appendLog(e.name,t.join(""))}),t.mpComm.on(CommEvent.InProgress,o),t.mpComm.on(CommEvent.Ringing,l),t.mpComm.on(CommEvent.Connected,s),t.mpComm.on(CommEvent.Bye,r),t.mpComm.on(CommEvent.Timeout,c),t.mpComm.on(CommEvent.NewCall,d),t.mpComm.on(CommEvent.Invited,p),t.mpComm.on(CommEvent.Arrived,u),t.mpComm.on(CommEvent.Left,g),t.mpComm.on(CommEvent.Followed,f),t.mpComm.on(CommEvent.Unfollowed,m)},e.prototype.appendLog=function(e,t){var a=new Date,t=['<div class="row align-items-center">','<div class="col-3">',i.formatNumber(a.getHours()),":",i.formatNumber(a.getMinutes()),":",i.formatNumber(a.getSeconds()),"</div>",'<div class="col-4"><b>',e,"</b></div>",'<div class="col-5">',t,"</div>","</div>"];n.append($(t.join("")))},e.prototype.onGroupUpdated=function(e){i.app.messagingCtrl.updateGroup(e),i.app.contactsCtrl.updateGroup(e)},e.prototype.onGroupCreated=function(e){i.app.contactsCtrl.updateGroup(e),i.dialog.launchToast(Toast.Info,e.isOwner()?"群组“"+e.getName()+"”已创建。":"“"+e.getOwner().getName()+"”邀请你加入群组“"+e.getName()+"” 。",!0)},e.prototype.onGroupDissolved=function(e){i.app.contactsCtrl.removeGroup(e),i.app.messagePanel.updatePanel(e.getId(),e),i.dialog.launchToast(Toast.Info,"群组 “"+e.getName()+"” 已解散。",!0)},e.prototype.onGroupMemberAdded=function(e){i.app.messagePanel.updatePanel(e.getId(),e)},e.prototype.onGroupMemberRemoved=function(e){i.app.messagePanel.updatePanel(e.getId(),e)},i.AppEventCenter=e}(window);
//# sourceMappingURL=components-min.js.map